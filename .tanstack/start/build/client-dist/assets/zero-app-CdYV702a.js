const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/inspector-LF6RTN44-DguwnzB1.js","assets/main-Dn08EaJy.js","assets/cn-BW4RVDli.js"])))=>i.map(i=>d[i]);
var gb=Object.defineProperty;var Cf=e=>{throw TypeError(e)};var bb=(e,t,n)=>t in e?gb(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var v=(e,t,n)=>bb(e,typeof t!="symbol"?t+"":t,n),Pl=(e,t,n)=>t.has(e)||Cf("Cannot "+n);var r=(e,t,n)=>(Pl(e,t,"read from private field"),n?n.call(e):t.get(e)),l=(e,t,n)=>t.has(e)?Cf("Cannot add the same private member more than once"):t instanceof WeakSet?t.add(e):t.set(e,n),d=(e,t,n,s)=>(Pl(e,t,"write to private field"),s?s.call(e,n):t.set(e,n),n),p=(e,t,n)=>(Pl(e,t,"access private method"),n);var Et=(e,t,n,s)=>({set _(i){d(e,t,i,n)},get _(){return r(e,t,s)}});import{s as ry,j as mo,d as Td,m as oy,g as Sb,a5 as kb,o as Ib,T as Cb,a6 as Db,a7 as _b,a as Eb,b as xb,a8 as Nb}from"./main-Dn08EaJy.js";import{m as Mb,h as Rb,P as Tb,_ as Ob,D as Pb,l as Ab}from"./cn-BW4RVDli.js";var Lb={};Ob(Lb,{Button:()=>zb,Root:()=>Od});var Hb=["button","color","file","image","reset","submit"];function Fb(e){const t=e.tagName.toLowerCase();return t==="button"?!0:t==="input"&&e.type?Hb.indexOf(e.type)!==-1:!1}function Od(e){let t;const n=Mb({type:"button"},e),[s,i]=ry(n,["ref","type","disabled"]),o=Rb(()=>t,()=>"button"),a=mo(()=>{const h=o();return h==null?!1:Fb({tagName:h,type:s.type})}),u=mo(()=>o()==="input"),c=mo(()=>o()==="a"&&(t==null?void 0:t.getAttribute("href"))!=null);return Td(Tb,oy({as:"button",ref(h){var m=Sb(y=>t=y,s.ref);typeof m=="function"&&m(h)},get type(){return a()||u()?s.type:void 0},get role(){return!a()&&!c()?"button":void 0},get tabIndex(){return!a()&&!c()&&!s.disabled?0:void 0},get disabled(){return a()||u()?s.disabled:void 0},get"aria-disabled"(){return!a()&&!u()&&s.disabled?!0:void 0},get"data-disabled"(){return s.disabled?"":void 0}},i))}var zb=Od,ay=Object.defineProperty,$b=Object.getOwnPropertyDescriptor,Vb=Object.getOwnPropertyNames,jb=Object.prototype.hasOwnProperty,Pd=(e,t)=>{for(var n in t)ay(e,n,{get:t[n],enumerable:!0})},Gb=(e,t,n,s)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of Vb(t))!jb.call(e,i)&&i!==n&&ay(e,i,{get:()=>t[i],enumerable:!(s=$b(t,i))||s.enumerable});return e},Bb=(e,t,n)=>(Gb(e,t,"default"),n);function Gs(e,t){return e?{ok:!1,code:"join",left:e,right:t}:t}function Us(e,t){return{ok:!1,code:"prepend",key:e,tree:t}}function Ub(e,t){const n=e.code;switch(n){case"invalid_type":return{code:n,path:t,expected:e.expected};case"invalid_literal":return{code:n,path:t,expected:e.expected};case"missing_value":return{code:n,path:t};case"invalid_length":return{code:n,path:t,minLength:e.minLength,maxLength:e.maxLength};case"unrecognized_keys":return{code:n,path:t,keys:e.keys};case"invalid_union":return{code:n,path:t,tree:e.tree};default:return{code:n,path:t,error:e.error}}}function Ad(e,t=[],n=[]){for(;;)if(e.code==="join")Ad(e.left,t.slice(),n),e=e.right;else if(e.code==="prepend")t.push(e.key),e=e.tree;else return e.code==="custom_error"&&typeof e.error=="object"&&e.error.path!==void 0&&t.push(...e.error.path),n.push(Ub(e,t)),n}function Al(e,t){return e.length===0?"nothing":e.length===1?e[0]:`${e.slice(0,-1).join(", ")} ${t} ${e[e.length-1]}`}function Df(e){return typeof e=="bigint"?`${e}n`:JSON.stringify(e)}function uy(e){let t=0;for(;;)if(e.code==="join")t+=uy(e.left),e=e.right;else if(e.code==="prepend")e=e.tree;else return t+1}function cy(e){let t="",n=0;for(;;)if(e.code==="join")n+=uy(e.right),e=e.left;else if(e.code==="prepend")t+="."+e.key,e=e.tree;else break;let s="validation failed";if(e.code==="invalid_type")s=`expected ${Al(e.expected,"or")}`;else if(e.code==="invalid_literal")s=`expected ${Al(e.expected.map(Df),"or")}`;else if(e.code==="missing_value")s="missing value";else if(e.code==="unrecognized_keys"){const o=e.keys;s=`unrecognized ${o.length===1?"key":"keys"} ${Al(o.map(Df),"and")}`}else if(e.code==="invalid_length"){const o=e.minLength,a=e.maxLength;s="expected an array with ",o>0?a===o?s+=`${o}`:a!==void 0?s+=`between ${o} and ${a}`:s+=`at least ${o}`:s+=`at most ${a}`,s+=" item(s)"}else if(e.code==="custom_error"){const o=e.error;typeof o=="string"?s=o:o!==void 0&&(o.message!==void 0&&(s=o.message),o.path!==void 0&&(t+="."+o.path.join(".")))}let i=`${e.code} at .${t.slice(1)} (${s})`;return n===1?i+=" (+ 1 other issue)":n>1&&(i+=` (+ ${n} other issues)`),i}class gl extends Error{constructor(t){super(cy(t)),this.issueTree=t,Object.setPrototypeOf(this,new.target.prototype),this.name=new.target.name,this._issues=void 0}get issues(){return this._issues===void 0&&(this._issues=Ad(this.issueTree)),this._issues}}class ly{constructor(t){this.issueTree=t,this.ok=!1,this._issues=void 0,this._message=void 0}get issues(){return this._issues===void 0&&(this._issues=Ad(this.issueTree)),this._issues}get message(){return this._message===void 0&&(this._message=cy(this.issueTree)),this._message}throw(){throw new gl(this.issueTree)}}function Uu(e){return{ok:!0,value:e}}function Kb(e){return new ly({ok:!1,code:"custom_error",error:e})}function hy(e){return typeof e=="object"&&e!==null&&!Array.isArray(e)}const go=1,bo=2,Ks=4;let dy=class{optional(t){const n=new Qb(this);return t?new Jt(n,s=>s===void 0?{ok:!0,value:t()}:void 0):n}default(t){const n=Uu(t);return new Jt(this.optional(),s=>s===void 0?n:void 0)}assert(t,n){const s={ok:!1,code:"custom_error",error:n};return new Jt(this,(i,o)=>t(i,o)?void 0:s)}map(t){return new Jt(this,(n,s)=>({ok:!0,value:t(n,s)}))}chain(t){return new Jt(this,(n,s)=>{const i=t(n,s);return i.ok?i:i.issueTree})}};class _e extends dy{nullable(){return new qb(this)}toTerminals(t){t(this)}try(t,n){let s=go;(n==null?void 0:n.mode)==="passthrough"?s=0:(n==null?void 0:n.mode)==="strip"&&(s=bo);const i=this.func(t,s);return i===void 0?{ok:!0,value:t}:i.ok?{ok:!0,value:i.value}:new ly(i)}parse(t,n){let s=go;(n==null?void 0:n.mode)==="passthrough"?s=0:(n==null?void 0:n.mode)==="strip"&&(s=bo);const i=this.func(t,s);if(i===void 0)return t;if(i.ok)return i.value;throw new gl(i)}}class qb extends _e{constructor(t){super(),this.type=t,this.name="nullable"}func(t,n){return t===null?void 0:this.type.func(t,n)}toTerminals(t){t(wy),this.type.toTerminals(t)}nullable(){return this}}class Qb extends dy{constructor(t){super(),this.type=t,this.name="optional"}func(t,n){return t===void 0||n&Ks?void 0:this.type.func(t,n)}toTerminals(t){t(this),t(yy),this.type.toTerminals(t)}optional(t){return t?new Jt(this,n=>n===void 0?{ok:!0,value:t()}:void 0):this}}function fy(e,t){if(typeof e!="number"){const n=t>>5;for(let s=e.length;s<=n;s++)e.push(0);return e[n]|=1<<t%32,e}else return t<32?e|1<<t:fy([e,0],t)}function Yr(e,t){return typeof e=="number"?t<32?e>>>t&1:0:e[t>>5]>>>t%32&1}class Nt extends _e{constructor(t,n,s){super(),this.shape=t,this.restType=n,this.checks=s,this.name="object",this._invalidType={ok:!1,code:"invalid_type",expected:["object"]}}check(t,n){var s;const i={ok:!1,code:"custom_error",error:n};return new Nt(this.shape,this.restType,[...(s=this.checks)!==null&&s!==void 0?s:[],{func:t,issue:i}])}func(t,n){if(!hy(t))return this._invalidType;let s=this._func;return s===void 0&&(s=Jb(this.shape,this.restType,this.checks),this._func=s),s(t,n)}rest(t){return new Nt(this.shape,t)}extend(t){return new Nt(Object.assign(Object.assign({},this.shape),t),this.restType)}pick(...t){const n={};return t.forEach(s=>{n[s]=this.shape[s]}),new Nt(n,void 0)}omit(...t){const n=Object.assign({},this.shape);return t.forEach(s=>{delete n[s]}),new Nt(n,this.restType)}partial(){var t;const n={};Object.keys(this.shape).forEach(i=>{n[i]=this.shape[i].optional()});const s=(t=this.restType)===null||t===void 0?void 0:t.optional();return new Nt(n,s)}}function Jb(e,t,n){const s=[],i=[];for(const w in e){let g=!1;e[w].toTerminals(S=>{g||(g=S.name==="optional")}),g?i.push(w):s.push(w)}const o=[...s,...i],a=o.length;if(a===0&&(t==null?void 0:t.name)==="unknown")return function(w,g){if(n!==void 0){for(let S=0;S<n.length;S++)if(!n[S].func(w))return n[S].issue}};const u=o.map(w=>e[w]),c=s.length,h=Object.create(null);o.forEach((w,g)=>{h[w]=~g});const m=s.map(w=>Us(w,{ok:!1,code:"missing_value"}));function y(w,g,S){g==="__proto__"?Object.defineProperty(w,g,{value:S,writable:!0,enumerable:!0,configurable:!0}):w[g]=S}return function(w,g){let S=!1,I=w,D,k,C=0,M=0;if(g&go||g&bo||t!==void 0)for(const _ in w){const x=w[_],O=~h[_];let T;if(O>=0)M++,C=fy(C,O),T=u[O].func(x,g);else if(t!==void 0)T=t.func(x,g);else{if(g&go)k===void 0?k=[_]:k.push(_);else if(g&bo&&D===void 0&&!S){I={},S=!0;for(let L=0;L<a;L++)if(Yr(C,L)){const P=o[L];y(I,P,w[P])}}continue}if(T===void 0)S&&D===void 0&&y(I,_,x);else if(!T.ok)D=Gs(D,Us(_,T));else if(D===void 0){if(!S)if(I={},S=!0,t===void 0){for(let L=0;L<a;L++)if(L!==O&&Yr(C,L)){const P=o[L];y(I,P,w[P])}}else for(const L in w)y(I,L,w[L]);y(I,_,T.value)}}if(M<a)for(let _=0;_<a;_++){if(Yr(C,_))continue;const x=o[_],O=w[x];let T=g&~Ks;if(O===void 0&&!(x in w)){if(_<c){D=Gs(D,m[_]);continue}T|=Ks}const L=u[_].func(O,T);if(L===void 0)S&&D===void 0&&!(T&Ks)&&y(I,x,O);else if(!L.ok)D=Gs(D,Us(x,L));else if(D===void 0){if(!S)if(I={},S=!0,t===void 0){for(let P=0;P<a;P++)if(P<_||Yr(C,P)){const X=o[P];y(I,X,w[X])}}else{for(const P in w)y(I,P,w[P]);for(let P=0;P<_;P++)if(!Yr(C,P)){const X=o[P];y(I,X,w[X])}}y(I,x,L.value)}}if(k!==void 0&&(D=Gs(D,{ok:!1,code:"unrecognized_keys",keys:k})),D===void 0&&n!==void 0){for(let _=0;_<n.length;_++)if(!n[_].func(I))return n[_].issue}return D===void 0&&S?{ok:!0,value:I}:D}}class qs extends _e{constructor(t,n,s){super(),this.prefix=t,this.rest=n,this.suffix=s,this.name="array",this.restType=n??my(),this.minLength=this.prefix.length+this.suffix.length,this.maxLength=n?void 0:this.minLength,this.invalidType={ok:!1,code:"invalid_type",expected:["array"]},this.invalidLength={ok:!1,code:"invalid_length",minLength:this.minLength,maxLength:this.maxLength}}func(t,n){var s;if(!Array.isArray(t))return this.invalidType;const i=t.length,o=this.minLength,a=(s=this.maxLength)!==null&&s!==void 0?s:1/0;if(i<o||i>a)return this.invalidLength;const u=this.prefix.length,c=t.length-this.suffix.length;let h,m=t;for(let y=0;y<t.length;y++){const g=(y<u?this.prefix[y]:y>=c?this.suffix[y-c]:this.restType).func(t[y],n);g!==void 0&&(g.ok?(m===t&&(m=t.slice()),m[y]=g.value):h=Gs(h,Us(y,g)))}return h||(t===m?void 0:{ok:!0,value:m})}concat(t){if(this.rest){if(t.rest)throw new TypeError("can not concatenate two variadic types");return new qs(this.prefix,this.rest,[...this.suffix,...t.prefix,...t.suffix])}else return t.rest?new qs([...this.prefix,...this.suffix,...t.prefix],t.rest,t.suffix):new qs([...this.prefix,...this.suffix,...t.prefix,...t.suffix],t.rest,t.suffix)}}function $c(e){const t=typeof e;return t!=="object"?t:e===null?"null":Array.isArray(e)?"array":t}function Zr(e){return Array.from(new Set(e))}function Xb(e){const t=new Map;e.forEach(s=>{for(const i in s)t.set(i,(t.get(i)||0)+1)});const n=[];return t.forEach((s,i)=>{s===e.length&&n.push(i)}),n}function py(e){const t=new Map,n=new Map,s=new Map,i=[],o=[],a=[];e.forEach(({root:c,terminal:h})=>{var m;if(t.set(c,(m=t.get(c))!==null&&m!==void 0?m:t.size),h.name!=="never")if(h.name==="optional")o.push(c);else if(h.name==="unknown")i.push(c);else if(h.name==="literal"){const y=n.get(h.value)||[];y.push(c),n.set(h.value,y),a.push($c(h.value))}else{const y=s.get(h.name)||[];y.push(c),s.set(h.name,y),a.push(h.name)}}),n.forEach((c,h)=>{const m=s.get($c(h));m&&(m.push(...c),n.delete(h))});const u=(c,h)=>{var m,y;return((m=t.get(c))!==null&&m!==void 0?m:0)-((y=t.get(h))!==null&&y!==void 0?y:0)};return s.forEach((c,h)=>s.set(h,Zr(c.concat(i).sort(u)))),n.forEach((c,h)=>n.set(h,Zr(c.concat(i)).sort(u))),{types:s,literals:n,unknowns:Zr(i).sort(u),optionals:Zr(o).sort(u),expectedTypes:Zr(a)}}function Yb(e,t){const n=[];for(const{root:w,terminal:g}of e)g.shape[t].toTerminals(S=>n.push({root:w,terminal:S}));const{types:s,literals:i,optionals:o,unknowns:a,expectedTypes:u}=py(n);if(a.length>0||o.length>1)return;for(const w of i.values())if(w.length>1)return;for(const w of s.values())if(w.length>1)return;const c=Us(t,{ok:!1,code:"missing_value"}),h=Us(t,s.size===0?{ok:!1,code:"invalid_literal",expected:Array.from(i.keys())}:{ok:!1,code:"invalid_type",expected:u}),m=i.size>0?new Map:void 0;for(const[w,g]of i)m.set(w,g[0]);const y=s.size>0?{}:void 0;for(const[w,g]of s)y[w]=g[0];return function(w,g){var S;const I=w,D=I[t];if(D===void 0&&!(t in I))return o.length>0?o[0].func(I,g):c;const k=(S=y==null?void 0:y[$c(D)])!==null&&S!==void 0?S:m==null?void 0:m.get(D);return k?k.func(I,g):h}}function Zb(e){if(e.some(({terminal:s})=>s.name==="unknown"))return;const t=e.filter(s=>s.terminal.name==="object");if(t.length<2)return;const n=t.map(({terminal:s})=>s.shape);for(const s of Xb(n)){const i=Yb(t,s);if(i)return i}}function Wb(e){const{expectedTypes:t,literals:n,types:s,unknowns:i,optionals:o}=py(e),a=s.size===0&&i.length===0?{ok:!1,code:"invalid_literal",expected:Array.from(n.keys())}:{ok:!1,code:"invalid_type",expected:t},u=n.size>0?n:void 0,c=s.size>0?{}:void 0;for(const[h,m]of s)c[h]=m;return function(h,m){var y,w;let g;if(m&Ks?g=o:g=(w=(y=c==null?void 0:c[$c(h)])!==null&&y!==void 0?y:u==null?void 0:u.get(h))!==null&&w!==void 0?w:i,!g)return a;let S=0,I=a;for(let D=0;D<g.length;D++){const k=g[D].func(h,m);if(k===void 0||k.ok)return k;I=S>0?Gs(I,k):k,S++}return S>1?{ok:!1,code:"invalid_union",tree:I}:I}}class eS extends _e{constructor(t){super(),this.options=t,this.name="union"}toTerminals(t){this.options.forEach(n=>n.toTerminals(t))}func(t,n){let s=this._func;if(s===void 0){const i=[];this.options.forEach(u=>u.toTerminals(c=>{i.push({root:u,terminal:c})}));const o=Wb(i),a=Zb(i);a?s=function(u,c){return hy(u)?a(u,c):o(u,c)}:s=o,this._func=s}return s(t,n)}}const tS=Object.freeze({mode:"strict"}),nS=Object.freeze({mode:"strip"}),sS=Object.freeze({mode:"passthrough"});class Jt extends _e{constructor(t,n){super(),this.transformed=t,this.transform=n,this.name="transform",this.undef=Uu(void 0),this.transformChain=void 0,this.transformRoot=void 0}func(t,n){let s=this.transformChain;if(!s){s=[];let u=this;for(;u instanceof Jt;)s.push(u.transform),u=u.transformed;s.reverse(),this.transformChain=s,this.transformRoot=u}let i=this.transformRoot.func(t,n);if(i!==void 0&&!i.ok)return i;let o;i!==void 0?o=i.value:n&Ks?(o=void 0,i=this.undef):o=t;const a=n&go?tS:n&bo?nS:sS;for(let u=0;u<s.length;u++){const c=s[u](o,a);if(c!==void 0){if(!c.ok)return c;o=c.value,i=c}}return i}toTerminals(t){this.transformed.toTerminals(t)}}class iS extends _e{constructor(t){super(),this.definer=t,this.name="lazy",this.recursing=!1}func(t,n){return this.type||(this.type=this.definer()),this.type.func(t,n)}toTerminals(t){if(!this.recursing)try{this.recursing=!0,this.type||(this.type=this.definer()),this.type.toTerminals(t)}finally{this.recursing=!1}}}class rS extends _e{constructor(){super(...arguments),this.name="never",this.issue={ok:!1,code:"invalid_type",expected:[]}}func(t,n){return this.issue}}const oS=new rS;function my(){return oS}class aS extends _e{constructor(){super(...arguments),this.name="unknown"}func(t,n){}}const uS=new aS;function Ld(){return uS}class cS extends _e{constructor(){super(...arguments),this.name="undefined",this.issue={ok:!1,code:"invalid_type",expected:["undefined"]}}func(t,n){return t===void 0?void 0:this.issue}}const yy=new cS;function lS(){return yy}class hS extends _e{constructor(){super(...arguments),this.name="null",this.issue={ok:!1,code:"invalid_type",expected:["null"]}}func(t,n){return t===null?void 0:this.issue}}const wy=new hS;function dS(){return wy}class fS extends _e{constructor(){super(...arguments),this.name="number",this.issue={ok:!1,code:"invalid_type",expected:["number"]}}func(t,n){return typeof t=="number"?void 0:this.issue}}const pS=new fS;function mS(){return pS}class yS extends _e{constructor(){super(...arguments),this.name="bigint",this.issue={ok:!1,code:"invalid_type",expected:["bigint"]}}func(t,n){return typeof t=="bigint"?void 0:this.issue}}const wS=new yS;function vS(){return wS}class gS extends _e{constructor(){super(...arguments),this.name="string",this.issue={ok:!1,code:"invalid_type",expected:["string"]}}func(t,n){return typeof t=="string"?void 0:this.issue}}const bS=new gS;function vy(){return bS}class SS extends _e{constructor(){super(...arguments),this.name="boolean",this.issue={ok:!1,code:"invalid_type",expected:["boolean"]}}func(t,n){return typeof t=="boolean"?void 0:this.issue}}const kS=new SS;function IS(){return kS}class CS extends _e{constructor(t){super(),this.value=t,this.name="literal",this.issue={ok:!1,code:"invalid_literal",expected:[t]}}func(t,n){return t===this.value?void 0:this.issue}}function gy(e){return new CS(e)}function Hd(e){return new Nt(e,void 0)}function by(e){return new Nt({},e??Ld())}function Sy(e){return new qs([],e??Ld(),[])}function DS(e){return new qs(e,void 0,[])}function ky(...e){return new eS(e)}function _S(e){return new iS(e)}const ES=Object.freeze(Object.defineProperty({__proto__:null,ValitaError:gl,array:Sy,bigint:vS,boolean:IS,err:Kb,lazy:_S,literal:gy,never:my,null:dS,number:mS,object:Hd,ok:Uu,record:by,string:vy,tuple:DS,undefined:lS,union:ky,unknown:Ld},Symbol.toStringTag,{value:"Module"}));function Ye(e,t){const n=e.length,s=t.length,i=Math.min(n,s);for(let o=0;o<i;){const a=e.codePointAt(o),u=t.codePointAt(o);if(a!==u){if(a<128&&u<128)return a-u;const c=xf(a,_f),h=xf(u,Ef);return xS(_f,c,Ef,h)}o+=NS(a)}return n-s}function xS(e,t,n,s){const i=Math.min(t,s);for(let o=0;o<i;o++){const a=e[o],u=n[o];if(a!==u)return a-u}return t-s}function NS(e){return e>65535?2:1}const Iy=()=>Array.from({length:4},()=>0),_f=Iy(),Ef=Iy();function xf(e,t){if(e<128)return t[0]=e,1;let n,s;if(e<=2047)n=1,s=192;else if(e<=65535)n=2,s=224;else if(e<=1114111)n=3,s=240;else throw new Error("Invalid code point");t[0]=(e>>6*n)+s;let i=1;for(;n>0;n--){const o=e>>6*(n-1);t[i++]=128|o&63}return i}function Fd(e,t){return Ye(e,t)>0}function Ll(e,t){return Ye(e,t)<0}function Hl(e,t){return Ye(e,t)<=0}function $(){let e,t;return{promise:new Promise((s,i)=>{e=s,t=i}),resolve:e,reject:t}}class Ku{constructor(){v(this,"_lockP",null)}async lock(){const t=this._lockP,{promise:n,resolve:s}=$();return this._lockP=n,await t,s}withLock(t){return th(this.lock(),t)}}class Cy{constructor(){v(this,"_lock",new Ku);v(this,"_writeP",null);v(this,"_readP",[])}read(){return this._lock.withLock(async()=>{await this._writeP;const{promise:t,resolve:n}=$();return this._readP.push(t),n})}withRead(t){return th(this.read(),t)}async write(){return await this._lock.withLock(async()=>{await this._writeP,await Promise.all(this._readP);const{promise:t,resolve:n}=$();return this._writeP=t,this._readP=[],n})}withWrite(t){return th(this.write(),t)}}async function th(e,t){const n=await e;try{return await t()}finally{n()}}const $s=2654435761,Vs=2246822519,tc=3266489917,Nf=668265263,Mf=374761393;let MS;function RS(e,t=0){const n=typeof e=="string"?(MS??(MS=new TextEncoder)).encode(e):e,s=n;let i=t+Mf&4294967295,o=0;if(s.length>=16){const u=[t+$s+Vs&4294967295,t+Vs&4294967295,t+0&4294967295,t-$s&4294967295],c=n,h=c.length-16;let m=0;for(o=0;(o&4294967280)<=h;o+=4){const y=o,w=c[y+0]+(c[y+1]<<8),g=c[y+2]+(c[y+3]<<8),S=w*Vs+(g*Vs<<16);let I=u[m]+S&4294967295;I=I<<13|I>>>19;const D=I&65535,k=I>>>16;u[m]=D*$s+(k*$s<<16)&4294967295,m=m+1&3}i=(u[0]<<1|u[0]>>>31)+(u[1]<<7|u[1]>>>25)+(u[2]<<12|u[2]>>>20)+(u[3]<<18|u[3]>>>14)&4294967295}i=i+n.length&4294967295;const a=n.length-4;for(;o<=a;o+=4){const u=o,c=s[u+0]+(s[u+1]<<8),h=s[u+2]+(s[u+3]<<8),m=c*tc+(h*tc<<16);i=i+m&4294967295,i=i<<17|i>>>15,i=(i&65535)*Nf+((i>>>16)*Nf<<16)&4294967295}for(;o<s.length;++o){const u=s[o];i=i+u*Mf,i=i<<11|i>>>21,i=(i&65535)*$s+((i>>>16)*$s<<16)&4294967295}return i=i^i>>>15,i=((i&65535)*Vs&4294967295)+((i>>>16)*Vs<<16),i=i^i>>>13,i=((i&65535)*tc&4294967295)+((i>>>16)*tc<<16),i=i^i>>>16,i<0?i+4294967296:i}function b(e,t="Assertion failed"){if(!e)throw new Error(typeof t=="string"?t:t())}function J(e){bl(e,"string")}function Oe(e){bl(e,"number")}function TS(e){bl(e,"boolean")}function bl(e,t){typeof e!==t&&zd(e,t)}function Pe(e){e===null&&zd(e,"object"),bl(e,"object")}function Os(e){Array.isArray(e)||zd(e,"array")}function OS(e,t){let n="Invalid type: ";return e==null?n+=e:n+=`${typeof e} \`${e}\``,n+`, expected ${t}`}function zd(e,t){throw new Error(OS(e,t))}function PS(e){if(e===null)throw new Error("Expected non-null value")}function we(e){throw new Error("Unreachable")}var f={};Pd(f,{assert:()=>qu,deepPartial:()=>Dy,instanceOfAbstractType:()=>$S,is:()=>LS,literalUnion:()=>Ae,parse:()=>Ct,readonly:()=>FS,readonlyArray:()=>je,readonlyObject:()=>re,readonlyRecord:()=>Qu,test:()=>Sl,testOptional:()=>HS});Bb(f,ES);function nh(e){switch(typeof e){case"string":case"number":case"boolean":return JSON.stringify(e);case"undefined":return"undefined";case"bigint":return e.toString()+"n";default:return e===null?"null":Array.isArray(e)?"array":typeof e}}function Fl(e,t){if(!(t!=null&&t.length))return nh(e);let n=e;for(const s of t)n=n[s];return nh(n)}function zl(e,t,n=s=>String(s)){if(t.length===1)return n(t[0]);const s=`${n(t[t.length-2])} ${e} ${n(t[t.length-1])}`;return t.length===2?s:`${t.slice(0,-2).map(n).join(", ")}, ${s}`}function $d(e,t,n,s){var u;const i=e.issues[0],{path:o}=i,a=o!=null&&o.length?` at ${o.join(".")}`:"";switch(i.code){case"invalid_type":return`Expected ${zl("or",i.expected)}${a}. Got ${Fl(t,o)}`;case"missing_value":{const c=o&&o.length>1?` at ${o.slice(0,-1).join(".")}`:"";return(u=i.path)!=null&&u.length?`Missing property ${i.path.at(-1)}${c}`:`TODO Unknown missing property${c}`}case"invalid_literal":return`Expected literal value ${zl("or",i.expected,nh)}${a} Got ${Fl(t,o)}`;case"invalid_length":return`Expected array with length ${i.minLength===i.maxLength?i.minLength:`between ${i.minLength} and ${i.maxLength}`}${a}. Got array with length ${t.length}`;case"unrecognized_keys":return i.keys.length===1?`Unexpected property ${i.keys[0]}${a}`:`Unexpected properties ${zl("and",i.keys)}${a}`;case"invalid_union":return n.name==="union"?AS(t,n,s??"strict"):`Invalid union value${a}`;case"custom_error":{const{error:c}=i;return`${c?typeof c=="string"?c:c.message??"unknown":"unknown"}${a}. Got ${Fl(t,o)}`}}}function AS(e,t,n){const s=[];for(const i of t.options){const o=i.try(e,{mode:n});o.ok||s.push({type:i,err:o})}if(s.length&&(s.sort(Rf),s.length===1||Rf(s[0],s[1])<0))return $d(s[0].err,e,s[0].type,n);try{return`Invalid union value: ${JSON.stringify(e)}`}catch{return"Invalid union value"}}function Rf(e,t){const n=e.err.issues[0].path,s=t.err.issues[0].path;if(n.length!==s.length)return s.length-n.length;for(let i=0;i<n.length;i++){if(s[i]>n[i])return-1;if(s[i]<n[i])return 1}return 0}function Ct(e,t,n){const s=Sl(e,t,n);if(!s.ok)throw new TypeError(s.error);return s.value}function LS(e,t,n){return Sl(e,t,n).ok}function qu(e,t,n){Ct(e,t,n)}function Sl(e,t,n){const s=t.try(e,n?{mode:n}:void 0);return s.ok?s:{ok:!1,error:$d(s,e,t,n)}}function HS(e,t,n){let s=1;n==="passthrough"?s=0:n==="strip"&&(s=2);const i=t.func(e,s);if(i===void 0)return{ok:!0,value:e};if(i.ok)return i;const o=new gl(i);return{ok:!1,error:$d(o,e,t,n)}}function FS(e){return e}function re(e){return Hd(e)}function je(e){return Sy(e)}function Qu(e){return by(e)}var zS=Object.getPrototypeOf(Object.getPrototypeOf(vy().optional())).constructor;function $S(e){return e instanceof zS}function Dy(e){const t={};for(const[n,s]of Object.entries(e.shape))s.name==="object"?t[n]=Dy(s).optional():t[n]=s.optional();return Hd(t)}function Ae(...e){return ky(...e.map(gy))}var _y=class extends Error{constructor(t){super(`Chunk not found ${t}`);v(this,"name","ChunkNotFoundError");v(this,"hash");this.hash=t}};async function Ey(e,t){const n=await e.getChunk(t);if(n)return n;throw new _y(t)}async function Vd(e,t){const n=await t.getHead(e);return b(n,`Missing head ${e}`),n}var Vc=5,VS=6,So=7,Ie=So,{hasOwn:Ps}=Object;function As(e,t){if(e===t)return!0;if(typeof e!=typeof t)return!1;switch(typeof e){case"boolean":case"number":case"string":return!1}if(e=e,Array.isArray(e)){if(!Array.isArray(t)||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!As(e[i],t[i]))return!1;return!0}if(e===null||t===null||Array.isArray(t))return!1;e=e,t=t;let n=0;for(const i in e)if(Ps(e,i)){if(!As(e[i],t[i]))return!1;n++}let s=0;for(const i in t)Ps(t,i)&&s++;return n===s}function jS(e){}function xy(e){Pe(e),GS(e)}function GS(e){for(const t in e)Ps(e,t)&&e[t]}function sh(){const e=Math.floor(Math.random()*4294967295),t=Math.floor(Math.random()*4294967295);return BigInt(e)<<32n|BigInt(t)}var BS=22,US=/^[0-9a-v-]+$/,KS="0".repeat(BS),Ve=KS,It=qS();function Tf(e,t){return e.toString(32).slice(-t).padStart(t,"0")}function qS(){let e="",t=0;return()=>{e||(e=Tf(sh(),12));const n=Tf(t++,10);return e+n}}function QS(e){return typeof e=="string"&&US.test(e)}function Gr(e){qu(e,Br)}var Br=f.string().assert(QS,"Invalid hash"),ut=1,Bs=4,JS=5,XS=8;function xs(e){switch(typeof e){case"string":return ut+Bs+e.length;case"number":return YS(e)?e<=-1073741824||e>=2**30-1?ut+JS:ut+Bs:ut+XS;case"boolean":return ut;case"object":if(e===null)return ut;if(Array.isArray(e)){let t=2*ut+Bs;for(const n of e)t+=xs(n);return t}{const t=e;let n=2*ut+Bs;for(const s in t)if(Ps(t,s)){const i=t[s];i!==void 0&&(n+=xs(s)+xs(i))}return n}}throw new Error(`Invalid value. type: ${typeof e}, value: ${e}`)}function YS(e){return e===(e|0)}var ZS=2*ut+Bs+ut+Bs;function Ny(e,t){return ZS+xs(e)+xs(t)}function*ih(...e){for(const t of e)yield*t}function*WS(e,t){let n=0;for(const s of e)t(s,n++)&&(yield s)}function*e0(e,t){let n=0;for(const s of e)yield t(s,n++)}function*t0(e){var s;const t=e[Symbol.iterator](),{value:n}=t.next();n!==void 0&&(yield n),(s=t.return)==null||s.call(t)}var n0=class rh{constructor(t){v(this,"iter");this.iter=t}[Symbol.iterator](){return this.iter[Symbol.iterator]()}map(t){return new rh(e0(this.iter,t))}filter(t){return new rh(WS(this.iter,t))}};function s0(e){return new n0(e)}function My(e,t){let n=0;for(;n<e;){const s=n+(e-n>>1),i=t(s);if(i===0)return s;i>0?n=s+1:e=s}return n}function Ry(e){if(e!==void 0)return e}var Ty=0,Oy=1;function Py(e,t,n){return[e,n>=So?t:t.map(s=>s.slice(0,2))]}async function jc(e,t,n,s){const i=await n.getNode(t);if(s!==n.rootHash)return jc(e,n.rootHash,n,n.rootHash);if(Bc(i))return i;const{entries:o}=i;let a=Rn(e,o);a===o.length&&a--;const u=o[a];return jc(e,u[1],n,s)}function Rn(e,t){return My(t.length,n=>Ye(e,t[n][0]))}function Gc(e,t,n){return e!==t.length&&t[e][0]===n}function Of(e,t,n){if(t>=So)return e;Os(e),b(e.length>=2);const[s,i]=e;Oe(s),Os(i);const o=s>0?J:jS;if(t>=So){for(const u of i)i0(u,o);return e}const a=i.map(u=>r0(u,o,n));return[s,a]}function i0(e,t){Os(e),b(e.length>=3),J(e[0]),t(e[1]),Oe(e[2])}function r0(e,t,n){Os(e),b(e.length>=2),J(e[0]),t(e[1]);const s=n(e[0],e[1]);return[e[0],e[1],s]}var $n,Xp,Ay=(Xp=class{constructor(e,t,n){v(this,"entries");v(this,"hash");v(this,"isMutable");l(this,$n,-1);this.entries=e,this.hash=t,this.isMutable=n}maxKey(){return this.entries[this.entries.length-1][0]}getChildNodeSize(e){if(r(this,$n)!==-1)return r(this,$n);let t=e.chunkHeaderSize;for(const n of this.entries)t+=n[2];return d(this,$n,t)}_updateNode(e){d(this,$n,-1),e.updateNode(this)}},$n=new WeakMap,Xp);function Pf(e,t){return Py(e.level,e.entries,t)}var Mo,oh,Yp,kl=(Yp=class extends Ay{constructor(){super(...arguments);l(this,Mo);v(this,"level",0)}set(t,n,s,i){let o;const a=Rn(t,this.entries);return Gc(a,this.entries,t)?o=1:o=0,Promise.resolve(p(this,Mo,oh).call(this,i,a,o,[t,n,s]))}del(t,n){const s=Rn(t,this.entries);return Gc(s,this.entries,t)?Promise.resolve(p(this,Mo,oh).call(this,n,s,1)):Promise.resolve(this)}async*keys(t){for(const n of this.entries)yield n[0]}async*entriesIter(t){for(const n of this.entries)yield n}},Mo=new WeakSet,oh=function(t,n,s,...i){if(this.isMutable)return this.entries.splice(n,s,...i),this._updateNode(t),this;const o=fc(this.entries,n,s,...i);return t.newDataNodeImpl(o)},Yp);function fc(e,t,n,...s){const i=e.slice(0,t);for(let o=0;o<s.length;o++)i.push(s[o]);for(let o=t+n;o<e.length;o++)i.push(e[o]);return i}var On,ah,uh,Rs,Ly=(Rs=class extends Ay{constructor(n,s,i,o){super(n,s,o);l(this,On);v(this,"level");this.level=i}async set(n,s,i,o){let a=Rn(n,this.entries);a===this.entries.length&&a--;const u=this.entries[a][1],h=await(await o.getNode(u)).set(n,s,i,o),m=h.getChildNodeSize(o);if(m>o.maxSize||m<o.minSize)return p(this,On,ah).call(this,o,a,h);const y=pc(h,o.getEntrySize);return p(this,On,uh).call(this,o,a,y)}async del(n,s){const i=Rn(n,this.entries);if(i===this.entries.length)return this;const o=this.entries[i][1],a=await s.getNode(o),u=a.hash,c=await a.del(n,s);if(c.hash===u)return this;if(c.entries.length===0){const h=fc(this.entries,i,1);return s.newInternalNodeImpl(h,this.level)}if(i===0&&this.entries.length===1)return c;if(c.getChildNodeSize(s)>s.minSize){const h=pc(c,s.getEntrySize);return p(this,On,uh).call(this,s,i,h)}return p(this,On,ah).call(this,s,i,c)}async*keys(n){for(const s of this.entries)yield*(await n.getNode(s[1])).keys(n)}async*entriesIter(n){for(const s of this.entries)yield*(await n.getNode(s[1])).entriesIter(n)}getChildren(n,s,i){const o=[];for(let a=n;a<s&&a<this.entries.length;a++)o.push(i.getNode(this.entries[a][1]));return Promise.all(o)}async getCompositeChildren(n,s,i){const{level:o}=this;if(s===0)return new Rs([],It(),o-1,!0);const a=await this.getChildren(n,n+s,i);if(o>1){const c=[];for(const h of a)c.push(...h.entries);return new Rs(c,It(),o-1,!0)}b(o===1);const u=[];for(const c of a)u.push(...c.entries);return new kl(u,It(),!0)}},On=new WeakSet,ah=async function(n,s,i){const o=this.level-1,a=this.entries;let u,c,h;if(s>0){const g=a[s-1][1],S=await n.getNode(g);u=ih(S.entries,i.entries),c=s-1,h=2}else if(s<a.length-1){const g=a[s+1][1],S=await n.getNode(g);u=ih(i.entries,S.entries),c=s,h=2}else u=i.entries,c=s,h=1;const m=Fy(u,g=>g[2],n.minSize-n.chunkHeaderSize,n.maxSize-n.chunkHeaderSize),y=[];for(const g of m){const S=n.newNodeImpl(g,o),I=pc(S,n.getEntrySize);y.push(I)}if(this.isMutable)return this.entries.splice(c,h,...y),this._updateNode(n),this;const w=fc(a,c,h,...y);return n.newInternalNodeImpl(w,this.level)},uh=function(n,s,i){if(this.isMutable)return this.entries.splice(s,1,i),this._updateNode(n),this;const o=fc(this.entries,s,1,i);return n.newInternalNodeImpl(o,this.level)},Rs);function Hy(e,t,n,s){return n===0?new kl(e,t,s):new Ly(e,t,n,s)}function Bc(e){return e.level===0}function Fy(e,t,n,s){const i=[],o=[];let a=0,u=[];for(const c of e){const h=t(c);h>=s?(u.length>0&&(i.push(u),o.push(a)),i.push([c]),o.push(h),a=0,u=[]):a+h>=n?(u.push(c),i.push(u),o.push(a+h),a=0,u=[]):(a+=h,u.push(c))}return a>0&&(o.length>0&&a+o[o.length-1]<=s?i[i.length-1].push(...u):i.push(u)),i}var zy=Py(0,[],Ie),o0=new kl([],Ve,!1);function pc(e,t){const n=e.maxKey(),s=e.hash,i=t(n,s);return[n,s,i]}var Af=-1,a0=0,mc=1,yc=2,ch=3,nc=0,Lf=1;function*u0(e,t){let n=0,s=0,i;function o(u,c){u[ch]===Af&&(u[ch]=c)}function a(){return[n,0,0,Af]}for(;n<e.length&&s<t.length;)e[n][nc]===t[s][nc]?(As(e[n][Lf],t[s][Lf])?i&&(o(i,0),yield i,i=void 0):(i||(i=a()),i[yc]++,i[mc]++,o(i,s)),n++,s++):e[n][nc]<t[s][nc]?(i||(i=a()),i[mc]++,n++):(i||(i=a()),i[yc]++,o(i,s),s++);s<t.length&&(i||(i=a()),i[yc]+=t.length-s,o(i,s)),n<e.length&&(i||(i=a()),i[mc]+=e.length-n),i&&(o(i,0),yield i)}var c0=11,Gt=class{constructor(e,t,n=Ve,s=Ny,i=c0){v(this,"_cache",new Map);v(this,"_dagRead");v(this,"_formatVersion");v(this,"rootHash");v(this,"getEntrySize");v(this,"chunkHeaderSize");this._dagRead=e,this._formatVersion=t,this.rootHash=n,this.getEntrySize=s,this.chunkHeaderSize=i}async getNode(e){if(e===Ve)return o0;const t=this._cache.get(e);if(t)return t;const n=await this._dagRead.mustGetChunk(e),s=Of(n.data,this._formatVersion,this.getEntrySize),i=Hy(s[Oy],e,s[Ty],!1);return this._cache.set(e,i),i}async get(e){const t=await jc(e,this.rootHash,this,this.rootHash),n=Rn(e,t.entries);if(Gc(n,t.entries,e))return t.entries[n][1]}async has(e){const t=await jc(e,this.rootHash,this,this.rootHash),n=Rn(e,t.entries);return Gc(n,t.entries,e)}async isEmpty(){const{rootHash:e}=this,t=await this.getNode(this.rootHash);return this.rootHash!==e?this.isEmpty():t.entries.length===0}scan(e){return lh(this.rootHash,()=>this.rootHash,this.rootHash,e,async t=>{const n=await this.getNode(t);if(n)return[n.level,n.isMutable?n.entries.slice():n.entries];const s=await this._dagRead.mustGetChunk(t);return Of(s.data,this._formatVersion,this.getEntrySize)})}async*keys(){yield*(await this.getNode(this.rootHash)).keys(this)}async*entries(){yield*(await this.getNode(this.rootHash)).entriesIter(this)}[Symbol.asyncIterator](){return this.entries()}async*diff(e){const[t,n]=await Promise.all([this.getNode(this.rootHash),e.getNode(e.rootHash)]);yield*wc(n,t,e,this)}};async function*wc(e,t,n,s){if(e.level>t.level){const o=await e.getCompositeChildren(0,e.entries.length,n);yield*wc(o,t,n,s);return}if(t.level>e.level){const o=await t.getCompositeChildren(0,t.entries.length,s);yield*wc(e,o,n,s);return}if(Bc(e)&&Bc(t)){yield*l0(e.entries,t.entries);return}const i=u0(e.entries,t.entries);for(const o of i){const[a,u]=await Promise.all([e.getCompositeChildren(o[a0],o[mc],n),t.getCompositeChildren(o[ch],o[yc],s)]);yield*wc(a,u,n,s)}}function*l0(e,t){const n=e.length,s=t.length;let i=0,o=0;for(;i<n&&o<s;){const a=e[i][0],u=t[o][0];a===u?(As(e[i][1],t[o][1])||(yield{op:"change",key:a,oldValue:e[i][1],newValue:t[o][1]}),i++,o++):a<u?(yield{op:"del",key:a,oldValue:e[i][1]},i++):(yield{op:"add",key:u,newValue:t[o][1]},o++)}for(;i<n;i++)yield{op:"del",key:e[i][0],oldValue:e[i][1]};for(;o<s;o++)yield{op:"add",key:t[o][0],newValue:t[o][1]}}async function*lh(e,t,n,s,i){if(n===Ve)return;const o=await i(n),a=o[Oy];let u=0;if(s&&(u=Rn(s,a)),o[Ty]>0)for(;u<a.length;u++)yield*lh(e,t,a[u][1],s,i),s="";else for(;u<a.length;u++){const c=t();if(e!==c){yield*lh(c,t,c,a[u][0],i);return}yield a[u]}}async function Uc(e,t){const n=[],s=t==="add"?i=>({op:"add",key:i[0],newValue:i[1]}):i=>({op:"del",key:i[0],oldValue:i[1]});for await(const i of e.entries())n.push(s(i));return n}function $y(e,t){return e===t?0:e<t?-1:1}function jd(e,t){if(e===t)return 0;if(e===null)return-1;if(t===null)return 1;const n=Hf(e),s=Hf(t);return typeof n=="string"||typeof s=="string"?$y(String(n),String(s)):n-s}function Hf(e){return typeof e=="string"||typeof e=="number"?e:e.order}function Vy(e){if(!(e===null||typeof e=="string"||typeof e=="number")&&(xy(e),!(typeof e.order=="string"||typeof e.order=="number")))throw new Error("Invalid cookie")}function Il(e){if(Array.isArray(e)){e.sort();for(let n=1;n<e.length;n++)b(e[n-1]!==e[n],"Refs must not have duplicates");return e}const t=[...e];return t.sort(),t}var jy=class{constructor(e,t,n){v(this,"hash");v(this,"data");v(this,"meta");b(!n.includes(e),"Chunk cannot reference itself"),this.hash=e,this.data=t,this.meta=n}};function Gy(e){if(!Array.isArray(e))throw new Error("Refs must be an array");if(e.length>0){J(e[0]);for(let t=1;t<e.length;t++)J(e[t])}}function By(e,t,n){const s=n();return new jy(s,e,t)}var qr=4,Qr=5,Ce="main";function Ju(e){return Cl(e.meta)}function h0(e){return Ju(e)}function Gd(e){return m0(e.meta)}var Uy=class{constructor(e){v(this,"chunk");this.chunk=e}get meta(){return this.chunk.data.meta}get valueHash(){return this.chunk.data.valueHash}getMutationID(e,t){return Bd(e,t,this.meta)}async getNextMutationID(e,t){return await this.getMutationID(e,t)+1}get indexes(){return this.chunk.data.indexes}};async function Bd(e,t,n){switch(n.type){case Qr:return n.lastMutationIDs[e]??0;case qr:{if(n.clientID===e)return n.mutationID;const{basisHash:s}=n,i=await te(s,t);return Bd(e,t,i.meta)}default:we()}}async function Ky(e,t){return(await Xy(e,t)).filter(s=>h0(s))}async function qy(e,t){return(await Xy(e,t)).filter(s=>Ju(s))}async function Qy(e,t,n){const s=[],i=new Map(Object.entries(t));for(;!Gd(e)&&i.size>0;){if(Ju(e)){const{meta:a}=e,u=i.get(a.clientID);u!==void 0&&(a.mutationID<=u?i.delete(a.clientID):s.push(e))}const{basisHash:o}=e.meta;if(o===null)throw new Error(`Commit ${e.chunk.hash} has no basis`);e=await te(o,n)}return s}async function d0(e,t){const n=await t.getHead(e);return b(n,`Missing head ${e}`),Bt(n,t)}async function Jy(e,t){return(await Bt(e,t)).chunk.hash}async function Bt(e,t){const n=await te(e,t);return yo(n,t)}async function yo(e,t){for(;!Gd(e);){const{meta:n}=e;if(Cl(n))e=await te(n.baseSnapshotHash,t);else{const{basisHash:s}=n;if(s===null)throw new Error(`Commit ${e.chunk.hash} has no basis`);e=await te(s,t)}}return e}function Ff(e,t){const n=e.meta;return[n.lastMutationIDs[t]??0,n.cookieJSON]}function hh(e,t){return jd(e.meta.cookieJSON,t.meta.cookieJSON)}async function Xy(e,t){let n=await te(e,t);const s=[];for(;!Gd(n);){const{meta:i}=n,{basisHash:o}=i;if(o===null)throw new Error(`Commit ${n.chunk.hash} has no basis`);s.push(n),n=await te(o,t)}return s.push(n),s}async function te(e,t){const n=await t.mustGetChunk(e);return b0(n)}async function Ud(e,t){const n=await Vd(e,t);return te(n,t)}function f0(e){if(J(e.clientID),Oe(e.mutationID),J(e.mutatorName),!e.mutatorName)throw new Error("Missing mutator name");e.mutatorArgsJSON,e.originalHash!==null&&Gr(e.originalHash),Oe(e.timestamp)}function Cl(e){return e.type===qr}function Kd(e){e.basisHash!==null&&Gr(e.basisHash),e.cookieJSON,p0(e.lastMutationIDs)}function p0(e){Pe(e);for(const t of Object.values(e))Oe(t)}function Ns(e){Kd(e.meta)}function m0(e){return e.type===Qr}function y0(e,t){return e.jsonPointer===t.jsonPointer&&(e.allowEmpty??!1)===(t.allowEmpty??!1)&&e.keyPrefix===t.keyPrefix}function w0(e,t){return{name:e,keyPrefix:t.prefix??"",jsonPointer:t.jsonPointer,allowEmpty:t.allowEmpty??!1}}function v0(e,t,n,s,i,o,a,u,c,h,m){return Zy(e,ew({type:qr,basisHash:t,baseSnapshotHash:n,mutationID:s,mutatorName:i,mutatorArgsJSON:o,originalHash:a,timestamp:h,clientID:m},u,c))}function g0(e,t,n,s,i,o){return Zy(e,Yy(t,n,s,i,o))}function Yy(e,t,n,s,i){return ew({type:Qr,basisHash:e,lastMutationIDs:t,cookieJSON:n},s,i)}function b0(e){return S0(e),new Uy(e)}function Zy(e,t){return new Uy(e(t,Wy(t)))}function Wy(e){const t=new Set;t.add(e.valueHash);const{meta:n}=e;switch(n.type){case qr:n.basisHash&&t.add(n.basisHash);break;case Qr:break;default:we()}for(const s of e.indexes)t.add(s.valueHash);return Il(t)}function ew(e,t,n){return{meta:e,valueHash:t,indexes:n}}function S0(e){const{data:t}=e,n=new Set;for(const s of t.indexes){const{name:i}=s.definition;if(n.has(i))throw new Error(`Duplicate index ${i}`);n.add(i)}}var qd=0,tw=1,nw=class{constructor(e,t){v(this,"meta");v(this,"map");this.meta=e,this.map=t}},k0=class extends nw{flush(){return this.map.flush()}clear(){return this.map.clear()}};async function dh(e,t,n,s,i,o,a){var u;try{for(const c of I0(s,i,o,a))switch(n){case qd:await t.put(c,i);break;case tw:await t.del(c);break}}catch(c){(u=e.info)==null||u.call(e,"Not indexing value",i,":",c)}}function I0(e,t,n,s){const i=C0(t,n);if(i===void 0){if(s)return[];throw new Error(`No value at path: ${n}`)}const o=Array.isArray(i)?i:[i],a=[];for(const u of o)if(typeof u=="string")a.push(sw([u,e]));else throw new Error("Unsupported target type");return a}var fh="\0",ph="\0";function sw(e){const t=e[0],n=e[1];if(t.includes("\0"))throw new Error("Secondary key cannot contain null byte");return fh+t+ph+n}function zf(e,t){const n=sw([e,t||""]);return t===void 0?n.slice(0,n.length-1):n}function Dl(e){if(e[0]!==fh)throw new Error("Invalid version");const t=fh.length,n=ph.length,s=e.indexOf(ph,t);if(s===-1)throw new Error("Invalid formatting");const i=e.slice(t,s),o=e.slice(s+n);return[i,o]}function C0(e,t){function n(o){if(!(o.startsWith("+")||o.startsWith("0")&&o.length!==1))return parseInt(o,10)}if(t==="")return e;if(!t.startsWith("/"))throw new Error(`Invalid JSON pointer: ${t}`);const s=t.split("/").slice(1).map(o=>o.replace(/~1/g,"/").replace(/~0/g,"~"));let i=e;for(const o of s){let a;if(Array.isArray(i)){const u=n(o);if(u===void 0)return;a=i[u]}else{if(i===null)return;typeof i=="object"&&(i=i,a=i[o])}if(a===void 0)return;i=a}return i}var Xs,Zp,iw=(Zp=class{constructor(e,t,n){l(this,Xs);v(this,"map");v(this,"indexes");d(this,Xs,e),this.map=t,this.indexes=n}has(e){return this.map.has(e)}get(e){return this.map.get(e)}isEmpty(){return this.map.isEmpty()}getMapForIndex(e){const t=this.indexes.get(e);if(t===void 0)throw new Error(`Unknown index name: ${e}`);return t.map}get closed(){return r(this,Xs).closed}close(){r(this,Xs).release()}},Xs=new WeakMap,Zp);function D0(e,t){return _0(Ce,e,t)}async function _0(e,t,n){const s=await Ud(e,t);return rw(s,t,n)}async function E0(e,t,n){const s=await te(e,t);return rw(s,t,n)}function rw(e,t,n){const s=Kc(e,t,n),i=new Gt(t,n,e.valueHash);return new iw(t,i,s)}function Kc(e,t,n){const s=new Map;for(const i of e.indexes)s.set(i.definition.name,new nw(i,new Gt(t,n,i.valueHash)));return s}var x0=re({prefix:f.string().optional(),jsonPointer:f.string(),allowEmpty:f.boolean().optional()}),N0=Qu(x0);function M0(e,t){return e.jsonPointer===t.jsonPointer&&(e.allowEmpty??!1)===(t.allowEmpty??!1)&&(e.prefix??"")===(t.prefix??"")}function ow(e,t){if(Object.keys(e).length!==Object.keys(t).length)return!1;for(const[n,s]of Object.entries(e)){const i=t[n];if(!i||!M0(s,i))return!1}return!0}var R0=re({headHash:Br,mutatorNames:je(f.string()),indexes:N0,mutationIDs:Qu(f.number()),lastServerAckdMutationIDs:f.record(f.number()),disabled:f.boolean()}),aw="client-groups";function T0(e){qu(e,R0)}function O0(e){Pe(e);const t=new Map;for(const[n,s]of Object.entries(e))s!==void 0&&(T0(s),t.set(n,s));return t}function P0(e,t){const n={};for(const[s,i]of e.entries())t.assertValidHash(i.headHash),n[s]={...i,mutatorNames:[...i.mutatorNames.values()]};return n}async function A0(e,t){const n=await t.getChunk(e);return O0(n==null?void 0:n.data)}async function Jr(e){const t=await e.getHead(aw);return t?A0(t,e):new Map}async function L0(e,t){const n=await Jr(t);for(const[s,i]of e){const o=n.get(s);uw(i,o)}return cw(e,t)}async function Qd(e,t,n){const s=await Jr(n),i=s.get(e);uw(t,i);const o=new Map(s);return o.set(e,t),cw(o,n)}function uw(e,t){const n=new Set(e.mutatorNames);b(n.size===e.mutatorNames.length,"A client group's mutatorNames must be a set."),t!==void 0&&(b(ow(t.indexes,e.indexes),"A client group's index definitions must never change."),b(lw(n,t.mutatorNames),"A client group's mutatorNames must never change."))}async function cw(e,t){const n=P0(e,t),s=new Set;for(const o of e.values())s.add(o.headHash);const i=t.createChunk(n,Il(s));return await t.putChunk(i),await t.setHead(aw,i.hash),e}function lw(e,t){if(t.length!==e.size)return!1;for(const n of t)if(!e.has(n))return!1;return!0}async function _l(e,t){return(await Jr(t)).get(e)}function hw(e){for(const[t,n]of Object.entries(e.mutationIDs)){const s=e.lastServerAckdMutationIDs[t];if(s===void 0&&n!==0||s<n)return!0}return!1}async function H0(e,t){const n=await _l(e,t);if(!n)return;const s={...n,disabled:!0};await Qd(e,s,t)}function pe(e,t){return El(e.read(),t)}function qc(e,t){return El(e.write(),t)}function he(e,t){return El(e.write(),async n=>{const s=await t(n);return await n.commit(),s})}async function El(e,t){const n=await e;try{return await t(n)}finally{n.release()}}async function dw(e){const t=[];for await(const n of e)t.push(n);return t}function ko(e,t){return dw(t.diff(e))}var Vn,Xt,jn,no,Wp,xl=(Wp=class extends Gt{constructor(t,n,s=Ve,i=8*1024,o=16*1024,a=Ny,u){super(t,n,s,a,u);l(this,jn);l(this,Vn,new Ku);l(this,Xt,new Map);v(this,"minSize");v(this,"maxSize");this.minSize=i,this.maxSize=o}updateNode(t){b(t.isMutable),r(this,Xt).delete(t.hash),t.hash=It(),p(this,jn,no).call(this,t)}newInternalNodeImpl(t,n){const s=new Ly(t,It(),n,!0);return p(this,jn,no).call(this,s),s}newDataNodeImpl(t){const n=new kl(t,It(),!0);return p(this,jn,no).call(this,n),n}newNodeImpl(t,n){const s=Hy(t,It(),n,!0);return p(this,jn,no).call(this,s),s}put(t,n){return r(this,Vn).withLock(async()=>{const s=await this.getNode(this.rootHash),i=this.getEntrySize(t,n),o=await s.set(t,n,i,this);if(o.getChildNodeSize(this)>this.maxSize){const a=this.chunkHeaderSize,u=Fy(o.entries,y=>y[2],this.minSize-a,this.maxSize-a),{level:c}=o,h=u.map(y=>{const w=this.newNodeImpl(y,c);return pc(w,this.getEntrySize)}),m=this.newInternalNodeImpl(h,c+1);this.rootHash=m.hash;return}this.rootHash=o.hash})}del(t){return r(this,Vn).withLock(async()=>{const s=await(await this.getNode(this.rootHash)).del(t,this),i=this.rootHash!==s.hash;return i&&(s.level>0&&s.entries.length===1?this.rootHash=s.entries[0][1]:this.rootHash=s.hash),i})}clear(){return r(this,Vn).withLock(()=>{r(this,Xt).clear(),this.rootHash=Ve})}flush(){return r(this,Vn).withLock(async()=>{const t=this._dagRead;if(this.rootHash===Ve){const i=t.createChunk(zy,[]);return await t.putChunk(i),i.hash}const n=[],s=fw(this.rootHash,n,t.createChunk,r(this,Xt),this._formatVersion);return await Promise.all(n.map(i=>t.putChunk(i))),r(this,Xt).clear(),this.rootHash=s,s})}},Vn=new WeakMap,Xt=new WeakMap,jn=new WeakSet,no=function(t){b(t.isMutable),r(this,Xt).set(t.hash,t),this._cache.set(t.hash,t)},Wp);function fw(e,t,n,s,i){const o=s.get(e);if(o===void 0)return e;if(Bc(o)){const h=n(Pf(o,i),[]);return t.push(h),h.hash}const a=[],{entries:u}=o;for(let h=0;h<u.length;h++){const m=u[h],y=m[1],w=fw(y,t,n,s,i);w!==y&&(u[h]=[m[0],w,m[2]]),a.push(w)}const c=n(Pf(o,i),Il(a));return t.push(c),c.hash}function $f(e){let t;return()=>(t===void 0&&(t=e()),t)}var Jd=class extends Map{set(e,t){return t.length===0?this:super.set(e,t)}};async function F0(e,t,n,s,i){const[o,a]=await Promise.all([te(e,n),te(t,n)]);return pw(o,a,n,s,i)}async function pw(e,t,n,s,i){const o=new Jd;if(!s.shouldComputeDiffs())return o;const a=new Gt(n,i,e.valueHash),u=new Gt(n,i,t.valueHash),c=await ko(a,u);return o.set("",c),await mw(e,t,n,o,s,i),o}async function mw(e,t,n,s,i,o){const a=Kc(e,n,o),u=Kc(t,n,o);for(const[c,h]of a){if(!i.shouldComputeDiffsForIndex(c))continue;const m=u.get(c);if(m!==void 0){b(m!==h);const y=await ko(h.map,m.map);u.delete(c),s.set(c,y)}else{const y=await Uc(h.map,"del");s.set(c,y)}}for(const[c,h]of u){if(!i.shouldComputeDiffsForIndex(c))continue;const m=await Uc(h.map,"add");s.set(c,m)}}var de,Yt,Ys,Zs,Zt,ul,ww,em,yw=(em=class extends iw{constructor(t,n,s,i,o,a,u){super(t,n,o);l(this,ul);l(this,de);l(this,Yt);l(this,Ys);l(this,Zs);l(this,Zt);d(this,de,t),d(this,Yt,s),d(this,Ys,i),d(this,Zs,a),d(this,Zt,u),b(s===void 0?i.basisHash===Ve:i.basisHash===s.chunk.hash)}async put(t,n,s){const i=$f(()=>this.map.get(n));await Vf(t,this.indexes,n,i,s),await this.map.put(n,s)}getMutationID(){return Bd(r(this,Zs),r(this,de),r(this,Ys))}async del(t,n){const s=$f(()=>this.map.get(n));return s!==void 0&&await Vf(t,this.indexes,n,s,void 0),this.map.del(n)}async clear(){await this.map.clear();const t=[];for(const n of this.indexes.values())t.push(n.clear());await Promise.all(t)}async putCommit(){const t=await this.map.flush(),n=[];for(const o of this.indexes.values()){const a=await o.flush(),u={definition:o.meta.definition,valueHash:a};n.push(u)}let s;const i=r(this,Ys);switch(i.type){case qr:{b(r(this,Zt)>=Vc);const{basisHash:o,mutationID:a,mutatorName:u,mutatorArgsJSON:c,originalHash:h,timestamp:m}=i;s=v0(r(this,de).createChunk,o,await Jy(o,r(this,de)),a,u,c,h,t,n,m,r(this,Zs));break}case Qr:{b(r(this,Zt)>Vc);const{basisHash:o,lastMutationIDs:a,cookieJSON:u}=i;s=g0(r(this,de).createChunk,o,a,u,t,n);break}}return await r(this,de).putChunk(s.chunk),s}async commit(t){const s=(await this.putCommit()).chunk.hash;return await r(this,de).setHead(t,s),await r(this,de).commit(),s}async commitWithDiffs(t,n){const s=this.putCommit(),i=await p(this,ul,ww).call(this,n),o=(await s).chunk.hash;return await r(this,de).setHead(t,o),await r(this,de).commit(),[o,i]}close(){r(this,de).release()}},de=new WeakMap,Yt=new WeakMap,Ys=new WeakMap,Zs=new WeakMap,Zt=new WeakMap,ul=new WeakSet,ww=async function(t){const n=new Jd;if(!t.shouldComputeDiffs())return n;let s=[];if(r(this,Yt)){const o=new Gt(r(this,de),r(this,Zt),r(this,Yt).valueHash);s=await ko(o,this.map)}n.set("",s);let i;r(this,Yt)?i=Kc(r(this,Yt),r(this,de),r(this,Zt)):i=new Map;for(const[o,a]of this.indexes){if(!t.shouldComputeDiffsForIndex(o))continue;const u=i.get(o);b(a!==u);const c=await(u?ko(u.map,a.map):Uc(a.map,"add"));n.set(o,c)}for(const[o,a]of i)if(!this.indexes.has(o)&&t.shouldComputeDiffsForIndex(o)){const u=await Uc(a.map,"del");n.set(o,u)}return n},em);async function vw(e,t,n,s,i,o,a,u){const c=await te(e,i),h=new xl(i,u,c.valueHash),m=await c.getNextMutationID(a,i),y=gw(c,i,u);return b(u>=Vc),new yw(i,h,c,{type:qr,basisHash:e,baseSnapshotHash:await Jy(e,i),mutatorName:t,mutatorArgsJSON:n,mutationID:m,originalHash:s,timestamp:o,clientID:a},y,a,u)}async function z0(e,t,n,s,i,o){const a=await te(e,s),u=new xl(s,o,a.valueHash);return new yw(s,u,a,{basisHash:e,type:Qr,lastMutationIDs:t,cookieJSON:n},gw(a,s,o),i,o)}async function Vf(e,t,n,s,i){const o=[];for(const a of t.values()){const{keyPrefix:u}=a.meta.definition;if(!u||n.startsWith(u)){const c=await s();c!==void 0&&o.push(dh(e,a.map,tw,n,c,a.meta.definition.jsonPointer,a.meta.definition.allowEmpty??!1)),i!==void 0&&o.push(dh(e,a.map,qd,n,i,a.meta.definition.jsonPointer,a.meta.definition.allowEmpty??!1))}}await Promise.all(o)}function gw(e,t,n){const s=new Map;for(const i of e.indexes)s.set(i.definition.name,new k0(i,new xl(t,n,i.valueHash)));return s}async function $0(e,t,n,s,i,o,a){const u=new xl(t,a);for await(const c of n.scan(s)){const h=c[0];if(!h.startsWith(s))break;await dh(e,u,qd,h,c[1],i,o)}return u}var Xd=f.string(),V0=f.string();function Yd(){const t=sh(),n=sh();return(t<<64n|n).toString(32).slice(-18).padStart(18,"0")}var j0=re({heartbeatTimestampMs:f.number(),headHash:Br,tempRefreshHash:Br.nullable(),clientGroupID:Xd}),bw=re({heartbeatTimestampMs:f.number(),refreshHashes:je(Br),persistHash:Br.nullable(),clientGroupID:Xd});function Sw(e){return e.refreshHashes!==void 0}var kw="clients",G0=f.union(j0,bw);function B0(e){qu(e,G0)}function Iw(e){qu(e,bw)}function U0(e){Pe(e);const t=new Map;for(const n in e)if(Ps(e,n)){const s=e[n];s!==void 0&&(B0(s),t.set(n,s))}return t}function K0(e,t){for(const n of e.values())Sw(n)?(n.refreshHashes.forEach(t.assertValidHash),n.persistHash&&t.assertValidHash(n.persistHash)):(t.assertValidHash(n.headHash),n.tempRefreshHash&&t.assertValidHash(n.tempRefreshHash));return Object.fromEntries(e)}async function Fs(e){const t=await e.getHead(kw);return q0(t,e)}async function q0(e,t){if(!e)return new Map;const n=await t.getChunk(e);return U0(n==null?void 0:n.data)}var En=class extends Error{constructor(t){super(`Client state not found, id: ${t}`);v(this,"name","ClientStateNotFoundError");v(this,"id");this.id=t}};async function Q0(e,t){if(!await Cw(e,t))throw new En(e)}async function Cw(e,t){return!!await Zd(e,t)}async function Zd(e,t){return(await Fs(t)).get(e)}async function mh(e,t){const n=await Zd(e,t);if(!n)throw new En(e);return n}function J0(e,t,n,s,i,o,a){return he(n,async u=>{async function c(D,k,C,M){const _=Yy(D,{},k,C,M),x=u.createChunk(_,Wy(_)),O=Yd(),T={heartbeatTimestampMs:Date.now(),refreshHashes:[x.hash],persistHash:null,clientGroupID:O},L=new Map(h).set(e,T),P={headHash:x.hash,mutatorNames:s,indexes:i,mutationIDs:{},lastServerAckdMutationIDs:{},disabled:!1};return await Promise.all([u.putChunk(x),Io(L,u),Qd(O,P,u)]),[T,x.hash,L,!0]}const h=await Fs(u),m=await Y0(u,s,i);if(m.type===Ew){const{clientGroupID:D,headHash:k}=m,C={clientGroupID:D,refreshHashes:[k],heartbeatTimestampMs:Date.now(),persistHash:null},M=new Map(h).set(e,C);return await Io(M,u),[C,k,M,!1]}if(!a||m.type===Dw){const D=u.createChunk(zy,[]);await u.putChunk(D);const k=[];for(const[C,M]of Object.entries(i)){const _=w0(C,M);k.push({definition:_,valueHash:D.hash})}return c(null,null,D.hash,k)}b(m.type===_w);const{snapshot:y}=m,w=[],{valueHash:g,indexes:S}=y,I=new Gt(u,o,g);for(const[D,k]of Object.entries(i)){const{prefix:C="",jsonPointer:M,allowEmpty:_=!1}=k,x={name:D,keyPrefix:C,jsonPointer:M,allowEmpty:_},O=X0(S,x);if(O)w.push({definition:x,valueHash:O.valueHash});else{const T=await $0(t,u,I,C,M,_,o);w.push({definition:x,valueHash:await T.flush()})}}return c(y.meta.basisHash,y.meta.cookieJSON,y.valueHash,w)})}function X0(e,t){return e.find(n=>y0(n.definition,t))}var Dw=0,_w=1,Ew=2;async function Y0(e,t,n){let s,i;const o=new Set(t),a=await Jr(e);for(const[u,c]of a){if(!c.disabled&&lw(o,c.mutatorNames)&&ow(n,c.indexes))return{type:Ew,clientGroupID:u,headHash:c.headHash};const h=await Bt(c.headHash,e);Ns(h);const{cookieJSON:m}=h.meta;(s===void 0||jd(m,s)>0)&&(s=m,i=h)}return i?{type:_w,snapshot:i}:{type:Dw}}function Z0(e){const t=new Set;for(const n of e.values())if(Sw(n)){for(const s of n.refreshHashes)t.add(s);n.persistHash&&t.add(n.persistHash)}else t.add(n.headHash),n.tempRefreshHash&&t.add(n.tempRefreshHash);return Il(t)}async function W0(e,t){const n=await xw(e,t);if(n)return _l(n,t)}async function xw(e,t){const n=await Zd(e,t);return n==null?void 0:n.clientGroupID}async function yh(e,t,n){const s=await Fs(n),i=new Map(s).set(e,t);return Io(i,n)}async function Io(e,t){const n=K0(e,t),s=t.createChunk(n,Z0(e));return await t.putChunk(s),await t.setHead(kw,s.hash),s.hash}function H(e,t){if(e==null)throw new Error(t??`Unexpected ${e} value`);return e}function Nl(e,t){if(e=wh(e),t=wh(t),e===t)return 0;if(e===null)return-1;if(t===null)return 1;if(typeof e=="boolean")return TS(t),e?1:-1;if(typeof e=="number")return Oe(t),e-t;if(typeof e=="string")return J(t),Ye(e,t);throw new Error(`Unsupported type: ${e}`)}function wh(e){return e??null}function ek(e,t){return(n,s)=>{for(const i of e){const o=i[0],a=Nl(n[o],s[o]);if(a!==0)return i[1]==="asc"?a:-a}return 0}}function Wd(e,t){return e==null||t==null?!1:e===t}function ef(e){for(const t of Object.values(e.relationships))for(const n of t())ef(n)}var le=Symbol("rc");function zn(e,t,n,s,i){if(n.isHidden)switch(t.type){case"add":case"remove":for(const[u,c]of Object.entries(t.node.relationships)){const h=H(n.relationships[u]);for(const m of c())zn(e,{type:t.type,node:m},h,u,i)}return;case"edit":return;case"child":{const u=H(n.relationships[t.child.relationshipName]);zn(e,t.child.change,u,s,i);return}default:we()}const{singular:o,relationships:a}=i;switch(t.type){case"add":{let u,c=1;if(o){const h=e[s];h!==void 0&&(b(n.compareRows(h,t.node.row)===0,`Singular relationship '${s}' should not have multiple rows. You may need to declare this relationship with the \`many\` helper instead of the \`one\` helper in your schema.`),c=h[le]+1),u=tf(t.node.row,c),e[s]=u}else u=tk(t.node.row,sc(e,s),n.compareRows);for(const[h,m]of Object.entries(t.node.relationships)){const y=H(n.relationships[h]),w=a[h];if(w===void 0)continue;const g=w.singular?void 0:[];u[h]=g;for(const S of m())zn(u,{type:"add",node:S},y,h,w)}break}case"remove":{if(o){const u=e[s];b(u!==void 0,"node does not exist"),u[le]===1&&(e[s]=void 0),u[le]--}else jf(sc(e,s),t.node.row,n.compareRows);ef(t.node);break}case"child":{let u;if(o)u=ik(e,s);else{const m=sc(e,s),{pos:y,found:w}=Co(m,t.node.row,n.compareRows);b(w,"node does not exist"),u=m[y]}const c=H(n.relationships[t.child.relationshipName]),h=i.relationships[t.child.relationshipName];h!==void 0&&zn(u,t.child.change,c,t.child.relationshipName,h);break}case"edit":{if(o){const u=e[s];sk(u);const c=u[le],h={...u,...t.node.row,[le]:c};u[le]=0,e[s]=h}else{const u=sc(e,s);if(n.compareRows(t.oldNode.row,t.node.row)===0){const{pos:c,found:h}=Co(u,t.oldNode.row,n.compareRows);b(h,"node does not exist");const m=u[c],y=m[le];m[le]=0;const w=Nw(t.node.row,m,i.relationships,y);u[c]=w}else{const c=jf(u,t.oldNode.row,n.compareRows);nk(u,t.node.row,c,i.relationships,n.compareRows)}}break}default:we()}}function tk(e,t,n){const{pos:s,found:i}=Co(t,e,n);let o=0,a=1;i&&(o=1,a=t[s][le],t[s][le]=a-1,a++);const u=tf(e,a);return t.splice(s,o,u),u}function nk(e,t,n,s,i){const{pos:o,found:a}=Co(e,t,i);let u=0,c=1;if(a){u=1;const m=e[o];c=m[le]+1,m[le]=0}const h=Nw(t,n,s,c);e.splice(o,u,h)}function jf(e,t,n){const{pos:s,found:i}=Co(e,t,n);b(i,"node does not exist");const o=e[s];return o[le]===1&&e.splice(s,1),o[le]--,o}function Co(e,t,n){let s=0,i=e.length-1;for(;s<=i;){const o=s+i>>>1,a=n(e[o],t);if(a<0)s=o+1;else if(a>0)i=o-1;else return{pos:o,found:!0}}return{pos:s,found:!1}}function Nw(e,t,n,s){const i=tf(e,s);for(const o in n)b(!(o in e),"Relationship already exists"),i[o]=t[o];return i}function sc(e,t){const n=e[t];return Os(n),n}function sk(e){Oe(e[le])}function ik(e,t){const n=e[t];return Oe(n[le]),n}function tf(e,t){return{...e,[le]:t}}var so="none",Mw={s:1e3,m:60*1e3,h:60*60*1e3,d:24*60*60*1e3,y:365*24*60*60*1e3};function wo(e){if(typeof e=="number")return Number.isNaN(e)?0:!Number.isFinite(e)||e<0?-1:e;if(e==="none")return 0;if(e==="forever")return-1;const t=Mw[e[e.length-1]];return Number(e.slice(0,-1))*t}function rk(e,t){const n=wo(e),s=wo(t);return n===-1&&s!==-1?1:n!==-1&&s===-1?-1:n-s}function rM(e){if(typeof e=="string")return e;if(e<0)return"forever";if(e===0)return"none";let t=e.toString();const n=t.length;for(const s of["y","d","h","m","s"]){const i=Mw[s],a=`${e/i}${s}`;a.length<t.length&&(t=a)}return t.length<n?t:e}function ok(e){let t=e.findIndex(s=>s===void 0);if(t<0)return e;const n=e.slice(0,t);for(t++;t<e.length;t++){const s=e[t];s!==void 0&&n.push(s)}return n}function ak(e,t){return e.length===t.length&&e.every((n,s)=>n===t[s])}var Kt=f.unknown().chain(e=>Uu(e)),uk=f.unknown().chain(e=>Uu(e)),ck=f.union(Kt,f.undefined()),Xu=Qu(ck),lk=f.string(),xn=Symbol(),hk=f.tuple([lk,Ae("asc","desc")]),dk=je(hk);f.union(f.string(),f.number(),f.boolean(),f.null());var fk=Ae("=","!=","IS","IS NOT"),pk=Ae("<",">","<=",">="),mk=Ae("LIKE","NOT LIKE","ILIKE","NOT ILIKE"),yk=Ae("IN","NOT IN"),wk=f.union(fk,pk,mk,yk),Rw=re({type:f.literal("literal"),value:f.union(f.string(),f.number(),f.boolean(),f.null(),je(f.union(f.string(),f.number(),f.boolean())))}),vk=re({type:f.literal("column"),name:f.string()}),Tw=re({type:f.literal("static"),anchor:Ae("authData","preMutationRow"),field:f.union(f.string(),f.array(f.string()))}),gk=f.union(Rw,vk,Tw),bk=re({type:f.literal("simple"),op:wk,left:gk,right:f.union(Tw,Rw)}),Sk=Ae("EXISTS","NOT EXISTS"),kk=re({type:f.literal("correlatedSubquery"),related:f.lazy(()=>Pw),op:Sk}),nf=f.union(bk,f.lazy(()=>Ik),f.lazy(()=>Ck),kk),Ik=re({type:f.literal("and"),conditions:je(nf)}),Ck=re({type:f.literal("or"),conditions:je(nf)});function Ow(e){return b(Array.isArray(e)&&e.length>=1),e}var Gf=f.tuple([f.string()]).concat(f.array(f.string())),Dk=re({parentField:Gf,childField:Gf}),_k=re({correlation:Dk,hidden:f.boolean().optional(),system:Ae("permissions","client","test").optional()}),Pw=_k.extend({subquery:f.lazy(()=>Yu)}),Yu=re({schema:f.string().optional(),table:f.string(),alias:f.string().optional(),where:nf.optional(),related:je(Pw).optional(),limit:f.number().optional(),orderBy:dk.optional(),start:f.object({row:Xu,exclusive:f.boolean()}).optional()});function Ml(e,t){var c;const{tableName:n,columnName:s}=t,i=h=>s(e.table,h),o=(h,m)=>{const y=m.map(w=>s(h,w));return Ow(y)},a=e.where?t.where(e.where):void 0;return{schema:e.schema,table:n(e.table),alias:e.alias,where:a?sf(a,e.table,t):void 0,related:e.related?t.related(e.related.map(h=>({correlation:{parentField:o(e.table,h.correlation.parentField),childField:o(h.subquery.table,h.correlation.childField)},hidden:h.hidden,subquery:Ml(h.subquery,t),system:h.system}))):void 0,start:e.start?{...e.start,row:Object.fromEntries(Object.entries(e.start.row).map(([h,m])=>[i(h),m]))}:void 0,limit:e.limit,orderBy:(c=e.orderBy)==null?void 0:c.map(([h,m])=>[i(h),m])}}function sf(e,t,n){const{columnName:s}=n,i=a=>a.type!=="column"?a:{...a,name:s(t,a.name)},o=(a,u)=>{const c=u.map(h=>s(a,h));return Ow(c)};if(e.type==="simple")return{...e,left:i(e.left)};if(e.type==="correlatedSubquery"){const{correlation:a,subquery:u}=e.related;return{...e,related:{...e.related,correlation:{parentField:o(t,a.parentField),childField:o(u.table,a.childField)},subquery:Ml(u,n)}}}return{type:e.type,conditions:n.conditions(e.conditions.map(a=>sf(a,t,n)))}}var Bf=new WeakMap,Ek={tableName:e=>e,columnName:(e,t)=>t,related:Mk,where:gh,conditions:e=>e.sort(Aw)};function vh(e){let t=Bf.get(e);return t||(t=Ml(e,Ek),Bf.set(e,t)),t}function xk(e,t){return Ml(e,{tableName:n=>t.tableName(n),columnName:(n,s)=>t.columnName(n,s),related:n=>n,where:n=>n,conditions:n=>n})}function Nk(e,t,n){return sf(e,t,{tableName:s=>n.tableName(s),columnName:(s,i)=>n.columnName(s,i),related:s=>s,where:s=>s,conditions:s=>s})}function Mk(e){return e.sort(Lw)}function Aw(e,t){if(e.type==="simple")return t.type!=="simple"?-1:Uf(e.left,t.left)||$l(e.op,t.op)||Uf(e.right,t.right);if(t.type==="simple")return 1;if(e.type==="correlatedSubquery")return t.type!=="correlatedSubquery"?-1:Lw(e.related,t.related)||$l(e.op,t.op);if(t.type==="correlatedSubquery")return-1;const n=$l(e.type,t.type);if(n!==0)return n;for(let s=0,i=0;s<e.conditions.length&&i<t.conditions.length;s++,i++){const o=Aw(e.conditions[s],t.conditions[i]);if(o!==0)return o}return e.conditions.length-t.conditions.length}function Uf(e,t){if(e.type!==t.type)return Ye(e.type,t.type);switch(e.type){case"literal":return b(t.type==="literal"),Ye(String(e.value),String(t.value));case"column":return b(t.type==="column"),Ye(e.name,t.name);case"static":throw new Error("Static parameters should be resolved before normalization")}}function Lw(e,t){return Ye(H(e.subquery.alias),H(t.subquery.alias))}function gh(e){if(e.type==="simple"||e.type==="correlatedSubquery")return e;const t=ok(e.conditions.flatMap(n=>n.type===e.type?n.conditions.map(s=>gh(s)):gh(n)));switch(t.length){case 0:return;case 1:return t[0];default:return{type:e.type,conditions:t}}}function $l(e,t){return e!==null&&t!==null?Ye(e,t):t!==null?-1:e!==null?1:0}var Rk=f.object({clientID:f.string(),queryID:f.string(),ast:Yu,got:f.boolean(),deleted:f.boolean(),ttl:f.number(),inactivatedAt:f.number().nullable(),rowCount:f.number()}),Tk=f.object({op:f.literal("queries"),id:f.string(),value:f.array(Rk)}),Ok=f.union(Tk),Pk=f.tuple([f.literal("inspect"),Ok]);function Hw(e){if(e===null)throw new TypeError("array cannot be null");for(let t=0;t<e.length;t++)e[t]=Math.floor(Math.random()*256);return e}function Fw(e=21){return Hw(new Uint8Array(e)).reduce((n,s)=>(s&=63,s<36?n+=s.toString(36):s<62?n+=(s-26).toString(36).toUpperCase():s>62?n+="-":n+="_",n),"")}var rf=e=>zw(e,2),Ak=e=>zw(e,4);function zw(e,t){let n=0n;for(let s=0;s<t;s++)n=(n<<32n)+BigInt(RS(e,s));return n}var Rl=f.tuple([f.string()]).concat(f.array(f.string())),bh=f.union(f.string(),f.number(),f.boolean()),of=Qu(bh),$w="d/",Sh="g/",Tn="e/";function Lk(e,t){return $w+e+"/"+t}function Hk(e){return $w+e+"/"}function Fk(e){return Sh+e}function Ms(e,t,n){if(t.length===1)return Tn+e+"/"+Ct(n[t[0]],bh);const s=t.map(a=>Ct(n[a],bh)),i=JSON.stringify(s),o=Ak(i);return Tn+e+"/"+o}function zk(e){const t=e.indexOf("/",Tn.length);return e.slice(Tn.length,t)}function Kf(e){return e.length===1}function qf(e){return e.length===2}var Qf=new WeakMap;function kh(e){const t=vh(e),n=Qf.get(t);if(n)return n;const s=rf(JSON.stringify(t)).toString(36);return Qf.set(t,s),s}function Jf(e,t){const n=JSON.stringify(t);return rf(`${e}:${n}`).toString(36)}var Zu={push(e){throw new Error("Output not set")},filter(e,t){throw new Error("Output not set")}},Wt,Gn,tm,$k=(tm=class{constructor(e){l(this,Wt);l(this,Gn,Zu);d(this,Wt,e),e.setOutput(this)}setFilterOutput(e){d(this,Gn,e)}destroy(){r(this,Wt).destroy()}getSchema(){return r(this,Wt).getSchema()}push(e){r(this,Gn).push(e)}*fetch(e){for(const t of r(this,Wt).fetch(e))r(this,Gn).filter(t,!1)&&(yield t)}*cleanup(e){for(const t of r(this,Wt).cleanup(e))r(this,Gn).filter(t,!0)?yield t:ef(t)}},Wt=new WeakMap,Gn=new WeakMap,tm),Ws,ei,Ro,nm,Vk=(nm=class{constructor(e,t){l(this,Ws);l(this,ei);l(this,Ro,Zu);d(this,Ws,e),d(this,ei,t),t.setFilterOutput(this)}*fetch(e){for(const t of r(this,Ws).fetch(e))yield t}*cleanup(e){for(const t of r(this,Ws).cleanup(e))yield t}filter(e,t){return!0}setOutput(e){d(this,Ro,e)}destroy(){r(this,ei).destroy()}getSchema(){return r(this,ei).getSchema()}push(e){r(this,Ro).push(e)}},Ws=new WeakMap,ei=new WeakMap,Ro=new WeakMap,nm);function jk(e,t){const n=new $k(e);return new Vk(n,t(n))}var af={push(e){throw new Error("Output not set")}};function*vc(e,t){if(t<1)return;let n=0;for(const s of e)if(yield s,++n===t)break}function io(e){var s;const t=e[Symbol.iterator](),{value:n}=t.next();return(s=t.return)==null||s.call(t),n}var ct,en,tn,Bn,To,ti,lt,Un,A,Ih,js,ro,oo,Ch,Vw,gc,Dh,bc,_h,sm,Gk=(sm=class{constructor(e,t,n,s,i){l(this,A);l(this,ct);l(this,en);l(this,tn);l(this,Bn);l(this,To);l(this,ti);l(this,lt,Zu);l(this,Un,!1);d(this,ct,e),d(this,en,n),r(this,ct).setFilterOutput(this),d(this,tn,t),b(r(this,ct).getSchema().relationships[n],`Input schema missing ${n}`),d(this,Bn,i==="NOT EXISTS"),d(this,To,s),d(this,ti,ak(s,r(this,ct).getSchema().primaryKey))}setFilterOutput(e){d(this,lt,e)}filter(e,t){const n=p(this,A,Ih).call(this,e)&&r(this,lt).filter(e,t);return t&&p(this,A,Ch).call(this,e),n}destroy(){r(this,ct).destroy()}getSchema(){return r(this,ct).getSchema()}push(e){b(!r(this,Un),"Unexpected re-entrancy"),d(this,Un,!0);try{switch(e.type){case"add":case"edit":{p(this,A,js).call(this,e);return}case"remove":{const t=p(this,A,ro).call(this,e.node);if(t===void 0)return;p(this,A,js).call(this,e,t),p(this,A,Ch).call(this,e.node);return}case"child":if(e.child.relationshipName!==r(this,en)||e.child.change.type==="edit"||e.child.change.type==="child"){p(this,A,js).call(this,e);return}switch(e.child.change.type){case"add":{let t=p(this,A,ro).call(this,e.node);t!==void 0?(t++,p(this,A,oo).call(this,e.node,t)):t=p(this,A,gc).call(this,e.node),t===1?r(this,Bn)?r(this,lt).push({type:"remove",node:{row:e.node.row,relationships:{...e.node.relationships,[r(this,en)]:()=>[]}}}):r(this,lt).push({type:"add",node:e.node}):p(this,A,js).call(this,e,t);return}case"remove":{let t=p(this,A,ro).call(this,e.node);t!==void 0?(b(t>0),t--,p(this,A,oo).call(this,e.node,t)):t=p(this,A,gc).call(this,e.node),t===0?r(this,Bn)?r(this,lt).push({type:"add",node:e.node}):r(this,lt).push({type:"remove",node:{row:e.node.row,relationships:{...e.node.relationships,[r(this,en)]:()=>[e.child.change.node]}}}):p(this,A,js).call(this,e,t);return}}return;default:we(e)}}finally{d(this,Un,!1)}}},ct=new WeakMap,en=new WeakMap,tn=new WeakMap,Bn=new WeakMap,To=new WeakMap,ti=new WeakMap,lt=new WeakMap,Un=new WeakMap,A=new WeakSet,Ih=function(e,t){const n=(t??p(this,A,Vw).call(this,e))>0;return r(this,Bn)?!n:n},js=function(e,t){p(this,A,Ih).call(this,e.node,t)&&r(this,lt).push(e)},ro=function(e){return r(this,tn).get(p(this,A,bc).call(this,e))},oo=function(e,t){r(this,tn).set(p(this,A,bc).call(this,e),t)},Ch=function(e){r(this,tn).del(p(this,A,bc).call(this,e))},Vw=function(e){const t=p(this,A,ro).call(this,e);return t!==void 0?t:p(this,A,gc).call(this,e)},gc=function(e){if(!r(this,ti)&&!r(this,Un)){const s=io(r(this,tn).scan({prefix:p(this,A,Dh).call(this,e)}));if(s!==void 0)return p(this,A,oo).call(this,e,s[1]),s[1]}const t=e.relationships[r(this,en)];b(t);let n=0;for(const s of t())n++;return p(this,A,oo).call(this,e,n),n},Dh=function(e){return`row/${r(this,ti)?"":JSON.stringify(p(this,A,_h).call(this,e,r(this,To)))}/`},bc=function(e){return`${p(this,A,Dh).call(this,e)}${JSON.stringify(p(this,A,_h).call(this,e,r(this,ct).getSchema().primaryKey))}`},_h=function(e,t){const n=[];for(const s of t)n.push(wh(e.row[s]));return n},sm),ni,si,Be,nn,im,Bk=(im=class{constructor(e,t){l(this,ni);l(this,si);l(this,Be,Zu);l(this,nn,[]);d(this,ni,t),d(this,si,e.getSchema());for(const n of t)n.setFilterOutput(this),b(r(this,si)===n.getSchema(),"Schema mismatch in fan-in")}setFilterOutput(e){d(this,Be,e)}destroy(){for(const e of r(this,ni))e.destroy()}getSchema(){return r(this,si)}filter(e,t){return r(this,Be).filter(e,t)}push(e){r(this,nn).push(e)}fanOutDonePushingToAllBranches(e){if(r(this,ni).length===0){b(r(this,nn).length===0,"If there are no inputs then fan-in should not receive any pushes.");return}if(r(this,nn).length===0)return;const t=new Map;for(const s of r(this,nn))e==="child"&&s.type!=="child"&&b(t.has(s.type)===!1,()=>`Fan-in:child expected at most one ${s.type} when fan-out is of type child`),t.set(s.type,s);d(this,nn,[]);const n=[...t.keys()];switch(e){case"remove":b(n.length===1&&n[0]==="remove","Fan-in:remove expected all removes"),r(this,Be).push(H(t.get("remove")));return;case"add":b(n.length===1&&n[0]==="add","Fan-in:add expected all adds"),r(this,Be).push(H(t.get("add")));return;case"edit":{b(n.every(a=>a==="add"||a==="remove"||a==="edit"),"Fan-in:edit expected all adds, removes, or edits");const s=t.get("add"),i=t.get("remove"),o=t.get("edit");if(o){r(this,Be).push(o);return}if(s&&i){r(this,Be).push({type:"edit",node:s.node,oldNode:i.node});return}r(this,Be).push(H(s??i));return}case"child":{b(n.every(a=>a==="add"||a==="remove"||a==="child"),"Fan-in:child expected all adds, removes, or children"),b(n.length<=2,"Fan-in:child expected at most 2 types on a child change from fan-out");const s=t.get("child");if(s){r(this,Be).push(s);return}const i=t.get("add"),o=t.get("remove");b(i===void 0||o===void 0,"Fan-in:child expected either add or remove, not both"),r(this,Be).push(H(i??o));return}}}},ni=new WeakMap,si=new WeakMap,Be=new WeakMap,nn=new WeakMap,im),ii,Kn,Oo,ri,rm,Uk=(rm=class{constructor(e){l(this,ii);l(this,Kn,[]);l(this,Oo);l(this,ri,0);d(this,ii,e),e.setFilterOutput(this)}setFanIn(e){d(this,Oo,e)}setFilterOutput(e){r(this,Kn).push(e)}destroy(){if(r(this,ri)<r(this,Kn).length)r(this,ri)===0&&r(this,ii).destroy(),++Et(this,ri)._;else throw new Error("FanOut already destroyed once for each output")}getSchema(){return r(this,ii).getSchema()}filter(e,t){let n=!1;for(const s of r(this,Kn))if(n=s.filter(e,t)||n,!t&&n)return!0;return n}push(e){for(const t of r(this,Kn))t.push(e);H(r(this,Oo),"fan-out must have a corresponding fan-in set!").fanOutDonePushingToAllBranches(e.type)}},ii=new WeakMap,Kn=new WeakMap,Oo=new WeakMap,ri=new WeakMap,rm);function jw(e,t,n){const s=t(e.oldNode.row),i=t(e.node.row);s&&i?n.push(e):s&&!i?n.push({type:"remove",node:e.oldNode}):!s&&i&&n.push({type:"add",node:e.node})}function Sc(e,t,n){if(!n){t.push(e);return}switch(e.type){case"add":case"remove":n(e.node.row)&&t.push(e);break;case"child":n(e.node.row)&&t.push(e);break;case"edit":jw(e,n,t);break;default:we()}}var oi,ai,ui,om,Do=(om=class{constructor(e,t){l(this,oi);l(this,ai);l(this,ui,Zu);d(this,oi,e),d(this,ai,t),e.setFilterOutput(this)}filter(e,t){return r(this,ai).call(this,e.row)&&r(this,ui).filter(e,t)}setFilterOutput(e){d(this,ui,e)}destroy(){r(this,oi).destroy()}getSchema(){return r(this,oi).getSchema()}push(e){Sc(e,r(this,ui),r(this,ai))}},oi=new WeakMap,ai=new WeakMap,ui=new WeakMap,om),ht,We,qn,Ue,sn,ci,li,Mt,et,ee,Gw,Bw,Eh,xt,Uw,am,Kk=(am=class{constructor({parent:e,child:t,storage:n,parentKey:s,childKey:i,relationshipName:o,hidden:a,system:u}){l(this,ee);l(this,ht);l(this,We);l(this,qn);l(this,Ue);l(this,sn);l(this,ci);l(this,li);l(this,Mt,af);l(this,et);b(e!==t,"Parent and child must be different operators"),b(s.length===i.length,"The parentKey and childKey keys must have same length"),d(this,ht,e),d(this,We,t),d(this,qn,n),d(this,Ue,s),d(this,sn,i),d(this,ci,o);const c=e.getSchema(),h=t.getSchema();d(this,li,{...c,relationships:{...c.relationships,[o]:{...h,isHidden:a,system:u}}}),e.setOutput({push:m=>p(this,ee,Gw).call(this,m)}),t.setOutput({push:m=>p(this,ee,Bw).call(this,m)})}destroy(){r(this,ht).destroy(),r(this,We).destroy()}setOutput(e){d(this,Mt,e)}getSchema(){return r(this,li)}*fetch(e){for(const t of r(this,ht).fetch(e))yield p(this,ee,xt).call(this,t.row,t.relationships,"fetch")}*cleanup(e){for(const t of r(this,ht).cleanup(e))yield p(this,ee,xt).call(this,t.row,t.relationships,"cleanup")}},ht=new WeakMap,We=new WeakMap,qn=new WeakMap,Ue=new WeakMap,sn=new WeakMap,ci=new WeakMap,li=new WeakMap,Mt=new WeakMap,et=new WeakMap,ee=new WeakSet,Gw=function(e){switch(e.type){case"add":r(this,Mt).push({type:"add",node:p(this,ee,xt).call(this,e.node.row,e.node.relationships,"fetch")});break;case"remove":r(this,Mt).push({type:"remove",node:p(this,ee,xt).call(this,e.node.row,e.node.relationships,"cleanup")});break;case"child":r(this,Mt).push({type:"child",node:p(this,ee,xt).call(this,e.node.row,e.node.relationships,"fetch"),child:e.child});break;case"edit":{b(Yf(e.oldNode.row,e.node.row,r(this,Ue)),"Parent edit must not change relationship."),r(this,Mt).push({type:"edit",oldNode:p(this,ee,xt).call(this,e.oldNode.row,e.oldNode.relationships,"cleanup"),node:p(this,ee,xt).call(this,e.node.row,e.node.relationships,"fetch")});break}default:we()}},Bw=function(e){const t=(n,s)=>{d(this,et,{change:s,position:void 0});try{const i=r(this,ht).fetch({constraint:Object.fromEntries(r(this,Ue).map((o,a)=>[o,n[r(this,sn)[a]]]))});for(const o of i){r(this,et).position=o.row;const a={type:"child",node:p(this,ee,xt).call(this,o.row,o.relationships,"fetch"),child:{relationshipName:r(this,ci),change:s}};r(this,Mt).push(a)}}finally{d(this,et,void 0)}};switch(e.type){case"add":case"remove":t(e.node.row,e);break;case"child":t(e.node.row,e);break;case"edit":{const n=e.node.row,s=e.oldNode.row;b(Yf(s,n,r(this,sn)),"Child edit must not change relationship."),t(n,e);break}default:we()}},Eh=function*(e,t){let n=!1,s=!1,i=!1;for(const o of e){let a=!0;if(!n)switch(t.type){case"add":{r(this,We).getSchema().compareRows(t.node.row,o.row)===0&&(n=!0,a=!1);break}case"remove":{r(this,We).getSchema().compareRows(t.node.row,o.row)<0&&(n=!0,yield t.node);break}case"edit":{r(this,We).getSchema().compareRows(t.oldNode.row,o.row)<0&&(s=!0,i&&(n=!0),yield t.oldNode),r(this,We).getSchema().compareRows(t.node.row,o.row)===0&&(i=!0,s&&(n=!0),a=!1);break}case"child":{r(this,We).getSchema().compareRows(t.node.row,o.row)===0&&(n=!0,yield{row:o.row,relationships:{...o.relationships,[t.child.relationshipName]:()=>p(this,ee,Eh).call(this,o.relationships[t.child.relationshipName](),t.child.change)}},a=!1);break}}a&&(yield o)}n||(t.type==="remove"?(n=!0,yield t.node):t.type==="edit"&&(b(i),s=!0,n=!0,yield t.oldNode)),b(n)},xt=function(e,t,n){let s=n,i=!1;const o=()=>{i||(n==="cleanup"&&(r(this,qn).del(Xf(r(this,Ue),r(this,ht).getSchema().primaryKey,e)),s=[...vc(r(this,qn).scan({prefix:qk(e,r(this,Ue))}),1)].length===0?"cleanup":"fetch"),i=!0,n==="fetch"&&r(this,qn).set(Xf(r(this,Ue),r(this,ht).getSchema().primaryKey,e),!0));const a=r(this,We)[s]({constraint:Object.fromEntries(r(this,sn).map((u,c)=>[u,e[r(this,Ue)[c]]]))});return r(this,et)&&p(this,ee,Uw).call(this,e,r(this,et).change.node.row)&&r(this,et).position&&r(this,li).compareRows(e,r(this,et).position)>0?p(this,ee,Eh).call(this,a,r(this,et).change):a};return{row:e,relationships:{...t,[r(this,ci)]:o}}},Uw=function(e,t){for(let n=0;n<r(this,Ue).length;n++)if(!Wd(e[r(this,Ue)[n]],t[r(this,sn)[n]]))return!1;return!0},am);function Kw(e){const t=JSON.stringify(["pKeySet",...e]);return t.substring(1,t.length-1)+","}function qk(e,t){return Kw(t.map(n=>e[n]))}function Xf(e,t,n){const s=e.map(i=>n[i]);for(const i of t)s.push(n[i]);return Kw(s)}function Yf(e,t,n){for(let s=0;s<n.length;s++)if(Nl(e[n[s]],t[n[s]])!==0)return!1;return!0}var Qn,Ke,hi,di,Dt,xh,Nh,qw,um,Qk=(um=class{constructor(e,t){l(this,Dt);l(this,Qn);l(this,Ke);l(this,hi);l(this,di,af);d(this,Qn,e),d(this,Ke,t),d(this,hi,e.getSchema().compareRows),e.setOutput(this)}getSchema(){return r(this,Qn).getSchema()}fetch(e){return p(this,Dt,xh).call(this,"fetch",e)}cleanup(e){return p(this,Dt,xh).call(this,"fetch",e)}setOutput(e){d(this,di,e)}destroy(){r(this,Qn).destroy()}push(e){const t=n=>p(this,Dt,Nh).call(this,n);if(e.type==="edit"){jw(e,t,r(this,di));return}t(e.node.row)&&r(this,di).push(e)}},Qn=new WeakMap,Ke=new WeakMap,hi=new WeakMap,di=new WeakMap,Dt=new WeakSet,xh=function*(e,t){const n=p(this,Dt,qw).call(this,t);if(n==="empty")return;const s=r(this,Qn)[e]({...t,start:n});if(!t.reverse){yield*s;return}for(const i of s){if(!p(this,Dt,Nh).call(this,i.row))return;yield i}},Nh=function(e){const t=r(this,hi).call(this,r(this,Ke).row,e);return t<0||t===0&&!r(this,Ke).exclusive},qw=function(e){const t={row:r(this,Ke).row,basis:r(this,Ke).exclusive?"after":"at"};if(!e.start)return e.reverse?void 0:t;const n=r(this,hi).call(this,r(this,Ke).row,e.start.row);return e.reverse?(e.reverse,n>0?"empty":n===0?!r(this,Ke).exclusive&&e.start.basis==="at"?t:"empty":e.start):n>0?t:n===0?r(this,Ke).exclusive||e.start.basis==="after"?{row:r(this,Ke).row,basis:"after"}:t:e.start},um),ic="maxBound",ne,Ee,dt,be,fi,Jn,W,K,Qw,Mh,Jw,Rh,Ze,cm,Jk=(cm=class{constructor(e,t,n,s){l(this,K);l(this,ne);l(this,Ee);l(this,dt);l(this,be);l(this,fi);l(this,Jn);l(this,W,af);b(n>=0),Ph(e.getSchema().sort,e.getSchema().primaryKey),e.setOutput(this),d(this,ne,e),d(this,Ee,t),d(this,dt,n),d(this,be,s),d(this,fi,s&&Xk(s))}setOutput(e){d(this,W,e)}getSchema(){return r(this,ne).getSchema()}*fetch(e){if(!r(this,be)||e.constraint&&Vl(e.constraint,r(this,be))){const n=Wr(r(this,be),e.constraint),s=r(this,Ee).get(n);if(!s){yield*p(this,K,Qw).call(this,e);return}if(s.bound===void 0)return;for(const i of r(this,ne).fetch(e)){if(this.getSchema().compareRows(s.bound,i.row)<0)return;r(this,Jn)&&this.getSchema().compareRows(r(this,Jn),i.row)===0||(yield i)}return}const t=r(this,Ee).get(ic);if(t!==void 0)for(const n of r(this,ne).fetch(e)){if(this.getSchema().compareRows(n.row,t)>0)return;const s=Wr(r(this,be),n.row),i=r(this,Ee).get(s);(i==null?void 0:i.bound)!==void 0&&this.getSchema().compareRows(i.bound,n.row)>=0&&(yield n)}}*cleanup(e){b(e.start===void 0),b(Vl(e.constraint,r(this,be)));const t=Wr(r(this,be),e.constraint);r(this,Ee).del(t);let n=0;for(const s of r(this,ne).cleanup(e)){if(n===r(this,dt))return;n++,yield s}}push(e){if(e.type==="edit"){p(this,K,Jw).call(this,e);return}const{takeState:t,takeStateKey:n,maxBound:s,constraint:i}=p(this,K,Mh).call(this,e.node.row);if(!t)return;const{compareRows:o}=this.getSchema();if(e.type==="add"){if(t.size<r(this,dt)){p(this,K,Ze).call(this,n,t.size+1,t.bound===void 0||o(t.bound,e.node.row)<0?e.node.row:t.bound,s),r(this,W).push(e);return}if(t.bound===void 0||o(e.node.row,t.bound)>=0)return;let a,u;r(this,dt)===1?u=H(io(r(this,ne).fetch({start:{row:t.bound,basis:"at"},constraint:i}))):[u,a]=vc(r(this,ne).fetch({start:{row:t.bound,basis:"at"},constraint:i,reverse:!0}),2);const c={type:"remove",node:u};p(this,K,Ze).call(this,n,t.size,a===void 0||o(e.node.row,a.row)>0?e.node.row:a.row,s),p(this,K,Rh).call(this,e.node.row,()=>{r(this,W).push(c)}),r(this,W).push(e)}else if(e.type==="remove"){if(t.bound===void 0||o(e.node.row,t.bound)>0)return;const[u]=vc(r(this,ne).fetch({start:{row:t.bound,basis:"after"},constraint:i,reverse:!0}),1);let c;if(u){const h=o(u.row,t.bound)>0;c={node:u,push:h}}if(!(c!=null&&c.push))for(const h of r(this,ne).fetch({start:{row:t.bound,basis:"at"},constraint:i})){const m=o(h.row,t.bound)>0;if(c={node:h,push:m},m)break}if(c!=null&&c.push){r(this,W).push(e),p(this,K,Ze).call(this,n,t.size,c.node.row,s),r(this,W).push({type:"add",node:c.node});return}p(this,K,Ze).call(this,n,t.size-1,c==null?void 0:c.node.row,s),r(this,W).push(e)}else e.type==="child"&&t.bound&&o(e.node.row,t.bound)<=0&&r(this,W).push(e)}destroy(){r(this,ne).destroy()}},ne=new WeakMap,Ee=new WeakMap,dt=new WeakMap,be=new WeakMap,fi=new WeakMap,Jn=new WeakMap,W=new WeakMap,K=new WeakSet,Qw=function*(e){if(b(e.start===void 0),b(!e.reverse),b(Vl(e.constraint,r(this,be))),r(this,dt)===0)return;const t=Wr(r(this,be),e.constraint);b(r(this,Ee).get(t)===void 0);let n=0,s,i=!0,o=!1;try{for(const a of r(this,ne).fetch(e))if(yield a,s=a.row,n++,n===r(this,dt))break;i=!1}catch(a){throw o=!0,a}finally{o||(p(this,K,Ze).call(this,t,n,s,r(this,Ee).get(ic)),b(!i,"Unexpected early return prevented full hydration"))}},Mh=function(e){const t=Wr(r(this,be),e),n=r(this,Ee).get(t);let s,i;return n&&(s=r(this,Ee).get(ic),i=r(this,be)&&Object.fromEntries(r(this,be).map(o=>[o,e[o]]))),{takeState:n,takeStateKey:t,maxBound:s,constraint:i}},Jw=function(e){b(!r(this,fi)||r(this,fi).call(this,e.oldNode.row,e.node.row)===0,"Unexpected change of partition key");const{takeState:t,takeStateKey:n,maxBound:s,constraint:i}=p(this,K,Mh).call(this,e.oldNode.row);if(!t)return;b(t.bound,"Bound should be set");const{compareRows:o}=this.getSchema(),a=o(e.oldNode.row,t.bound),u=o(e.node.row,t.bound),c=()=>{p(this,K,Ze).call(this,n,t.size,e.node.row,s),r(this,W).push(e)};if(a===0){if(u===0){r(this,W).push(e);return}if(u<0){if(r(this,dt)===1){c();return}const m=H(io(r(this,ne).fetch({start:{row:t.bound,basis:"after"},constraint:i,reverse:!0})));p(this,K,Ze).call(this,n,t.size,m.row,s),r(this,W).push(e);return}b(u>0);const h=H(io(r(this,ne).fetch({start:{row:t.bound,basis:"at"},constraint:i})));if(o(h.row,e.node.row)===0){c();return}p(this,K,Ze).call(this,n,t.size,h.row,s),r(this,W).push({type:"add",node:h});return}if(a>0){if(b(u!==0,"Invalid state. Row has duplicate primary key"),u>0)return;b(u<0);const[h,m]=vc(r(this,ne).fetch({start:{row:t.bound,basis:"at"},constraint:i,reverse:!0}),2);p(this,K,Ze).call(this,n,t.size,m.row,s),p(this,K,Rh).call(this,e.node.row,()=>{r(this,W).push({type:"remove",node:h})}),r(this,W).push({type:"add",node:e.node});return}if(a<0){if(b(u!==0,"Invalid state. Row has duplicate primary key"),u<0){r(this,W).push(e);return}b(u>0);const h=H(io(r(this,ne).fetch({start:{row:t.bound,basis:"after"},constraint:i})));if(o(h.row,e.node.row)===0){c();return}r(this,W).push({type:"remove",node:e.oldNode}),p(this,K,Ze).call(this,n,t.size,h.row,s),r(this,W).push({type:"add",node:h});return}we()},Rh=function(e,t){d(this,Jn,e);try{t()}finally{d(this,Jn,void 0)}},Ze=function(e,t,n,s){r(this,Ee).set(e,{size:t,bound:n}),n!==void 0&&(s===void 0||this.getSchema().compareRows(n,s)>0)&&r(this,Ee).set(ic,n)},cm);function Wr(e,t){const n=[];if(e&&t)for(const s of e)n.push(t[s]);return JSON.stringify(["take",...n])}function Vl(e,t){if(e===void 0||t===void 0)return e===t;if(t.length!==Object.keys(e).length)return!1;for(const n of t)if(!Ps(e,n))return!1;return!0}function Xk(e){return(t,n)=>{for(const s of e){const i=Nl(t[s],n[s]);if(i!==0)return i}return 0}}var Po,lm,Xw=(lm=class{constructor(e){l(this,Po);v(this,"and",Yw);v(this,"or",Yk);v(this,"not",Th);v(this,"exists",(e,t)=>r(this,Po).call(this,e,t));d(this,Po,e),this.exists=this.exists.bind(this)}get eb(){return this}cmp(e,t,n){return Zw(e,t,n)}cmpLit(e,t,n){return{type:"simple",left:Oh(e)?e[xn]():{type:"literal",value:e},right:Oh(n)?n[xn]():{type:"literal",value:n},op:t}}},Po=new WeakMap,lm);function Yw(...e){const t=tI(tv(e));return t.length===1?t[0]:t.some(cf)?ev:{type:"and",conditions:t}}function Yk(...e){const t=nI(tv(e));return t.length===1?t[0]:t.some(uf)?Ww:{type:"or",conditions:t}}function Th(e){switch(e.type){case"and":return{type:"or",conditions:e.conditions.map(Th)};case"or":return{type:"and",conditions:e.conditions.map(Th)};case"correlatedSubquery":return{type:"correlatedSubquery",related:e.related,op:Zf(e.op)};case"simple":return{type:"simple",op:Zf(e.op),left:e.left,right:e.right}}}function Zw(e,t,n){let s;return n===void 0?(n=t,s="="):s=t,{type:"simple",left:{type:"column",name:e},right:Oh(n)?n[xn]():{type:"literal",value:n},op:s}}function Oh(e){return e!==null&&typeof e=="object"&&e[xn]}var Ww={type:"and",conditions:[]},ev={type:"or",conditions:[]};function uf(e){return e.type==="and"&&e.conditions.length===0}function cf(e){return e.type==="or"&&e.conditions.length===0}function Qc(e){if(e.type==="simple"||e.type==="correlatedSubquery")return e;if(e.conditions.length===1)return Qc(e.conditions[0]);const t=Zk(e.type,e.conditions.map(Qc));return e.type==="and"&&t.some(cf)?ev:e.type==="or"&&t.some(uf)?Ww:{type:e.type,conditions:t}}function Zk(e,t){const n=[];for(const s of t)s.type===e?n.push(...s.conditions):n.push(s);return n}var Wk={"=":"!=","!=":"=","<":">=",">":"<=",">=":"<","<=":">",IN:"NOT IN","NOT IN":"IN",LIKE:"NOT LIKE","NOT LIKE":"LIKE",ILIKE:"NOT ILIKE","NOT ILIKE":"ILIKE",IS:"IS NOT","IS NOT":"IS"},eI={...Wk,EXISTS:"NOT EXISTS","NOT EXISTS":"EXISTS"};function Zf(e){return H(eI[e])}function tv(e){return e.filter(t=>t!==void 0)}function tI(e){return e.filter(t=>!uf(t))}function nI(e){return e.filter(t=>!cf(t))}function rc(e,t){const n=sI(String(e),t);return s=>(J(s),n(String(s)))}function sI(e,t){if(!/_|%|\\/.test(e)){if(t==="i"){const s=e.toLowerCase();return i=>i.toLowerCase()===s}return s=>s===e}const n=rI(e,t);return s=>n.test(s)}var iI=/[$()*+.?[\]\\^{|}]/;function rI(e,t=""){let n="^";for(let s=0;s<e.length;s++){let i=e[s];switch(i){case"%":n+=".*";break;case"_":n+=".";break;case"\\":if(s===e.length-1)throw new Error("LIKE pattern must not end with escape character");s++,i=e[s];default:iI.test(i)&&(n+="\\"),n+=i;break}}return new RegExp(n+"$",t+"m")}function _o(e){if(e.type!=="simple"){const i=e.conditions.map(o=>_o(o));return e.type==="and"?o=>{for(const a of i)if(!a(o))return!1;return!0}:o=>{for(const a of i)if(a(o))return!0;return!1}}const{left:t}=e,{right:n}=e;switch(b(n.type!=="static","static values should be resolved before creating predicates"),b(t.type!=="static","static values should be resolved before creating predicates"),e.op){case"IS":case"IS NOT":{const i=oI(n.value,e.op);if(t.type==="literal"){const o=i(t.value);return()=>o}return o=>i(o[t.name])}}if(n.value===null||n.value===void 0)return i=>!1;const s=aI(n.value,e.op);if(t.type==="literal"){if(t.value===null||t.value===void 0)return o=>!1;const i=s(t.value);return()=>i}return i=>{const o=i[t.name];return o==null?!1:s(o)}}function oI(e,t){switch(t){case"IS":return n=>n===e;case"IS NOT":return n=>n!==e}}function aI(e,t){switch(t){case"=":return n=>n===e;case"!=":return n=>n!==e;case"<":return n=>n<e;case"<=":return n=>n<=e;case">":return n=>n>e;case">=":return n=>n>=e;case"LIKE":return rc(e,"");case"NOT LIKE":return Wf(rc(e,""));case"ILIKE":return rc(e,"i");case"NOT ILIKE":return Wf(rc(e,"i"));case"IN":{b(Array.isArray(e));const n=new Set(e);return s=>n.has(s)}case"NOT IN":{b(Array.isArray(e));const n=new Set(e);return s=>!n.has(s)}default:throw new Error(`Unexpected operator: ${t}`)}}function Wf(e){return t=>!e(t)}function nv(e){if(!e)return{filters:void 0,conditionsRemoved:!1};switch(e.type){case"simple":return{filters:e,conditionsRemoved:!1};case"correlatedSubquery":return{filters:void 0,conditionsRemoved:!0};case"and":case"or":{const t=[];let n=!1;for(const s of e.conditions){const i=nv(s);if(i.filters===void 0&&e.type==="or")return{filters:void 0,conditionsRemoved:!0};n=n||i.conditionsRemoved,i.filters&&t.push(i.filters)}return{filters:Qc({type:e.type,conditions:t}),conditionsRemoved:n}}default:we()}}function uI(e,t){return sv(t.mapAst?t.mapAst(e):e,t,"")}function sv(e,t,n,s){const i=t.getSource(e.table);if(!i)throw new Error(`Source not found: ${e.table}`);e=vI(e);const o=mI(e.where),a=s?new Set(s):new Set,u=new Set;for(const y of o){u.add(y.subquery.alias||"");for(const w of y.correlation.parentField)a.add(w)}if(e.related)for(const y of e.related)for(const w of y.correlation.parentField)a.add(w);const c=i.connect(H(e.orderBy),e.where,a);let h=t.decorateInput(c,`${n}:source(${e.table})`);const{fullyAppliedFilters:m}=c;e.start&&(h=t.decorateInput(new Qk(h,e.start),`${n}:skip)`));for(const y of o)h=ep(y,t,h,n,!0);if(e.where&&!m&&(h=cI(h,e.where,t,n)),e.limit!==void 0){const y=`${n}:take`;h=t.decorateInput(new Jk(h,t.createStorage(y),e.limit,s),y)}if(e.related)for(const y of e.related)h=ep(y,t,h,n,!1);return h}function cI(e,t,n,s){return jk(e,i=>lf(i,t,n,s))}function lf(e,t,n,s){switch(t.type){case"and":return lI(e,t,n,s);case"or":return hI(e,t,n,s);case"correlatedSubquery":return pI(e,t,n,s);case"simple":return fI(e,t)}}function lI(e,t,n,s){for(const i of t.conditions)e=lf(e,i,n,s);return e}function hI(e,t,n,s){const[i,o]=dI(t);if(i.length===0)return new Do(e,_o({type:"or",conditions:o}));const a=new Uk(e),u=i.map(h=>lf(a,h,n,s));o.length>0&&u.push(new Do(a,_o({type:"or",conditions:o})));const c=new Bk(a,u);return a.setFanIn(c),c}function dI(e){const t=[[],[]];for(const n of e.conditions)iv(n)?t[1].push(n):t[0].push(n);return t}function iv(e){return e.type==="correlatedSubquery"?!1:e.type==="simple"?!0:e.conditions.every(iv)}function fI(e,t){return new Do(e,_o(t))}function ep(e,t,n,s,i){if(e.subquery.limit===0&&i)return n;b(e.subquery.alias,"Subquery must have an alias");const o=sv(e.subquery,t,`${s}.${e.subquery.alias}`,e.correlation.childField),a=`${s}:join(${e.subquery.alias})`;return n=new Kk({parent:n,child:o,storage:t.createStorage(a),parentKey:e.correlation.parentField,childKey:e.correlation.childField,relationshipName:e.subquery.alias,hidden:e.hidden??!1,system:e.system??"client"}),t.decorateInput(n,a)}function pI(e,t,n,s){if(b(t.op==="EXISTS"||t.op==="NOT EXISTS"),t.related.subquery.limit===0)return t.op==="EXISTS"?new Do(e,()=>!1):new Do(e,()=>!0);const i=`${s}:exists(${t.related.subquery.alias})`;return n.decorateFilterInput(new Gk(e,n.createStorage(i),H(t.related.subquery.alias),t.related.correlation.parentField,t.op),i)}function mI(e){const t=[],n=s=>{if(s.type==="correlatedSubquery"){b(s.op==="EXISTS"||s.op==="NOT EXISTS"),t.push({...s.related,subquery:{...s.related.subquery,limit:s.related.system==="permissions"?wI:yI}});return}if(s.type==="and"||s.type==="or"){for(const i of s.conditions)n(i);return}};return e&&n(e),t}var yI=3,wI=1;function Ph(e,t){const n=e.map(([i])=>i),s=t.filter(i=>!n.includes(i));if(s.length>0)throw new Error(`Ordering must include all primary key fields. Missing: ${s.join(", ")}. ZQL automatically appends primary key fields to the ordering if they are missing 
      so a common cause of this error is a casing mismatch between Postgres and ZQL.
      E.g., "userid" vs "userID".
      You may want to add double-quotes around your Postgres column names to prevent Postgres from lower-casing them:
      https://www.postgresql.org/docs/current/sql-syntax-lexical.htm`)}function vI(e){if(!e.where)return e;const{where:t}=e;if(t.type!=="and"&&t.type!=="or")return e;let n=0;const s=a=>({...a,related:{...a.related,subquery:{...a.related.subquery,alias:(a.related.subquery.alias??"")+"_"+n++}}}),i=a=>{if(a.type==="simple")return a;if(a.type==="correlatedSubquery")return s(a);const u=[];for(const c of a.conditions)u.push(i(c));return{type:a.type,conditions:u}};return{...e,where:i(t)}}var Ao,Xn,pi,mi,Yn,Zn,yi,Lo,_t,Ah,Lh,rv,hm,gI=(hm=class{constructor(e,t,n,s){l(this,_t);l(this,Ao);l(this,Xn,new Set);l(this,pi);l(this,mi);l(this,Yn);v(this,"onDestroy");l(this,Zn,!1);l(this,yi,!1);l(this,Lo);d(this,Ao,e),d(this,pi,e.getSchema()),d(this,mi,t),d(this,Lo,s),d(this,Yn,{"":t.singular?void 0:[]}),e.setOutput(this),n===!0?d(this,yi,!0):n.then(()=>{d(this,yi,!0),p(this,_t,Ah).call(this)}),p(this,_t,rv).call(this)}get data(){return r(this,Yn)[""]}addListener(e){return b(!r(this,Xn).has(e),"Listener already registered"),r(this,Xn).add(e),p(this,_t,Lh).call(this,e),()=>{r(this,Xn).delete(e)}}destroy(){var e;(e=this.onDestroy)==null||e.call(this)}push(e){d(this,Zn,!0),zn(r(this,Yn),e,r(this,pi),"",r(this,mi))}flush(){r(this,Zn)&&(d(this,Zn,!1),p(this,_t,Ah).call(this))}updateTTL(e){r(this,Lo).call(this,e)}},Ao=new WeakMap,Xn=new WeakMap,pi=new WeakMap,mi=new WeakMap,Yn=new WeakMap,Zn=new WeakMap,yi=new WeakMap,Lo=new WeakMap,_t=new WeakSet,Ah=function(){for(const e of r(this,Xn))p(this,_t,Lh).call(this,e)},Lh=function(e){e(this.data,r(this,yi)?"complete":"unknown")},rv=function(){d(this,Zn,!0);for(const e of r(this,Ao).fetch({}))zn(r(this,Yn),{type:"add",node:e},r(this,pi),"",r(this,mi));this.flush()},hm);function Hh(e){switch(e.type){case"simple":return;case"correlatedSubquery":if(e.op==="NOT EXISTS")throw new Error("not(exists()) is not supported on the client - see https://bugs.rocicorp.dev/issue/3438");e.related.subquery.where&&Hh(e.related.subquery.where);return;case"and":case"or":for(const t of e.conditions)Hh(t);return;default:we()}}var tp=class extends Error{constructor(e){super(e),this.name="NotImplementedError"}},bI=Symbol();function hf(e,t,n){return new II(e,t,n,{table:n},Eo,void 0)}function SI(e,t){return{type:"static",anchor:e,field:t.length===1?t[0]:t}}var eo="zsubq_",Eo={singular:!1,relationships:{}},ve=Symbol(),G,ae,wi,tt,ue,Wn,dm,ov=(dm=class{constructor(e,t,n,s,i,o,a,u){l(this,G);v(this,"_delegate");l(this,ae);v(this,"_ast");v(this,"format");l(this,wi,"");l(this,tt);l(this,ue);v(this,"customQueryID");v(this,"one",()=>this[ve](this._delegate,r(this,G),r(this,ae),{...this._ast,limit:1},{...this.format,singular:!0},this.customQueryID,r(this,ue)));v(this,"whereExists",(e,t)=>this.where(({exists:n})=>n(e,t)));v(this,"related",(e,t)=>{if(e.startsWith(eo))throw new Error(`Relationship names may not start with "${eo}". That is a reserved prefix.`);t=t??(s=>s);const n=r(this,G).relationships[r(this,ae)][e];if(b(n,"Invalid relationship"),Kf(n)){const{destSchema:s,destField:i,sourceField:o,cardinality:a}=n[0];let u=this[ve](this._delegate,r(this,G),s,{table:s,alias:e},{relationships:{},singular:a==="one"},this.customQueryID,void 0);a==="one"&&(u=u.one());const c=t(u);return b(Ge(o),"The source of a relationship must specify at last 1 field"),b(Ge(i),"The destination of a relationship must specify at last 1 field"),b(o.length===i.length,"The source and destination of a relationship must have the same number of fields"),this[ve](this._delegate,r(this,G),r(this,ae),{...this._ast,related:[...this._ast.related??[],{system:r(this,tt),correlation:{parentField:o,childField:i},subquery:oc(r(this,G).tables[s],c._ast)}]},{...this.format,relationships:{...this.format.relationships,[e]:c.format}},this.customQueryID,r(this,ue))}if(qf(n)){const[s,i]=n,{destSchema:o}=i,a=s.destSchema,u=t(this[ve](this._delegate,r(this,G),o,{table:o,alias:e},{relationships:{},singular:i.cardinality==="one"},this.customQueryID,e));return b(Ge(s.sourceField),"Invalid relationship"),b(Ge(s.destField),"Invalid relationship"),b(Ge(i.sourceField),"Invalid relationship"),b(Ge(i.destField),"Invalid relationship"),this[ve](this._delegate,r(this,G),r(this,ae),{...this._ast,related:[...this._ast.related??[],{system:r(this,tt),correlation:{parentField:s.sourceField,childField:s.destField},hidden:!0,subquery:{table:a,alias:e,orderBy:ao(r(this,G).tables[a],void 0),related:[{system:r(this,tt),correlation:{parentField:i.sourceField,childField:i.destField},subquery:oc(r(this,G).tables[o],u._ast)}]}}]},{...this.format,relationships:{...this.format.relationships,[e]:u.format}},this.customQueryID,r(this,ue))}throw new Error(`Invalid relationship ${e}`)});v(this,"where",(e,t,n)=>{let s;typeof e=="function"?s=e(new Xw(this._exists)):(b(t!==void 0,"Invalid condition"),s=Zw(e,t,n));const i=this._ast.where;i&&(s=Yw(i,s));const o=Qc(s);return r(this,tt)==="client"&&Hh(o),this[ve](this._delegate,r(this,G),r(this,ae),{...this._ast,where:o},this.format,this.customQueryID,r(this,ue))});v(this,"start",(e,t)=>this[ve](this._delegate,r(this,G),r(this,ae),{...this._ast,start:{row:e,exclusive:!(t!=null&&t.inclusive)}},this.format,this.customQueryID,r(this,ue)));v(this,"limit",e=>{if(e<0)throw new Error("Limit must be non-negative");if((e|0)!==e)throw new Error("Limit must be an integer");if(r(this,ue))throw new tp("Limit is not supported in junction relationships yet. Junction relationship being limited: "+r(this,ue));return this[ve](this._delegate,r(this,G),r(this,ae),{...this._ast,limit:e},this.format,this.customQueryID,r(this,ue))});v(this,"orderBy",(e,t)=>{if(r(this,ue))throw new tp("Order by is not supported in junction relationships yet. Junction relationship being ordered: "+r(this,ue));return this[ve](this._delegate,r(this,G),r(this,ae),{...this._ast,orderBy:[...this._ast.orderBy??[],[e,t]]},this.format,this.customQueryID,r(this,ue))});v(this,"_exists",(e,t=n=>n)=>{const n=r(this,G).relationships[r(this,ae)][e];if(b(n,"Invalid relationship"),Kf(n)){const{destSchema:s,sourceField:i,destField:o}=n[0];b(Ge(i),"Invalid relationship"),b(Ge(o),"Invalid relationship");const a=t(this[ve](this._delegate,r(this,G),s,{table:s,alias:`${eo}${e}`},Eo,this.customQueryID,void 0));return{type:"correlatedSubquery",related:{system:r(this,tt),correlation:{parentField:i,childField:o},subquery:oc(r(this,G).tables[s],a._ast)},op:"EXISTS"}}if(qf(n)){const[s,i]=n;b(Ge(s.sourceField),"Invalid relationship"),b(Ge(s.destField),"Invalid relationship"),b(Ge(i.sourceField),"Invalid relationship"),b(Ge(i.destField),"Invalid relationship");const{destSchema:o}=i,a=s.destSchema,u=t(this[ve](this._delegate,r(this,G),o,{table:o,alias:`${eo}zhidden_${e}`},Eo,this.customQueryID,e));return{type:"correlatedSubquery",related:{system:r(this,tt),correlation:{parentField:s.sourceField,childField:s.destField},subquery:{table:a,alias:`${eo}${e}`,orderBy:ao(r(this,G).tables[a],void 0),where:{type:"correlatedSubquery",related:{system:r(this,tt),correlation:{parentField:i.sourceField,childField:i.destField},subquery:oc(r(this,G).tables[o],u._ast)},op:"EXISTS"}}},op:"EXISTS"}}throw new Error(`Invalid relationship ${e}`)});l(this,Wn);d(this,G,t),this._delegate=e,d(this,ae,n),this._ast=s,this.format=i,d(this,tt,o),d(this,ue,u),this.customQueryID=a}delegate(e){return this[ve](e,r(this,G),r(this,ae),this._ast,this.format,this.customQueryID,r(this,ue))}nameAndArgs(e,t){return this[ve](this._delegate,r(this,G),r(this,ae),this._ast,this.format,{name:e,args:t},r(this,ue))}get[bI](){return this._ast}get ast(){return this._completeAst()}hash(){return r(this,wi)||d(this,wi,kh(this._completeAst())),r(this,wi)}_completeAst(){if(!r(this,Wn)){const e=ao(r(this,G).tables[r(this,ae)],this._ast.orderBy);if(this._ast.start){const{row:t}=this._ast.start,n={};for(const[s]of e)n[s]=t[s];d(this,Wn,{...this._ast,start:{...this._ast.start,row:n},orderBy:e})}else d(this,Wn,{...this._ast,orderBy:ao(r(this,G).tables[r(this,ae)],this._ast.orderBy)})}return r(this,Wn)}then(e,t){return this.run().then(e,t)}},G=new WeakMap,ae=new WeakMap,wi=new WeakMap,tt=new WeakMap,ue=new WeakMap,Wn=new WeakMap,dm),kI=Symbol(),Ho,vi,II=(vi=class extends ov{constructor(n,s,i,o={table:i},a=Eo,u="client",c,h){super(n,s,i,o,a,u,c,h);l(this,Ho);d(this,Ho,u)}get[kI](){return this._completeAst()}[ve](n,s,i,o,a,u,c){return new vi(n,s,i,o,a,r(this,Ho),u,c)}materialize(n,s=so){const i=H(this._delegate,"materialize requires a query delegate to be set"),o=Date.now();let a;typeof n=="function"?a=n:s=n??so;const u=this._completeAst(),c=$();let h=i.defaultQueryComplete;const m=k=>{if(k){const C=Date.now();i.onQueryMaterialized(this.hash(),u,C-o),h=!0,c.resolve(!0)}},y=this.customQueryID?i.addCustomQuery(this.customQueryID,s,m):i.addServerQuery(u,s,m),w=k=>{this.customQueryID?i.updateCustomQuery(this.customQueryID,k):i.updateServerQuery(u,k)},g=uI(u,i);let S;const I=()=>{g.destroy(),S==null||S(),y()};return i.batchViewUpdates(()=>(a??CI)(this,g,this.format,I,k=>{S=i.onTransactionCommit(k)},h||c.promise,w))}run(n){H(this._delegate,"run requires a query delegate to be set").assertValidRunOptions(n);const i=this.materialize();if((n==null?void 0:n.type)==="complete")return new Promise(a=>{i.addListener((u,c)=>{c==="complete"&&(i.destroy(),a(u))})});n==null||n.type;const o=i.data;return i.destroy(),Promise.resolve(o)}preload(n){const s=H(this._delegate,"preload requires a query delegate to be set"),{resolve:i,promise:o}=$();if(this.customQueryID)return{cleanup:s.addCustomQuery(this.customQueryID,(n==null?void 0:n.ttl)??so,h=>{h&&i()}),complete:o};const a=this._completeAst();return{cleanup:s.addServerQuery(a,(n==null?void 0:n.ttl)??so,c=>{c&&i()}),complete:o}}},Ho=new WeakMap,vi);function ao(e,t){t=t??[];const{primaryKey:n}=e,s=new Set(n);for(const[i]of t)s.delete(i);return s.size===0?t:[...t,...[...s].map(i=>[i,"asc"])]}function oc(e,t){return{...t,orderBy:ao(e,t.orderBy)}}function CI(e,t,n,s,i,o,a){const u=new gI(t,n,o,a);return u.onDestroy=s,i(()=>{u.flush()}),u}function Ge(e){return Array.isArray(e)&&e.length>=1}var gi;class av{constructor(t){l(this,gi);d(this,gi,t)}log(t,n,...s){for(const i of r(this,gi))i.log(t,n,...s)}async flush(){await Promise.all(r(this,gi).map(t=>{var n;return(n=t.flush)==null?void 0:n.call(t)}))}}gi=new WeakMap;class DI{constructor(t,n="info",s){v(this,"debug");v(this,"info");v(this,"warn");v(this,"error");v(this,"flush");const i=o=>(...a)=>t.log(o,s,...a);switch(n){case"debug":this.debug=i("debug");case"info":this.info=i("info");case"warn":this.warn=i("warn");case"error":this.error=i("error")}this.flush=()=>{var o;return((o=t.flush)==null?void 0:o.call(t))??Promise.resolve()}}}const Nn={log(e,t,...n){console[e](..._I(t),...n.map(EI))}};var Fo,zo,$o;const kf=class kf extends DI{constructor(n="info",s,i=Nn){super(i,n,s);l(this,Fo);l(this,zo);l(this,$o);d(this,zo,n),d(this,Fo,i),d(this,$o,s)}withContext(n,s){const i={...r(this,$o),[n]:s};return new kf(r(this,zo),i,r(this,Fo))}};Fo=new WeakMap,zo=new WeakMap,$o=new WeakMap;let Jc=kf;function _I(e){const t=[];for(const[n,s]of Object.entries(e??{})){const i=s===void 0?n:`${n}=${s}`;t.push(i)}return t}function EI(e){switch(typeof e){case"string":case"number":case"boolean":case"undefined":case"symbol":case"bigint":return e;case"object":if(e===null)return null;break}return JSON.stringify(e,xI)}function xI(e,t){return t instanceof Error?{name:t.name,message:t.message,stack:t.stack,..."cause"in t?{cause:t.cause}:null}:t}async function uv(e,t,n,s){const i={headers:{"Content-type":"application/json",Authorization:t,"X-Replicache-RequestID":n},body:JSON.stringify(s),method:"POST"},o=new Request(e,i),a=await fetch(o),u=a.status;return u!==200?[void 0,{httpStatusCode:u,errorMessage:await a.text()}]:[a,{httpStatusCode:u,errorMessage:""}]}function cv(e,t){return typeof e=="object"&&e!==null&&e.error===t}function NI(e){return typeof e.error=="string"}function Qs(e){return cv(e,"ClientStateNotFound")}function Js(e){if(!cv(e,"VersionNotSupported"))return!1;const{versionType:t}=e;switch(t){case void 0:case"pull":case"push":case"schema":return!0}return!1}function MI(e){b(Js(e))}function lv(e){Pe(e),Oe(e.httpStatusCode),J(e.errorMessage)}function RI(e){Os(e);for(const t of e)TI(t)}function TI(e){switch(Pe(e),e.op){case"put":J(e.key),e.value;break;case"update":if(J(e.key),e.merge!==void 0&&xy(e.merge),e.constrain!==void 0){Os(e.constrain);for(const t of e.constrain)J(t)}break;case"del":J(e.key);break;case"clear":break;default:throw new Error(`unknown patch op \`${e.op}\`, expected one of \`put\`, \`del\`, \`clear\``)}}function OI(e){async function t(n,s){const[i,o]=await uv(e.pullURL,e.auth,s,n);return i?{response:await i.json(),httpRequestInfo:o}:{httpRequestInfo:o}}return hv.add(t),t}var hv=new WeakSet;function PI(e){return hv.has(e)}function AI(e){if(Pe(e),Qs(e)||Js(e))return;const t=e;t.cookie!==void 0&&Vy(t.cookie),LI(t.lastMutationIDChanges),RI(t.patch)}function LI(e){Pe(e);for(const[t,n]of Object.entries(e))J(t),Oe(n)}function HI(e){Pe(e),lv(e.httpRequestInfo),e.response!==void 0&&AI(e.response)}var np=new Map;function ze(e){return np.has(e)?np.get(e):globalThis[e]}function FI(e){var t;return(t=ze(e))==null?void 0:t.bind(globalThis)}function df(e){const t=ze(e);if(t===void 0)throw new Error(`Unsupported JavaScript environment: Could not find ${e}.`);return t}var zI=Promise.resolve(!0),$I=Promise.resolve(!1);Promise.resolve(void 0);var me=Promise.resolve();new Promise(()=>{});var vo=Symbol(),rn,fm,dv=(fm=class{constructor(e){v(this,"_pending",new Map);l(this,rn);d(this,rn,e)}has(e){switch(this._pending.get(e)){case void 0:return r(this,rn).has(e);case vo:return $I;default:return zI}}async get(e){const t=this._pending.get(e);switch(t){case vo:return;case void 0:{const n=await r(this,rn).get(e);return Ry(n)}default:return t}}put(e,t){return this._pending.set(e,t),me}del(e){return this._pending.set(e,vo),me}release(){r(this,rn).release()}get closed(){return r(this,rn).closed}},rn=new WeakMap,fm),VI={durability:"relaxed"},Tl="chunks",on,bi,Si,Vo,Fh,pm,Xc=(pm=class{constructor(e){l(this,Vo);l(this,on);l(this,bi,!1);l(this,Si,!1);d(this,on,UI(e))}read(){return p(this,Vo,Fh).call(this,BI)}write(){return p(this,Vo,Fh).call(this,GI)}async close(){r(this,Si)||(await r(this,on)).close(),d(this,bi,!0)}get closed(){return r(this,bi)}},on=new WeakMap,bi=new WeakMap,Si=new WeakMap,Vo=new WeakSet,Fh=async function(e){const t=async s=>{const{promise:i,resolve:o,reject:a}=$(),u=indexedDB.open(s);u.onupgradeneeded=()=>{const h=u.transaction;PS(h),h.abort(),d(this,Si,!0),a(new sp(`Replicache IndexedDB not found: ${s}`))},u.onsuccess=()=>o(u.result),u.onerror=()=>a(u.error);const c=await i;return c.onversionchange=()=>c.close(),c},n=await r(this,on);try{return e(n)}catch(s){if(!r(this,bi)&&s instanceof DOMException){if(s.name==="InvalidStateError"){d(this,on,t(n.name));const i=await r(this,on);return e(i)}else if(s.name==="NotFoundError")throw d(this,Si,!0),df("indexedDB").deleteDatabase(n.name),new sp(`Replicache IndexedDB ${n.name} missing object store. Deleting db.`)}throw s}},pm),ki,jo,mm,fv=(mm=class{constructor(e){l(this,ki);l(this,jo,!1);d(this,ki,e)}has(e){return new Promise((t,n)=>{const s=zh(r(this,ki)).count(e);s.onsuccess=()=>t(s.result>0),s.onerror=()=>n(s.error)})}get(e){return new Promise((t,n)=>{const s=zh(r(this,ki)).get(e);s.onsuccess=()=>t(Ry(s.result)),s.onerror=()=>n(s.error)})}release(){d(this,jo,!0)}get closed(){return r(this,jo)}},ki=new WeakMap,jo=new WeakMap,mm),Go,Bo,ym,jI=(ym=class extends dv{constructor(t){super(new fv(t));l(this,Go);l(this,Bo,!1);d(this,Go,t)}commit(){return this._pending.size===0?me:new Promise((t,n)=>{const s=r(this,Go),i=zh(s);for(const[o,a]of this._pending)a===vo?i.delete(o):i.put(a,o);s.oncomplete=()=>t(),s.onerror=()=>n(s.error)})}release(){d(this,Bo,!0)}get closed(){return r(this,Bo)}},Go=new WeakMap,Bo=new WeakMap,ym);function GI(e){const t=e.transaction(Tl,"readwrite",VI);return new jI(t)}function BI(e){const t=e.transaction(Tl,"readonly");return new fv(t)}function zh(e){return e.objectStore(Tl)}function UI(e){const t=df("indexedDB");return new Promise((n,s)=>{const i=t.open(e);i.onupgradeneeded=()=>{i.result.createObjectStore(Tl)},i.onsuccess=()=>{const o=i.result;o.onversionchange=()=>o.close(),n(o)},i.onerror=()=>s(i.error)})}var sp=class extends Error{constructor(){super(...arguments);v(this,"name","IDBNotFoundError")}},pv=class extends Error{constructor(){super("Transaction is closed")}};function xo(e){if(e.closed)throw new pv}function mv(e){return e.closed?Promise.reject(new pv):void 0}var ge=typeof navigator<"u"?navigator:void 0,Ii,Uo,Ko,wm,yv=(wm=class{constructor(e,t){l(this,Ii);l(this,Uo);l(this,Ko,!1);d(this,Ii,e),d(this,Uo,t)}release(){r(this,Uo).call(this),d(this,Ko,!0)}get closed(){return r(this,Ko)}has(e){return Promise.resolve(r(this,Ii).has(e))}get(e){return Promise.resolve(r(this,Ii).get(e))}},Ii=new WeakMap,Uo=new WeakMap,Ko=new WeakMap,wm),Ci,vm,KI=(vm=class extends dv{constructor(t,n){super(new yv(t,n));l(this,Ci);d(this,Ci,t)}commit(){return this._pending.forEach((t,n)=>{t===vo?r(this,Ci).delete(n):r(this,Ci).set(n,t)}),this._pending.clear(),this.release(),me}},Ci=new WeakMap,vm),$h=new Map;function wv(e){return $h.delete(e),me}var Di,_i,qo,gm,vv=(gm=class{constructor(e){l(this,Di);l(this,_i);l(this,qo,!1);const t=$h.get(e);let n,s;t?{lock:n,map:s}=t:(n=new Cy,s=new Map,$h.set(e,{lock:n,map:s})),d(this,_i,n),d(this,Di,s)}async read(){const e=await r(this,_i).read();return new yv(r(this,Di),e)}async write(){const e=await r(this,_i).write();return new KI(r(this,Di),e)}close(){return d(this,qo,!0),me}get closed(){return r(this,qo)}},Di=new WeakMap,_i=new WeakMap,qo=new WeakMap,gm),Qo,Jo,ft,Xo,Vh,bm,qI=(bm=class{constructor(e,t){l(this,Xo);l(this,Qo);l(this,Jo);l(this,ft);d(this,Qo,e),d(this,Jo,t),d(this,ft,new Xc(t))}read(){return p(this,Xo,Vh).call(this,e=>e.read())}write(){return p(this,Xo,Vh).call(this,e=>e.write())}close(){return r(this,ft).close()}get closed(){return r(this,ft).closed}},Qo=new WeakMap,Jo=new WeakMap,ft=new WeakMap,Xo=new WeakSet,Vh=async function(e){var t,n;try{return await e(r(this,ft))}catch(s){if(gv(s))return r(this,ft)instanceof Xc&&((n=(t=r(this,Qo)).info)==null||n.call(t,"Switching to MemStore because of Firefox private browsing error"),d(this,ft,new vv(r(this,Jo)))),e(r(this,ft));throw s}},bm);function gv(e){return ff()&&e instanceof DOMException&&e.name==="InvalidStateError"&&e.message==="A mutation operation was attempted on a database that did not allow mutations."}function ff(){return(ge==null?void 0:ge.userAgent.includes("Firefox"))??!1}function QI(e,t){return ff()?new qI(e,t):new Xc(t)}function JI(e){if(!ff())return ip(e);try{return ip(e)}catch(t){if(gv(t))return wv(e)}return me}function ip(e){return new Promise((t,n)=>{const s=indexedDB.deleteDatabase(e);s.onsuccess=()=>t(),s.onerror=()=>n(s.error)})}var Ur=class extends Error{constructor(){super(...arguments);v(this,"name","AbortError")}};function bv(e,t,n){return e?new XI(e,t,n):new WI}var Ei,Yo,Zo,xi,cl,Pn,jh,Gh,Sm,XI=(Sm=class{constructor(e,t,n){l(this,Pn);l(this,Ei);l(this,Yo);l(this,Zo,0);v(this,"visibilityState");l(this,xi,new Set);l(this,cl,()=>{r(this,Ei).visibilityState==="visible"?(clearTimeout(r(this,Zo)),p(this,Pn,jh).call(this,"visible")):d(this,Zo,setTimeout(()=>{p(this,Pn,jh).call(this,"hidden")},r(this,Yo)))});d(this,Ei,e),d(this,Yo,t),this.visibilityState=e.visibilityState,r(this,Ei).addEventListener("visibilitychange",r(this,cl),{signal:n})}waitForVisible(){return p(this,Pn,Gh).call(this,"visible")}waitForHidden(){return p(this,Pn,Gh).call(this,"hidden")}},Ei=new WeakMap,Yo=new WeakMap,Zo=new WeakMap,xi=new WeakMap,cl=new WeakMap,Pn=new WeakSet,jh=function(e){if(e!==this.visibilityState){this.visibilityState=e;for(const t of r(this,xi)){const{resolve:n,state:s}=t;s===e&&(n(),r(this,xi).delete(t))}}},Gh=function(e){if(this.visibilityState===e)return Promise.resolve();const{promise:t,resolve:n}=$();return r(this,xi).add({resolve:n,state:e}),t},Sm),YI=Promise.resolve(),ZI=new Promise(()=>{}),WI=class{constructor(){v(this,"visibilityState","visible")}waitForVisible(){return YI}waitForHidden(){return ZI}},Sv=class{constructor(e,t){v(this,"rep");v(this,"invokeSend");v(this,"maxConnections",1);this.rep=e,this.invokeSend=t}get maxDelayMs(){return this.rep.requestOptions.maxDelayMs}get minDelayMs(){return this.rep.requestOptions.minDelayMs}},eC=class extends Sv{constructor(){super(...arguments);v(this,"debounceDelay",0)}get watchdogTimer(){return this.rep.pullInterval}},tC=class extends Sv{constructor(){super(...arguments);v(this,"watchdogTimer",null)}get debounceDelay(){return this.rep.pushDelay}},nC=Promise.resolve();new Promise(()=>{});function Mn(e,t){const n=()=>new Ur("Aborted");return t!=null&&t.aborted?Promise.reject(n()):e===0?nC:new Promise((s,i)=>{let o;t&&(o=()=>{clearTimeout(a),i(n())},t.addEventListener("abort",o,{once:!0}));const a=setTimeout(()=>{s(),t==null||t.removeEventListener("abort",o)},e)})}function sC(e,t){const{promise:n,resolve:s}=$();return[new Promise(o=>{const a=()=>{clearTimeout(u),s()},u=setTimeout(()=>{o(),t.removeEventListener("abort",a)},e);t.addEventListener("abort",a,{once:!0})}),n]}var iC=30,rC=6e4,es,Ni,ts,Wo,nt,Mi,Ri,ea,ns,Kr,kv,Iv,km,rp=(km=class{constructor(e,t,n){l(this,Kr);l(this,es,$());l(this,Ni,$());l(this,ts,$());l(this,Wo);l(this,nt,!1);l(this,Mi,0);l(this,Ri);l(this,ea);l(this,ns);d(this,Ri,e),d(this,Wo,t),d(this,ea,n),this.run()}close(){d(this,nt,!0),r(this,Mi)>0&&r(this,ts).resolve({error:op()})}async send(e){var n,s,i;if(r(this,nt))return{error:op()};Et(this,Mi)._++,(s=(n=r(this,Ri)).debug)==null||s.call(n,"send",e),e?r(this,Ni).resolve():await((i=r(this,ea))==null?void 0:i.waitForVisible()),r(this,es).resolve();const t=await r(this,ts).promise;return Et(this,Mi)._--,t}async run(){const e=[];let t=$(),n,s=0;const i=r(this,Wo),{debug:o}=r(this,Ri);let a=0;o==null||o("Starting connection loop");const u=c=>Promise.race([r(this,Ni).promise,Mn(c)]);for(;!r(this,nt);){o==null||o(jl(e)?"Last request failed. Trying again":"Waiting for a send");const c=[r(this,es).promise],h=i.watchdogTimer;if(h!==null&&c.push(Mn(h)),await Promise.race(c),r(this,nt)||(o==null||o("Waiting for debounce"),await u(i.debounceDelay),r(this,nt)))break;if(o==null||o("debounced"),d(this,es,$()),s>=i.maxConnections){if(o==null||o("Too many request in flight. Waiting until one finishes..."),await p(this,Kr,Iv).call(this),r(this,nt))break;o==null||o("...finished")}s>0||jl(e)?(a=aC(a,i,e),o==null||o(jl(e)?"Last connection errored. Sleeping for":"More than one outstanding connection ("+s+"). Sleeping for",a,"ms")):a=0;const m=Math.min(i.maxDelayMs,Math.max(i.minDelayMs,a));if(n!==void 0){const y=Date.now()-n;if(m>y&&(await Promise.race([u(m-y),t.promise]),r(this,nt)))break}s++,(async()=>{const y=Date.now();let w,g;try{n=y,o==null||o("Sending request"),d(this,Ni,$()),w=await i.invokeSend(),o==null||o("Send returned",w)}catch(I){o==null||o("Send failed",I),g=I,w=!1}if(r(this,nt)){o==null||o("Closed after invokeSend");return}o==null||o("Request done",{duration:Date.now()-y,ok:w}),e.push({duration:Date.now()-y,ok:w}),cC(e)&&(t.resolve(),t=$()),s--,p(this,Kr,kv).call(this);const S=r(this,ts);d(this,ts,$()),g?S.resolve({error:g}):S.resolve(void 0),w||r(this,es).resolve()})()}}},es=new WeakMap,Ni=new WeakMap,ts=new WeakMap,Wo=new WeakMap,nt=new WeakMap,Mi=new WeakMap,Ri=new WeakMap,ea=new WeakMap,ns=new WeakMap,Kr=new WeakSet,kv=function(){if(r(this,ns)){const e=r(this,ns);d(this,ns,void 0),e()}},Iv=function(){const{promise:e,resolve:t}=$();return d(this,ns,t),e},km),oC=9;function op(){return new Error("Closed")}function aC(e,t,n){const{length:s}=n;if(s===0)return e;const{ok:i}=n[n.length-1],{maxConnections:o,minDelayMs:a}=t;if(!i)return e===0?a:e*2;if(s>1){const c=n[n.length-2];for(;n.length>oC;)n.shift();if(i&&!c.ok)return a}return uC(n.filter(({ok:c})=>c).map(({duration:c})=>c))/o|0}function uC(e){e.sort();const{length:t}=e,n=t>>1;return t%2===1?e[n]:(e[n-1]+e[n])/2}function jl(e){return e.length>0&&!e[e.length-1].ok}function cC(e){return e.length>1&&!e[e.length-2].ok&&e[e.length-1].ok}function Cv(e,t,n){return new lC(e,t,n).compute()}var ta,na,Ti,an,ss,Rt,Oi,Pi,Re,kc,Bh,Uh,Dv,Im,lC=(Im=class{constructor(e,t,n){l(this,Re);l(this,ta);l(this,na);l(this,Ti);l(this,an);l(this,ss);l(this,Rt);l(this,Oi);l(this,Pi);const s=[],i=[];for(const o of e)o.old!==o.new&&(o.old&&i.push(o.old),o.new&&s.push(o.new));d(this,ta,s),d(this,na,i),d(this,Ti,t),d(this,an,n),d(this,Rt,new Map),d(this,Oi,new Map),d(this,Pi,n.areRefsCounted!==void 0),d(this,ss,r(this,Pi)?new Set:null)}async compute(){for(const e of r(this,ta))await p(this,Re,kc).call(this,e,1);if(await Promise.all(Array.from(r(this,Ti).values(),e=>p(this,Re,Uh).call(this,e))),r(this,Pi)){b(r(this,an).areRefsCounted),b(r(this,ss));let e;do{e=!1;for(const t of r(this,Ti).values())if(!r(this,an).areRefsCounted(t)&&!r(this,ss).has(t)&&r(this,Rt).get(t)!==0){await p(this,Re,Bh).call(this,t,1),e=!0;break}}while(e)}for(const e of r(this,na))await p(this,Re,kc).call(this,e,-1);return r(this,Rt)}},ta=new WeakMap,na=new WeakMap,Ti=new WeakMap,an=new WeakMap,ss=new WeakMap,Rt=new WeakMap,Oi=new WeakMap,Pi=new WeakMap,Re=new WeakSet,kc=async function(e,t){await p(this,Re,Uh).call(this,e),p(this,Re,Dv).call(this,e,t)&&await p(this,Re,Bh).call(this,e,t)},Bh=async function(e,t){var s;if(e===Ve)return;const n=await r(this,an).getRefs(e);if(n!==void 0){(s=r(this,ss))==null||s.add(e);const i=n.map(o=>p(this,Re,kc).call(this,o,t));await Promise.all(i)}},Uh=function(e){let t=r(this,Oi).get(e);return t===void 0&&(t=(async()=>{const n=await r(this,an).getRefCount(e)||0;return r(this,Rt).set(e,n),n})(),r(this,Oi).set(e,t)),t},Dv=function(e,t){const n=r(this,Rt).get(e);return Oe(n),r(this,Rt).set(e,n+t),n===0&&t===1||n===1&&t===-1},Im),sa,ia,Ai,ra,Li,Cm,hC=(Cm=class{constructor(e,t,n,s,i=xs){l(this,sa,new Cy);l(this,ia,new Map);l(this,Ai);l(this,ra);l(this,Li);v(this,"_memOnlyChunks",new Map);v(this,"_sourceChunksCache");v(this,"_refCounts",new Map);v(this,"_refs",new Map);this._sourceChunksCache=new fC(t,i,this._refCounts,this._refs),d(this,Ai,e),d(this,ra,n),d(this,Li,s)}async read(e){const t=await r(this,sa).read();return new _v(r(this,ia),this._memOnlyChunks,this._sourceChunksCache,r(this,Ai),t,r(this,Li),e)}async write(){const e=await r(this,sa).write();return new dC(r(this,ia),this._memOnlyChunks,this._sourceChunksCache,r(this,Ai),this._refCounts,this._refs,e,r(this,ra),r(this,Li))}close(){return me}isCached(e){return this._sourceChunksCache.getWithoutUpdatingLRU(e)!==void 0}withSuspendedSourceCacheEvictsAndDeletes(e){return this._sourceChunksCache.withSuspendedEvictsAndDeletes(e)}},sa=new WeakMap,ia=new WeakMap,Ai=new WeakMap,ra=new WeakMap,Li=new WeakMap,Cm),un,oa,Hi,aa,Dm,_v=(Dm=class{constructor(e,t,n,s,i,o,a){v(this,"_heads");v(this,"_memOnlyChunks");v(this,"_sourceChunksCache");v(this,"_sourceStore");l(this,un);l(this,oa);l(this,Hi,!1);v(this,"assertValidHash");l(this,aa);this._heads=e,this._memOnlyChunks=t,this._sourceChunksCache=n,this._sourceStore=s,d(this,oa,i),this.assertValidHash=o,d(this,un,a!==void 0?Promise.resolve(a):void 0),d(this,aa,a!==void 0)}isMemOnlyChunkHash(e){return this._memOnlyChunks.has(e)}async hasChunk(e){return await this.getChunk(e)!==void 0}async getChunk(e){const t=this._memOnlyChunks.get(e);if(t!==void 0)return t;let n=this._sourceChunksCache.get(e);return n===void 0&&(n=await(await this._getSourceRead()).getChunk(e),n!==void 0&&this._sourceChunksCache.put(n)),n}mustGetChunk(e){return Ey(this,e)}getHead(e){return Promise.resolve(this._heads.get(e))}release(){var e;r(this,Hi)||(r(this,oa).call(this),r(this,aa)||(e=r(this,un))==null||e.then(t=>t.release()).catch(t=>{}),d(this,Hi,!0))}get closed(){return r(this,Hi)}_getSourceRead(){return r(this,un)||d(this,un,this._sourceStore.read()),r(this,un)}},un=new WeakMap,oa=new WeakMap,Hi=new WeakMap,aa=new WeakMap,Dm),is,cn,ua,ca,la,Kh,_m,dC=(_m=class extends _v{constructor(t,n,s,i,o,a,u,c,h){super(t,n,s,i,u,h);l(this,la);l(this,is);l(this,cn);l(this,ua);v(this,"_pendingHeadChanges",new Map);v(this,"_pendingMemOnlyChunks",new Map);v(this,"_pendingCachedChunks",new Map);l(this,ca,new Set);v(this,"createChunk",(t,n)=>{const s=By(t,n,r(this,ua));return r(this,ca).add(s.hash),s});d(this,is,o),d(this,cn,a),d(this,ua,c)}putChunk(t,n){const{hash:s,meta:i}=t;if(this.assertValidHash(s),i.length>0)for(const o of i)this.assertValidHash(o);return r(this,ca).has(s)||this.isMemOnlyChunkHash(s)?this._pendingMemOnlyChunks.set(s,t):this._pendingCachedChunks.set(s,{chunk:t,size:n??-1}),me}async setHead(t,n){await p(this,la,Kh).call(this,t,n)}async removeHead(t){await p(this,la,Kh).call(this,t,void 0)}isMemOnlyChunkHash(t){return this._pendingMemOnlyChunks.has(t)||super.isMemOnlyChunkHash(t)}async getChunk(t){const n=this._pendingMemOnlyChunks.get(t);if(n!==void 0)return n;const s=this._memOnlyChunks.get(t);if(s!==void 0)return s;const i=this._pendingCachedChunks.get(t);if(i!==void 0)return i.chunk;let o=this._sourceChunksCache.get(t);return o===void 0&&(o=await(await this._getSourceRead()).getChunk(t),o!==void 0&&this._pendingCachedChunks.set(o.hash,{chunk:o,size:-1})),o}getHead(t){const n=this._pendingHeadChanges.get(t);return n?Promise.resolve(n.new):super.getHead(t)}async commit(){const t=new Set(ih(this._pendingMemOnlyChunks.keys(),this._pendingCachedChunks.keys())),n=await Cv(this._pendingHeadChanges.values(),t,this);for(const[s,i]of n)if(this.isMemOnlyChunkHash(s)){if(i===0)r(this,is).delete(s),this._memOnlyChunks.delete(s),r(this,cn).delete(s);else{r(this,is).set(s,i);const o=this._pendingMemOnlyChunks.get(s);o&&(r(this,cn).set(s,o.meta),this._memOnlyChunks.set(s,o))}n.delete(s)}this._sourceChunksCache.updateForCommit(this._pendingCachedChunks,n);for(const[s,i]of this._pendingHeadChanges)i.new?this._heads.set(s,i.new):this._heads.delete(s);this._pendingMemOnlyChunks.clear(),this._pendingCachedChunks.clear(),this._pendingHeadChanges.clear(),this.release()}getRefCount(t){return r(this,is).get(t)}getRefs(t){const n=this._pendingMemOnlyChunks.get(t);if(n)return n.meta;const s=this._memOnlyChunks.get(t);if(s)return s.meta;const i=this._pendingCachedChunks.get(t);return i!==void 0?i.chunk.meta:r(this,cn).get(t)}areRefsCounted(t){return r(this,cn).has(t)}chunksPersisted(t){const n=[];for(const s of t){const i=this._memOnlyChunks.get(s);i&&(this._memOnlyChunks.delete(s),n.push(i))}this._sourceChunksCache.persisted(n)}},is=new WeakMap,cn=new WeakMap,ua=new WeakMap,ca=new WeakMap,la=new WeakSet,Kh=async function(t,n){const s=await this.getHead(t),i=this._pendingHeadChanges.get(t);i===void 0?this._pendingHeadChanges.set(t,{new:n,old:s}):i.new=n},_m),Fi,ha,st,ln,rs,os,da,ye,uo,Ic,Ev,qh,Em,fC=(Em=class{constructor(e,t,n,s){l(this,ye);l(this,Fi);l(this,ha);l(this,st);l(this,ln);l(this,rs,0);l(this,os,!1);l(this,da,[]);v(this,"cacheEntries",new Map);d(this,Fi,e),d(this,ha,t),d(this,st,n),d(this,ln,s)}get(e){const t=this.cacheEntries.get(e);return t&&(this.cacheEntries.delete(e),this.cacheEntries.set(e,t)),t==null?void 0:t.chunk}getWithoutUpdatingLRU(e){var t;return(t=this.cacheEntries.get(e))==null?void 0:t.chunk}put(e){const{hash:t}=e,n=this.cacheEntries.get(t);if(n){this.cacheEntries.delete(t),this.cacheEntries.set(t,n);return}const s=r(this,st).get(t);if(!(s===void 0||s<1)&&p(this,ye,Ic).call(this,e)){if(!r(this,ln).has(t)){for(const i of e.meta)r(this,st).set(i,(r(this,st).get(i)||0)+1);r(this,ln).set(t,e.meta)}p(this,ye,uo).call(this)}}updateForCommit(e,t){for(const[n,s]of t)if(s===0)r(this,os)?(r(this,st).set(n,0),r(this,da).push(n)):p(this,ye,qh).call(this,n);else{r(this,st).set(n,s);const i=e.get(n);if(i){const{chunk:o,size:a}=i,u=this.cacheEntries.get(n);u?(this.cacheEntries.delete(n),this.cacheEntries.set(n,u)):(p(this,ye,Ic).call(this,o,a!==-1?a:void 0),r(this,ln).set(n,o.meta))}}p(this,ye,uo).call(this)}persisted(e){for(const t of e)p(this,ye,Ic).call(this,t);p(this,ye,uo).call(this)}async withSuspendedEvictsAndDeletes(e){d(this,os,!0);try{return await e()}finally{d(this,os,!1);for(const t of r(this,da))r(this,st).get(t)===0&&p(this,ye,qh).call(this,t);p(this,ye,uo).call(this)}}},Fi=new WeakMap,ha=new WeakMap,st=new WeakMap,ln=new WeakMap,rs=new WeakMap,os=new WeakMap,da=new WeakMap,ye=new WeakSet,uo=function(){if(!r(this,os))for(const e of this.cacheEntries.values()){if(r(this,rs)<=r(this,Fi))break;p(this,ye,Ev).call(this,e)}},Ic=function(e,t){const n=t??r(this,ha).call(this,e);return n>r(this,Fi)?!1:(d(this,rs,r(this,rs)+n),this.cacheEntries.set(e.hash,{chunk:e,size:n}),!0)},Ev=function(e){const{hash:t}=e.chunk;d(this,rs,r(this,rs)-e.size),this.cacheEntries.delete(t)},qh=function(e){r(this,st).delete(e),r(this,ln).delete(e);const t=this.cacheEntries.get(e);t&&(d(this,rs,r(this,rs)-t.size),this.cacheEntries.delete(e))},Em);function Yc(e){return`c/${e}/d`}function Cc(e){return`c/${e}/m`}function Gl(e){return`c/${e}/r`}function xv(e){return`h/${e}`}var as,fa,zi,xm,Nv=(xm=class{constructor(e,t,n){l(this,as);l(this,fa);l(this,zi);d(this,as,e),d(this,fa,t),d(this,zi,n)}async read(){return new Mv(await r(this,as).read(),r(this,zi))}async write(){return new pC(await r(this,as).write(),r(this,fa),r(this,zi))}close(){return r(this,as).close()}},as=new WeakMap,fa=new WeakMap,zi=new WeakMap,xm),Mv=class{constructor(e,t){v(this,"_tx");v(this,"assertValidHash");this._tx=e,this.assertValidHash=t}hasChunk(e){return this._tx.has(Yc(e))}async getChunk(e){const t=await this._tx.get(Yc(e));if(t===void 0)return;const n=await this._tx.get(Cc(e));let s;return n!==void 0?(Gy(n),s=n):s=[],new jy(e,t,s)}mustGetChunk(e){return Ey(this,e)}async getHead(e){const t=await this._tx.get(xv(e));if(t!==void 0)return Gr(t),t}release(){this._tx.release()}get closed(){return this._tx.closed}},pa,$i,Vi,Ut,Qh,Rv,Tv,Nm,pC=(Nm=class extends Mv{constructor(t,n,s){super(t,s);l(this,Ut);l(this,pa);l(this,$i,new Set);l(this,Vi,new Map);v(this,"createChunk",(t,n)=>By(t,n,r(this,pa)));d(this,pa,n)}get kvWrite(){return this._tx}async putChunk(t){const{hash:n,data:s,meta:i}=t;this.assertValidHash(n);const o=Yc(n),a=this._tx.put(o,s);let u;if(i.length>0){for(const c of i)this.assertValidHash(c);u=this._tx.put(Cc(n),i)}r(this,$i).add(n),await a,await u}setHead(t,n){return p(this,Ut,Qh).call(this,t,n)}removeHead(t){return p(this,Ut,Qh).call(this,t,void 0)}async commit(){const t=await Cv(r(this,Vi).values(),r(this,$i),this);await p(this,Ut,Rv).call(this,t),await this._tx.commit()}async getRefCount(t){const n=await this._tx.get(Gl(t));if(n!==void 0){if(Oe(n),n<0||n>65535||n!==(n|0))throw new Error(`Invalid ref count ${n}. We expect the value to be a Uint16`);return n}}async getRefs(t){const n=await this._tx.get(Cc(t));return n===void 0?[]:(Gy(n),n)}release(){this._tx.release()}},pa=new WeakMap,$i=new WeakMap,Vi=new WeakMap,Ut=new WeakSet,Qh=async function(t,n){const s=await this.getHead(t),i=xv(t);let o;n===void 0?o=this._tx.del(i):o=this._tx.put(i,n);const a=r(this,Vi).get(t);a===void 0?r(this,Vi).set(t,{new:n,old:s}):a.new=n,await o},Rv=async function(t){const n=[];for(const[s,i]of t)if(i===0)n.push(p(this,Ut,Tv).call(this,s));else{const o=Gl(s);n.push(this._tx.put(o,i))}await Promise.all(n)},Tv=async function(t){await Promise.all([this._tx.del(Yc(t)),this._tx.del(Cc(t)),this._tx.del(Gl(t))]),r(this,$i).delete(t)},Nm);function Ov(e){return e.indexName!==void 0}function Jh(e){return typeof e=="string"?[e]:e}function mC(e){if(!e)return{};let t,n,s,i;return e.start&&({key:t,exclusive:n}=e.start,e.indexName?typeof t=="string"?i=t:(i=t[0],s=t[1]):s=t),{prefix:e.prefix,startSecondaryKey:i,startKey:s,startExclusive:n,limit:e.limit,indexName:e.indexName}}var ma,ya,wa,va,ji,Dc,Mm,yC=(Mm=class{constructor(e,t,n,s){l(this,ji);l(this,ma);l(this,ya);l(this,wa);l(this,va);d(this,ma,e),d(this,ya,t),d(this,wa,n),d(this,va,s)}[Symbol.asyncIterator](){return this.values()}values(){return new Bl(p(this,ji,Dc).call(this,e=>e[1]))}keys(){return new Bl(p(this,ji,Dc).call(this,e=>e[0]))}entries(){return new Bl(p(this,ji,Dc).call(this,e=>[e[0],e[1]]))}toArray(){return this.values().toArray()}},ma=new WeakMap,ya=new WeakMap,wa=new WeakMap,va=new WeakMap,ji=new WeakSet,Dc=function(e){return wC(e,r(this,ma),r(this,ya),r(this,wa),r(this,va))},Mm),us,Rm,Bl=(Rm=class{constructor(e){l(this,us);d(this,us,e)}next(){return r(this,us).next()}[Symbol.asyncIterator](){return r(this,us)[Symbol.asyncIterator]()}toArray(){return dw(r(this,us))}},us=new WeakMap,Rm);async function*wC(e,t,n,s,i){var h;xo(s);let{limit:o=1/0}=n;const{prefix:a=""}=n;let u=(h=n.start)==null?void 0:h.exclusive;const c=Ov(n);for await(const m of t){const y=m[0];if(!(c?y[0]:y).startsWith(a))return;if(u){if(u=!0,c){if(vC(y,n.start.key))continue}else if(gC(y,n.start.key))continue}if(yield e(m),--o===0){c||i(y);return}}}function vC(e,t){const[n,s]=Jh(t),[i,o]=Jh(e);return i!==n?!1:s===void 0?!0:o===s}function gC(e,t){return e===t}function bC(e){const{prefix:t,start:n}=e;let s="";if(t!==void 0&&(s=zf(t,void 0)),!n)return s;const{key:i}=n,[o,a]=Jh(i),u=zf(o,a);return Fd(u,s)?u:s}var SC=0,Pv=class{constructor(e,t,n,s="openReadTransaction"){v(this,"clientID");v(this,"dbtx");v(this,"_lc");v(this,"location");v(this,"environment");this.clientID=e,this.dbtx=t,this._lc=n.withContext(s).withContext("txid",SC++),this.environment="client",this.location="client"}get(e){return mv(this.dbtx)||this.dbtx.get(e)}async has(e){return xo(this.dbtx),this.dbtx.has(e)}async isEmpty(){return xo(this.dbtx),this.dbtx.isEmpty()}scan(e){return Av(e,this.dbtx,kC)}};function kC(e){}function Av(e,t,n){const s=CC(t,e);return _C(s,e??{},t,n)}var Gi,Bi,it,Tm,IC=(Tm=class{constructor(e){l(this,Gi,new Set);l(this,Bi,[]);l(this,it);d(this,it,e)}get environment(){return r(this,it).location}get location(){return r(this,it).location}get clientID(){return r(this,it).clientID}isEmpty(){return r(this,Bi).push({options:{}}),r(this,it).isEmpty()}get(e){return r(this,Gi).add(e),r(this,it).get(e)}has(e){return r(this,Gi).add(e),r(this,it).has(e)}scan(e){const t={options:mC(e),inclusiveLimitKey:void 0};return r(this,Bi).push(t),Av(e,r(this,it).dbtx,n=>{t.inclusiveLimitKey=n})}get keys(){return r(this,Gi)}get scans(){return r(this,Bi)}},Gi=new WeakMap,Bi=new WeakMap,it=new WeakMap,Tm),Xh=Symbol(),Om,Pm,Lv=class extends(Pm=Pv,Om=Xh,Pm){constructor(t,n,s,i,o,a,u="openWriteTransaction"){super(t,o,a,u);v(this,"reason");v(this,"mutationID");v(this,Om);this.mutationID=n,this.reason=s,this[Xh]=i}put(t,n){return this.set(t,n)}async set(t,n){xo(this.dbtx),await this.dbtx.put(this._lc,t,n)}del(t){return mv(this.dbtx)??this.dbtx.del(this._lc,t)}};function CC(e,t){return t&&Ov(t)?EC(e,t):e.map.scan(DC(t))}function DC(e){if(!e)return"";const{prefix:t="",start:n}=e;return n&&Fd(n.key,t)?n.key:t}function _C(e,t,n,s){return new yC(e,t,n,s)}async function*EC(e,t){const n=e.getMapForIndex(t.indexName);for await(const s of n.scan(bC(t)))yield[Dl(s[0]),s[1]]}async function Hv(e,t,n,s,i,o,a,u){var k;const c=e.meta,h=c.mutatorName;Cl(c)&&b(c.clientID===o,"mutationClientID must match clientID of LocalMeta");const m=s[h];m||(k=i.error)==null||k.call(i,`Cannot rebase unknown mutator ${h}`);const y=m||(async()=>{}),w=c.mutatorArgsJSON,S=await(await te(n,t)).getNextMutationID(o,t);if(S!==c.mutationID)throw new Error(`Inconsistent mutation ID: original: ${c.mutationID}, next: ${S} - mutationClientID: ${o} mutatorName: ${h}`);f0(c);const I=await vw(n,h,w,e.chunk.hash,t,c.timestamp,o,a),D=new Lv(o,await I.getMutationID(),"rebase",u,I,i);return await y(D,w),I}async function Fv(e,t,n,s,i,o,a,u){return(await Hv(e,t,n,s,i,o,a,u)).putCommit()}async function xC(e,t,n,s,i,o,a,u,c){return(await Hv(e,t,n,i,o,a,u,c)).commit(s)}function NC(e){async function t(n,s){const[i,o]=await uv(e.pushURL,e.auth,s,n);if(!i)return{httpRequestInfo:o};const a={httpRequestInfo:o};let u;try{u=await i.json()}catch{return a}return(Qs(u)||Js(u))&&(a.response=u),a}return zv.add(t),t}var zv=new WeakSet;function MC(e){return zv.has(e)}function $v(e="info",t=[Nn],n){const s=t.length===1?t[0]:new av(t);return new Jc(e,n,s)}function Zc(e){return e instanceof Error?e:new Error(String(e))}var pf=0,RC=1,Vv=2;async function TC(e,t,n){for(const s of n)switch(s.op){case"put":{const i=s.value;await t.put(e,s.key,i);break}case"update":{const i=await t.get(s.key),o=[],a=c=>{for(const[h,m]of Object.entries(c))(!s.constrain||s.constrain.length===0||s.constrain.indexOf(h)>-1)&&o.push([h,m])};i!==void 0&&(Pe(i),a(i)),s.merge&&a(s.merge);const u=Object.fromEntries(o);await t.put(e,s.key,u);break}case"del":{if(await t.get(s.key)===void 0)continue;await t.del(e,s.key);break}case"clear":await t.clear();break}}var jv=class extends Error{constructor(t){super("Failed to pull");v(this,"name","PullError");v(this,"causedBy");this.causedBy=t}},Wc="sync",OC=1;async function PC(e,t,n,s,i,o,a,u,c,h=!0){const m=await pe(a,async I=>{const D=await I.getHead(Ce);if(!D)throw new Error("Internal no main head found");const C=(await Bt(D,I)).meta;return Kd(C),C.cookieJSON}),y={profileID:e,clientGroupID:n,cookie:m,pullVersion:OC,schemaVersion:s},{response:w,httpRequestInfo:g}=await AC(c,i,y,o);if(!w)return{httpRequestInfo:g,syncHead:Ve};if(!h||NI(w))return{httpRequestInfo:g,pullResponse:w,syncHead:Ve};const S=await Gv(c,a,m,w,t,u);return{httpRequestInfo:g,pullResponse:w,syncHead:S.type===pf?S.syncHead:Ve}}async function AC(e,t,n,s){var a,u;(a=e.debug)==null||a.call(e,"Starting pull...");const i=Date.now();let o;try{o=await t(n,s),(u=e.debug)==null||u.call(e,`...Pull ${o.response?"complete":"failed"} in `,Date.now()-i,"ms")}catch(c){throw new jv(Zc(c))}try{return HI(o),o}catch(c){throw new yf("Invalid puller result",Zc(c))}}function ap(e,t,n){return`Received ${e} ${t} is < than last snapshot ${e} ${n}; ignoring client view`}function Gv(e,t,n,s,i,o){return qc(t,async a=>{var S,I,D;const u=a,c=await u.getHead(Ce);if(c===void 0)throw new Error("Main head disappeared");const h=await Bt(c,u),m=h.meta;Kd(m);const y=m.cookieJSON;if(!As(n,y))return(S=e.debug)==null||S.call(e,"handlePullResponse: cookie mismatch, response is not applicable"),{type:Vv};for(const[k,C]of Object.entries(s.lastMutationIDChanges)){const M=m.lastMutationIDs[k];if(M!==void 0&&C<M)throw new Error(ap(`${k} lastMutationID`,String(C),String(M)))}const w=s.cookie;if(jd(w,y)<0)throw new Error(ap("cookie",JSON.stringify(w),JSON.stringify(y)));if(As(w,y))return s.patch.length>0&&((I=e.error)==null||I.call(e,`handlePullResponse: cookie ${JSON.stringify(y)} did not change, but patch is not empty`)),Object.keys(s.lastMutationIDChanges).length>0&&((D=e.error)==null||D.call(e,`handlePullResponse: cookie ${JSON.stringify(y)} did not change, but lastMutationIDChanges is not empty`)),{type:RC};const g=await z0(h.chunk.hash,{...m.lastMutationIDs,...s.lastMutationIDChanges},w,a,i,o);return await TC(e,g,s.patch),{type:pf,syncHead:await g.commit(Wc)}})}function LC(e,t,n,s,i,o){return qc(e,async a=>{var _;const u=a,c=await u.getHead(Wc);if(c===void 0)throw new Error("Missing sync head");if(c!==n)throw(_=t.error)==null||_.call(t,"maybeEndPull, Wrong sync head. Expecting:",n,"got:",c),new Error("Wrong sync head");const h=await Bt(c,u),m=await u.getHead(Ce);if(m===void 0)throw new Error("Missing main head");const y=await Bt(m,u),{meta:w}=h,g=w.basisHash;if(h===null)throw new Error("Sync snapshot with no basis");if(g!==y.chunk.hash)throw new Error("Overlapping syncs");const S=await te(c,u),I=[],D=await Ky(m,u);for(const x of D){let O=s;b(Ju(x)),O=x.meta.clientID,await x.getMutationID(O,u)>await S.getMutationID(O,u)&&I.push(x)}I.reverse();const k=new Jd;if(I.length>0)return{syncHead:c,oldMainHead:m,mainHead:m,replayMutations:I,diffs:k};const C=await te(m,u);if(i.shouldComputeDiffs()){const x=new Gt(u,o,C.valueHash),O=new Gt(u,o,S.valueHash),T=await ko(x,O);k.set("",T),await mw(C,S,u,k,i,o)}await Promise.all([a.setHead(Ce,c),a.removeHead(Wc)]),await a.commit();const M=c;if(t.debug){const[x,O]=Ff(y,s),[T,L]=Ff(h,s);t.debug("Successfully pulled new snapshot with lastMutationID:",T,"(prev:",x,"), cookie: ",L,"(prev:",O,"), sync head hash:",c,", main head hash:",m,", valueHash:",S.valueHash,"(prev:",y.valueHash)}return{syncHead:c,oldMainHead:m,mainHead:M,replayMutations:[],diffs:k}})}function HC(e){Pe(e),lv(e.httpRequestInfo),e.response!==void 0&&FC(e.response)}function FC(e){Qs(e)||MI(e)}var Bv=class extends Error{constructor(t){super("Failed to push");v(this,"name","PushError");v(this,"causedBy");this.causedBy=t}},Yh=1,zC=re({id:f.number(),name:f.string(),args:Kt,timestamp:f.number(),clientID:V0});f.object({pushVersion:f.literal(1),schemaVersion:f.string(),profileID:f.string(),clientGroupID:Xd,mutations:f.array(zC)});function $C(e){return{id:e.mutationID,name:e.mutatorName,args:e.mutatorArgsJSON,timestamp:e.timestamp,clientID:e.clientID}}async function VC(e,t,n,s,i,o,a,u,c){var S,I;const h=await pe(t,async D=>{const k=await D.getHead(Ce);if(!k)throw new Error("Internal no main head");return Ky(k,D)});if(h.length===0)return;h.reverse(),b(c===Yh);const m=[];for(const D of h)if(Ju(D))m.push($C(D.meta));else throw new Error("Internal non local pending commit");b(i);const y={profileID:s,clientGroupID:i,mutations:m,pushVersion:Yh,schemaVersion:u};(S=n.debug)==null||S.call(n,"Starting push...");const w=Date.now(),g=await jC(a,y,e);return(I=n.debug)==null||I.call(n,"...Push complete in ",Date.now()-w,"ms"),g}async function jC(e,t,n){let s;try{s=await e(t,n)}catch(i){throw new Bv(Zc(i))}try{return HC(s),s}catch(i){throw new yf("Invalid pusher result",Zc(i))}}var GC=class{constructor(e){v(this,"name");v(this,"onmessage",null);v(this,"onmessageerror",null);this.name=e}addEventListener(){}removeEventListener(){}dispatchEvent(){return!1}close(){}postMessage(){}},Zh=typeof BroadcastChannel>"u"?GC:BroadcastChannel;function BC(e){return`replicache-new-client-group:${e}`}function UC(e){return`replicache-new-client-group-v1:${e}`}function KC(e){return typeof e=="object"&&typeof e.clientGroupID=="string"&&typeof e.idbName=="string"}function qC(e,t,n,s,i,o,a){if(n.aborted)return;const u=new Zh(UC(e));if(i){u.postMessage({clientGroupID:s,idbName:t});const c=new Zh(BC(e));c.postMessage([s]),c.close()}u.onmessage=async c=>{const{data:h}=c;if(KC(h)){const{clientGroupID:m,idbName:y}=h;if(m!==s)if(y===t)await pe(a,async g=>await _l(m,g)!==void 0)&&o();else{o();return}}},n.addEventListener("abort",()=>u.close(),{once:!0})}function QC(e){return`replicache-on-persist:${e}`}function JC(e){Pe(e),J(e.clientGroupID),J(e.clientID)}function XC(e,t,n){if(t.aborted)return()=>{};const s=new Zh(QC(e));return s.onmessage=i=>{const{data:o}=i;JC(o),n({clientGroupID:o.clientGroupID,clientID:o.clientID})},t.addEventListener("abort",()=>s.close(),{once:!0}),i=>{t.aborted||(s.postMessage(i),n(i))}}async function YC(e){const t=await Vd(Ce,e);return(await qy(t,e)).map(s=>({id:s.meta.mutationID,name:s.meta.mutatorName,args:s.meta.mutatorArgsJSON,clientID:s.meta.clientID})).reverse()}function Ol(e,t,n,s,i){ZC(e,t,n,s,i)}async function ZC(e,t,n,s,i){var o,a,u,c,h;if(!i.aborted){for(s=s.withContext("bgIntervalProcess",e),(o=s.debug)==null||o.call(s,"Starting");!i.aborted;){try{await Mn(n(),i)}catch(m){if(!(m instanceof Ur))throw m}if(!i.aborted){(a=s.debug)==null||a.call(s,"Running");try{await t()}catch(m){i.aborted?(u=s.debug)==null||u.call(s,"Error running most likely due to close.",m):(c=s.error)==null||c.call(s,"Error running.",m)}}}(h=s.debug)==null||h.call(s,"Stopping")}}var Uv="deleted-clients",WC=re({clientIDs:je(f.string()),clientGroupIDs:je(f.string())}),eD=je(f.string());async function Kv(e,t,n){const s={clientIDs:el(t),clientGroupIDs:el(n)},i=s,o=e.createChunk(i,[]);return await e.putChunk(o),await e.setHead(Uv,o.hash),s}async function No(e){const t=await e.getHead(Uv);if(t===void 0)return{clientIDs:[],clientGroupIDs:[]};const n=await e.mustGetChunk(t),s=Sl(n.data,eD);return s.ok?{clientIDs:s.value,clientGroupIDs:[]}:Ct(n.data,WC)}async function qv(e,t,n){const{clientIDs:s,clientGroupIDs:i}=await No(e);return Kv(e,[...s,...t],[...i,...n])}async function tD(e,t,n){const{clientIDs:s,clientGroupIDs:i}=await No(e),o=s.filter(u=>!t.includes(u)),a=i.filter(u=>!n.includes(u));return Kv(e,o,a)}function el(e){return[...new Set(e)].sort()}var nD=24*60*60*1e3,Qv=5*60*1e3,up;function sD(e,t,n,s,i,o,a){Ol("ClientGC",()=>(up=iD(e,t,n,i),up),()=>s,o,a)}function iD(e,t,n,s){return he(t,async i=>{const o=Date.now(),a=await Fs(i),u=[],c=new Map;for(const[y,w]of a)y===e||o-w.heartbeatTimestampMs<=n?c.set(y,w):u.push(y);if(c.size===a.size)return a;await Io(c,i);const{clientIDs:h,clientGroupIDs:m}=await qv(i,u,[]);return s(h,m),c})}var rD=5*60*1e3,cp;function oD(e,t,n,s,i){Ol("ClientGroupGC",()=>(cp=aD(e,t,n),cp),()=>rD,s,i)}function aD(e,t,n){return he(e,async s=>{const i=await Fs(s),o=new Set;for(const c of i.values())o.add(c.clientGroupID);const a=new Map,u=new Set;for(const[c,h]of await Jr(s))o.has(c)||t&&hw(h)?a.set(c,h):u.add(c);return await L0(a,s),n([],[...u].sort()),a})}var uD=0,cD="replicache-dbs-v"+uD,lD="";function hD(){return lD+cD}var _c="dbs",lp="profileId";function dD(e){Pe(e);for(const[t,n]of Object.entries(e))J(t),fD(n),b(t===n.name)}function fD(e){Pe(e),J(e.name),J(e.replicacheName),Oe(e.replicacheFormatVersion),J(e.schemaVersion),e.lastOpenedTimestampMS!==void 0&&Oe(e.lastOpenedTimestampMS)}var pt,ga,Wh,Am,Jv=(Am=class{constructor(e){l(this,ga);l(this,pt);d(this,pt,e(hD()))}putDatabase(e){return p(this,ga,Wh).call(this,{...e,lastOpenedTimestampMS:Date.now()})}putDatabaseForTesting(e){return p(this,ga,Wh).call(this,e)}clearDatabases(){return he(r(this,pt),e=>e.del(_c))}deleteDatabases(e){return he(r(this,pt),async t=>{const s={...await Ul(t)};for(const i of e)delete s[i];await t.put(_c,s)})}getDatabases(){return pe(r(this,pt),Ul)}close(){return r(this,pt).close()}getProfileID(){return he(r(this,pt),async e=>{let t=await e.get(lp);return t===void 0&&(t=`p${Yd()}`,await e.put(lp,t)),J(t),t})}},pt=new WeakMap,ga=new WeakSet,Wh=function(e){return he(r(this,pt),async t=>{const s={...await Ul(t),[e.name]:e};return await t.put(_c,s),s})},Am);async function Ul(e){let t=await e.get(_c);return t||(t={}),dD(t),t}var pD=12*60*60*1e3,mD=5*60*1e3;function yD(e,t,n,s,i,o,a,u,c){let h=!0;Ol("CollectIDBDatabases",async()=>{await wD(e,Date.now(),i,t,o,a)},()=>h?(h=!1,s):n,u,c)}async function wD(e,t,n,s,i,o,a=gD){const u=await e.getDatabases(),c=Object.values(u),h=await Promise.all(c.map(async I=>[I.name,await bD(I,t,n,i,a)])),m=[],y=[],w=[],g=[];for(const[I,[D,k,C]]of h)D?(m.push(I),w.push(...k),g.push(...C)):y.push(I);const{errors:S}=await vD(e,m,s);if(S.length)throw S[0];if(w.length||g.length){const I=w,D=g;for(const k of y)await he(a(k),async C=>{const{clientIDs:M,clientGroupIDs:_}=await qv(C,w,g);I.push(...M),D.push(..._)});o(el(I),el(D))}}async function Xv(e,t,n){await n(e),await t.deleteDatabases([e])}async function vD(e,t,n){const s=await Promise.allSettled(t.map(async a=>(await Xv(a,e,n),a))),i=[],o=[];for(const a of s)a.status==="fulfilled"?i.push(a.value):o.push(a.reason);return{dropped:i,errors:o}}function gD(e){const t=new Xc(e);return new Nv(t,It,Gr)}function bD(e,t,n,s,i){return e.replicacheFormatVersion>Ie?[!1]:(b(e.lastOpenedTimestampMS!==void 0),t-e.lastOpenedTimestampMS<n?[!1]:(b(e.replicacheFormatVersion===Vc||e.replicacheFormatVersion===VS||e.replicacheFormatVersion===So),kD(s,i(e.name))))}async function SD(e,t){const n=$v(t==null?void 0:t.logLevel,t==null?void 0:t.logSinks,{dropDatabase:void 0}),s=dg(n,t==null?void 0:t.kvStore);await Xv(e,new Jv(s.create),s.drop)}function kD(e,t){return pe(t,async n=>{if(e){const c=await Jr(n);for(const h of c.values())if(hw(h))return[!1]}const s=await Fs(n),{clientIDs:i,clientGroupIDs:o}=await No(n),a=[...i],u=[...o];for(const[c,h]of s)a.push(c),u.push(h.clientGroupID);return[!0,a,u]})}var Yv=60*1e3,hp;function ID(e,t,n,s,i,o){Ol("Heartbeat",async()=>{hp=CD(e,t);try{return await hp}catch(a){if(a instanceof En){n();return}throw a}},()=>s,i,o)}function CD(e,t){return he(t,async n=>{const s=await Fs(n),i=s.get(e);if(!i)throw new En(e);const o={...i,heartbeatTimestampMs:Date.now()},a=new Map(s).set(e,o);return await Io(a,n),a})}var ba,Sa,Lm,Zv=(Lm=class{constructor(e){l(this,ba,new Set);l(this,Sa);d(this,Sa,e)}async visit(e){if(r(this,ba).has(e))return;r(this,ba).add(e);const t=await r(this,Sa).mustGetChunk(e);await this.visitChunk(t)}async visitChunk(e){await Promise.all(e.meta.map(t=>this.visit(t)))}},ba=new WeakMap,Sa=new WeakMap,Lm),ka,Ia,Hm,DD=(Hm=class extends Zv{constructor(t){super(t);l(this,ka,new Map);l(this,Ia);d(this,Ia,t)}get gatheredChunks(){return r(this,ka)}visit(t){return r(this,Ia).isMemOnlyChunkHash(t)?super.visit(t):me}visitChunk(t){return r(this,ka).set(t.hash,t),super.visitChunk(t)}},ka=new WeakMap,Ia=new WeakMap,Hm);async function _D(e,t,n,s,i,o,a,u,c=()=>Promise.resolve()){if(o())return;const[h,m,y]=await pe(s,async k=>{await Q0(t,k);const C=await xw(t,k);b(C,`No main client group for clientID: ${t}`);const[,M]=await dp(k,C),_=await M.getMutationID(t,k),x=await yo(M,k);return Ns(x),[_,x,C]});if(o())return;const[w,g,S]=await pe(n,async k=>{const C=await Ud(Ce,k),M=await Qy(C,{[t]:h||0},k),_=await yo(C,k);Ns(_);let x;if(hh(_,m)>0){await c();const O=_.chunk.hash,T=new DD(k);await T.visit(O),x=T.gatheredChunks}return[M,_,x]});if(o())return;let I=!1;const D=u&&await u(g.chunk.hash);await he(s,async k=>{const[C,M]=await dp(k,y);let _=M.chunk.hash,x={...C.mutationIDs},{lastServerAckdMutationIDs:O}=C;if(S){const P=await mh(t,k);Iw(P);const X=await yo(M,k);if(Ns(X),hh(g,X)>0){I=!0,await Promise.all(Array.from(S.values(),oe=>k.putChunk(oe))),await yh(t,{...P,persistHash:g.chunk.hash},k),_=g.chunk.hash;const Y=await qy(C.headHash,k);O=g.meta.lastMutationIDs,x={...O},_=await fp(Y,_,k,i,x,e,a,D)}}let T;I||(T=u&&await u(_,{openLazySourceRead:k})),_=await fp(w,_,k,i,x,e,a,T??D);const L={...C,headHash:_,mutationIDs:x,lastServerAckdMutationIDs:O};await Qd(y,L,k)}),S&&I&&await he(n,k=>k.chunksPersisted([...S.keys()]))}async function dp(e,t){const n=await _l(t,e);return b(n,`No client group for clientGroupID: ${t}`),[n,await te(n.headHash,e)]}async function fp(e,t,n,s,i,o,a,u){for(let c=e.length-1;c>=0;c--){const h=e[c],{meta:m}=h,y=await te(t,n);await h.getMutationID(m.clientID,n)>await y.getMutationID(m.clientID,n)&&(i[m.clientID]=m.mutationID,t=(await Fv(h,n,t,s,o,m.clientID,a,u)).chunk.hash)}return t}var Ca,Ui,Da,Ki,_a,Fm,ED=(Fm=class extends Zv{constructor(t,n,s,i=xs){super(t);l(this,Ca,new Map);l(this,Ui,0);l(this,Da);l(this,Ki);l(this,_a);d(this,Da,n),d(this,Ki,s),d(this,_a,i)}get gatheredChunks(){return r(this,Ca)}visit(t){return r(this,Ui)>=r(this,Ki)||r(this,Da).isCached(t)?me:super.visit(t)}visitChunk(t){if(r(this,Ui)<r(this,Ki)){const n=r(this,_a).call(this,t);r(this,Ca).set(t.hash,{chunk:t,size:n}),d(this,Ui,r(this,Ui)+n)}return super.visitChunk(t)}},Ca=new WeakMap,Ui=new WeakMap,Da=new WeakMap,Ki=new WeakMap,_a=new WeakMap,Fm),xD=5*2**20,ND=300;async function MD(e,t,n,s,i,o,a,u,c){if(a())return;const h=await pe(t,w=>d0(Ce,w));Ns(h);const m=await t.withSuspendedSourceCacheEvictsAndDeletes(async()=>{const w=await he(n,async C=>{const M=await W0(s,C);if(!M)throw new En(s);const _=M.headHash,O=await(await te(_,C)).getMutationID(s,C),T=await mh(s,C);Iw(T);const L=await Bt(_,C);if(Ns(L),pp(h,L,_))return;const P=new ED(C,t,xD);await P.visit(_);const{gatheredChunks:X}=P,Y=new Set(T.refreshHashes);Y.add(_);const oe={...T,refreshHashes:[...Y]};return await yh(s,oe,C),[_,L,O,X,T.refreshHashes]});if(a()||!w)return{type:"aborted"};if(await Mn(ND),a())return{type:"aborted"};const[g,S,I,D,k]=w;return he(t,async C=>{var X;const M=await Ud(Ce,C),_=await yo(M,C);if(Ns(_),pp(_,S,g))return{type:"aborted",refreshHashesForRevert:k};const x=await Qy(M,{[s]:I},C),O=[];for(const{chunk:Y,size:oe}of D.values())O.push(C.putChunk(Y,oe));await Promise.all(O);let T=g;if(x.length>0){const Y=await((X=c==null?void 0:c.getTxData)==null?void 0:X.call(c,T,{openLazyRead:C}));for(let oe=x.length-1;oe>=0;oe--)T=(await Fv(x[oe],C,T,i,e,x[oe].meta.clientID,u,Y)).chunk.hash}const L=await te(T,C),P=await pw(M,L,C,o,u);return await C.setHead(Ce,T),{type:"complete",diffs:P,oldHead:M.chunk.hash,newHead:T,newPerdagClientHeadHash:g}})});if(a())return;const y=w=>he(n,async g=>{const I={...await mh(s,g),refreshHashes:w};await yh(s,I,g)});if(m.type==="aborted"){m.refreshHashesForRevert&&await y(m.refreshHashesForRevert);return}return c==null||c.advance(m.oldHead,m.newHead,m.diffs.get("")??[]),await y([m.newPerdagClientHeadHash]),{oldHead:m.oldHead,newHead:m.newHead,diffs:m.diffs}}function pp(e,t,n){const s=hh(e,t);return s>0||s===0&&n===t.chunk.hash}function RD(e){return new Promise(t=>{typeof requestIdleCallback=="function"?requestIdleCallback(()=>t(),{timeout:e}):setTimeout(()=>t(),e)})}var Ea,xa,Na,cs,Ma,Le,Tt,qi,Ra,ll,Wv,zm,mp=(zm=class{constructor(e,t,n,s,i=RD){l(this,ll);l(this,Ea);l(this,xa);l(this,Na);l(this,cs);l(this,Ma);l(this,Le);l(this,Tt);l(this,qi,Promise.resolve());l(this,Ra,Promise.resolve());d(this,Ea,e),d(this,xa,t),d(this,Na,n),d(this,cs,s),d(this,Ma,i),r(this,cs).addEventListener("abort",()=>{var a,u;const o=new Ur("Aborted");(a=r(this,Tt))==null||a.reject(o),(u=r(this,Le))==null||u.reject(o),d(this,Tt,void 0),d(this,Le,void 0)},{once:!0})}schedule(){return r(this,cs).aborted?Promise.reject(new Ur("Aborted")):r(this,Le)?r(this,Le).promise:(d(this,Le,$()),p(this,ll,Wv).call(this),r(this,Le).promise)}},Ea=new WeakMap,xa=new WeakMap,Na=new WeakMap,cs=new WeakMap,Ma=new WeakMap,Le=new WeakMap,Tt=new WeakMap,qi=new WeakMap,Ra=new WeakMap,ll=new WeakSet,Wv=async function(){var e,t;try{await r(this,qi)}catch{}if(await r(this,Ra),!!r(this,Le)&&(await r(this,Ma).call(this,r(this,xa)),!!r(this,Le))){d(this,Ra,TD(r(this,Na),r(this,cs))),d(this,Tt,r(this,Le)),d(this,Le,void 0);try{d(this,qi,r(this,Ea).call(this)),await r(this,qi),(e=r(this,Tt))==null||e.resolve()}catch(n){(t=r(this,Tt))==null||t.reject(n)}d(this,Tt,void 0)}},zm);async function TD(e,t){try{await Mn(e,t)}catch(n){b(n instanceof Ur)}}function OD(e,t,n){if(!n.aborted){const s=setInterval(e,t);n.addEventListener("abort",()=>{clearInterval(s)})}}var ed=0,PD=1,AD=new Set,yp=Symbol(),Ta,Oa,Qi,Pa,Ji,Aa,$m,LD=($m=class{constructor(e,t,n,s,i=As){l(this,Ta);l(this,Oa);l(this,Qi,yp);l(this,Pa,AD);l(this,Ji,[]);v(this,"onError");v(this,"onDone");l(this,Aa);d(this,Ta,e),d(this,Oa,t),this.onError=n,this.onDone=s,d(this,Aa,i)}hasIndexSubscription(e){for(const t of r(this,Ji))if(t.options.indexName===e)return!0;return!1}invoke(e,t,n){return r(this,Ta).call(this,e)}matches(e){for(const[t,n]of e)if(zD(r(this,Pa),r(this,Ji),t,n))return!0;return!1}updateDeps(e,t){d(this,Pa,e),d(this,Ji,t)}onData(e){(r(this,Qi)===yp||!r(this,Aa).call(this,r(this,Qi),e))&&(d(this,Qi,e),r(this,Oa).call(this,e))}},Ta=new WeakMap,Oa=new WeakMap,Qi=new WeakMap,Pa=new WeakMap,Ji=new WeakMap,Aa=new WeakMap,$m),La,ls,Ot,Ha,Vm,HD=(Vm=class{constructor(e,t){l(this,La);l(this,ls);l(this,Ot);l(this,Ha);v(this,"onError");v(this,"onDone");d(this,La,e),d(this,ls,(t==null?void 0:t.prefix)??""),d(this,Ot,t==null?void 0:t.indexName),d(this,Ha,(t==null?void 0:t.initialValuesInFirstDiff)??!1)}hasIndexSubscription(e){return r(this,Ot)===e}onData(e){e!==void 0&&r(this,La).call(this,e)}invoke(e,t,n){const s=async(i,o,a,u)=>{let c;if(t===ed){if(!r(this,Ha))return;b(n===void 0);const y=[];for await(const w of e.scan({prefix:o,indexName:i}).entries())y.push({op:"add",key:w[0],newValue:w[1]});c=y}else{b(n);const y=n.get(i??"")??[];c=u(y)}const h=[],{length:m}=c;for(let y=mf(c,o,a);y<m&&a(c[y]).startsWith(o);y++)h.push(c[y]);return t===ed||h.length>0?h:void 0};return r(this,Ot)?s(r(this,Ot),r(this,ls),i=>i.key[0],i=>wp(i,Dl)):s(void 0,r(this,ls),i=>i.key,i=>wp(i,o=>o))}matches(e){const t=e.get(r(this,Ot)??"");return t===void 0?!1:GD(t,r(this,ls),r(this,Ot))}updateDeps(e,t){}},La=new WeakMap,ls=new WeakMap,Ot=new WeakMap,Ha=new WeakMap,Vm);function wp(e,t){return e.map(n=>{const s=t(n.key);switch(n.op){case"add":return{op:"add",key:s,newValue:n.newValue};case"change":return{op:"change",key:s,oldValue:n.oldValue,newValue:n.newValue};case"del":return{op:"del",key:s,oldValue:n.oldValue}}})}var mt,Xi,Fa,za,$a,Ls,td,eg,jm,FD=(jm=class{constructor(e,t,n){l(this,Ls);l(this,mt,new Set);l(this,Xi,new Set);l(this,Fa);l(this,za);v(this,"hasPendingSubscriptionRuns",!1);l(this,$a);d(this,Fa,e),d(this,za,t),d(this,$a,n)}add(e){return r(this,mt).add(e),p(this,Ls,eg).call(this,e),()=>r(this,mt).delete(e)}clear(){var e;for(const t of r(this,mt))(e=t.onDone)==null||e.call(t);r(this,mt).clear()}fire(e){const t=jD(r(this,mt),e);return p(this,Ls,td).call(this,t,PD,e)}callCallbacks(e,t){var n,s;for(let i=0;i<e.length;i++){const o=e[i],a=t[i];a.status==="fulfilled"?o.onData(a.value):o.onError?o.onError(a.reason):(s=(n=r(this,za)).error)==null||s.call(n,"Error in subscription body:",a.reason)}}shouldComputeDiffs(){return r(this,mt).size>0}shouldComputeDiffsForIndex(e){for(const t of r(this,mt))if(t.hasIndexSubscription(e))return!0;return!1}},mt=new WeakMap,Xi=new WeakMap,Fa=new WeakMap,za=new WeakMap,$a=new WeakMap,Ls=new WeakSet,td=async function(e,t,n){if(r(this,$a).aborted)return;const s=[...e];if(s.length===0)return;const i=await r(this,Fa).call(this,o=>Promise.allSettled(s.map(async a=>{const u=new IC(o);try{return await a.invoke(u,t,n)}finally{a.updateDeps(u.keys,u.scans)}})));this.callCallbacks(s,i)},eg=async function(e){if(r(this,Xi).add(e),!this.hasPendingSubscriptionRuns){this.hasPendingSubscriptionRuns=!0,await Promise.resolve(),this.hasPendingSubscriptionRuns=!1;const t=[...r(this,Xi)];r(this,Xi).clear(),await p(this,Ls,td).call(this,t,ed,void 0)}},jm);function zD(e,t,n,s){if(n===""){for(const i of s)if(e.has(i.key))return!0}for(const i of t)if($D(i,n,s))return!0;return!1}function $D(e,t,n){for(const s of n)if(VD(e,t,s.key))return!0;return!1}function VD(e,t,n){const{indexName:s="",limit:i,prefix:o,startKey:a,startExclusive:u,startSecondaryKey:c}=e.options;if(t!==s)return!1;if(!s)return i!==void 0&&i<=0?!1:!o&&!a?!0:!(o&&(!n.startsWith(o)||vp(e,n))||a&&(u&&Hl(n,a)||Ll(n,a)||vp(e,n)));if(!o&&!a&&!c)return!0;const[h,m]=Dl(n);return!(o&&!h.startsWith(o)||c&&(u&&Hl(h,c)||Ll(h,c))||a&&(u&&Hl(m,a)||Ll(m,a)))}function vp(e,t){const{inclusiveLimitKey:n}=e;return e.options.limit!==void 0&&n!==void 0&&Fd(t,n)}function*jD(e,t){for(const n of e)n.matches(t)&&(yield n)}function GD(e,t,n){if(t==="")return!0;const s=n?o=>Dl(o.key)[0]:o=>o.key,i=mf(e,t,s);return i<e.length&&s(e[i]).startsWith(t)}function mf(e,t,n){return My(e.length,s=>Ye(t,n(e[s])))}var Kl="";function BD(){if(Kl===""){const e=new Uint8Array(4);Hw(e),Kl=Array.from(e,t=>t.toString(16)).join("")}return Kl}var gp=new Map;function bp(e){const t=gp.get(e)??0;return gp.set(e,t+1),`${e}-${BD()}-${t}`}var UD="15.2.1",KD=8,qD=1e3,QD=1e3,JD=500,XD=500,YD=100*2**20,ZD=5*60*1e3,ac=()=>{},WD={type:"NewClientGroup"},Yi,Se,Rd,Va,E,tg,qe,Zi,hl,xe,Wi,rt,hn,ja,Ga,er,hs,Ba,dn,z,fe,yt,dl,Ua,Ka,qa,fl,Qa,pl,ng,Ja,nd,sg,ig,sd,id,rg,og,Ec,rd,co,xc,od,ad,ag,ug,ud,Ln,Xa,cg,lg,hg,Nc,Gm,e_=(Gm=class{constructor(e,t={}){l(this,E);v(this,"pullURL");v(this,"pushURL");l(this,Yi);v(this,"name");l(this,Se);l(this,Rd);v(this,"isClientGroupDisabled",!1);l(this,Va);v(this,"lastMutationID",0);v(this,"schemaVersion");l(this,qe,!1);l(this,Zi,!0);l(this,hl,Yd());l(this,xe);l(this,Wi);l(this,rt);l(this,hn,{});v(this,"mutate");l(this,ja,0);l(this,Ga,0);l(this,er);l(this,hs);v(this,"pullInterval");v(this,"pushDelay");l(this,Ba);v(this,"puller");v(this,"pusher");v(this,"memdag");v(this,"perdag");l(this,dn);l(this,z);l(this,fe);l(this,yt,new AbortController);l(this,dl,new Ku);l(this,Ua);l(this,Ka);l(this,qa);l(this,fl,new mp(()=>this.persist(),qD,JD,r(this,yt).signal));l(this,Qa);l(this,pl,new mp(()=>this.refresh(),QD,XD,r(this,yt).signal));v(this,"onSync",null);v(this,"onClientStateNotFound",kp);v(this,"onUpdateNeeded",kp);v(this,"getAuth",null);v(this,"onPushInvoked",()=>{});v(this,"onBeginPull",()=>{});v(this,"onRecoverMutations",e=>e);l(this,Ja,async()=>{var e;r(this,qe)||((e=ze("document"))==null?void 0:e.visibilityState)==="visible"&&await p(this,E,nd).call(this)});v(this,"onOnlineChange",null);l(this,Xa,async e=>{await r(this,xe);const{clientID:t}=this;return pe(this.memdag,async n=>{try{const s=await D0(n,Ie),i=new Pv(t,s,r(this,z));return await e(i)}catch(s){throw await p(this,E,Nc).call(this,s)}})});var R,j;t_(e);const{name:n,logLevel:s="info",logSinks:i=[Nn],pullURL:o="",auth:a,pushDelay:u=10,pushURL:c="",schemaVersion:h="",pullInterval:m=6e4,mutators:y={},requestOptions:w={},puller:g,pusher:S,indexes:I={},clientMaxAgeMs:D=nD}=e,{enableMutationRecovery:k=!0,enableScheduledPersist:C=!0,enableScheduledRefresh:M=!0,enablePullAndPushInOpen:_=!0,enableClientGroupForking:x=!0,onClientsDeleted:O=()=>{}}=t;d(this,fe,t.zero),d(this,Yi,a??""),this.pullURL=o,this.pushURL=c,this.name=n,this.schemaVersion=h,this.pullInterval=m,this.pushDelay=u,this.puller=g??OI(this),this.pusher=S??NC(this),d(this,Ua,C),d(this,Ka,M),d(this,qa,_),d(this,z,$v(s,i,{name:n})),(j=(R=r(this,z)).debug)==null||j.call(R,"Constructing Replicache",{name:n,"replicache version":UD}),d(this,Se,new FD(r(this,Xa),r(this,z),r(this,yt).signal));const T=dg(r(this,z),e.kvStore);d(this,Va,T);const L=T.create(this.idbName);d(this,dn,new Jv(T.create)),this.perdag=new Nv(L,It,Gr),this.memdag=new hC(this.perdag,YD,It,Gr);const P=$();d(this,xe,P.promise);const{minDelayMs:X=iC,maxDelayMs:Y=rC}=w;d(this,Ba,{maxDelayMs:Y,minDelayMs:X});const oe=bv(ze("document"),0,r(this,yt).signal);d(this,er,new rp(r(this,z).withContext("PULL"),new eC(this,()=>p(this,E,sg).call(this)),oe)),d(this,hs,new rp(r(this,z).withContext("PUSH"),new tC(this,()=>p(this,E,og).call(this)))),this.mutate=p(this,E,lg).call(this,y);const ec=$();d(this,Wi,ec.promise);const Xr=$();d(this,rt,Xr.promise),d(this,Qa,XC(this.name,r(this,yt).signal,Z=>{p(this,E,ag).call(this,Z)})),p(this,E,ng).call(this,I,x,k,D,ec.resolve,Xr.resolve,P.resolve,O)}get idbName(){return s_(this.name,this.schemaVersion)}set auth(e){r(this,fe)&&(r(this,fe).auth=e),d(this,Yi,e)}get auth(){return r(this,Yi)}get requestOptions(){return r(this,Ba)}get profileID(){return r(this,Wi)}get clientID(){return r(this,hl)}get clientGroupID(){return r(this,rt)}get online(){return r(this,Zi)}get closed(){return r(this,qe)}async close(){var s;d(this,qe,!0);const{promise:e,resolve:t}=$();ql.set(this.name,e),r(this,yt).abort(),(s=ze("document"))==null||s.removeEventListener("visibilitychange",r(this,Ja)),await r(this,xe);const n=[this.memdag.close(),this.perdag.close(),r(this,dn).close()];r(this,er).close(),r(this,hs).close(),r(this,Se).clear(),await Promise.all(n),ql.delete(this.name),t()}async maybeEndPull(e,t){var n,s,i;for(;;){if(r(this,qe))return;await r(this,xe);const{clientID:o}=this,a=r(this,z).withContext("maybeEndPull").withContext("requestID",t),{replayMutations:u,diffs:c,oldMainHead:h,mainHead:m}=await LC(this.memdag,a,e,o,r(this,Se),Ie);if(!u||u.length===0){(n=r(this,fe))==null||n.advance(h,m,c.get("")??[]),await r(this,Se).fire(c),p(this,E,ad).call(this);return}const y=await((i=(s=r(this,fe))==null?void 0:s.getTxData)==null?void 0:i.call(s,e));for(const w of u){r(this,Se).hasPendingSubscriptionRuns&&await Promise.resolve();const{meta:g}=w;e=await qc(this.memdag,S=>xC(w,S,e,Wc,r(this,hn),a,Cl(g)?g.clientID:o,Ie,y))}}}push({now:e=!1}={}){return Sp(r(this,hs).send(e))}pull({now:e=!1}={}){return Sp(r(this,er).send(e))}async poke(e){await r(this,xe);const{clientID:t}=this,n=bp(t),s=r(this,z).withContext("handlePullResponse").withContext("requestID",n),{pullResponse:i}=e;if(Js(i)){p(this,E,Ec).call(this,i);return}if(Qs(i)){await p(this,E,xc).call(this);return}const o=await Gv(s,this.memdag,e.baseCookie,i,t,Ie);switch(o.type){case pf:await this.maybeEndPull(o.syncHead,n);break;case Vv:throw new Error("unexpected base cookie for poke: "+JSON.stringify(e))}}async beginPull(){await r(this,xe);const e=await this.profileID,{clientID:t}=this,n=await r(this,rt),{result:{beginPullResponse:s,requestID:i}}=await p(this,E,id).call(this,async(c,h)=>{const m=await PC(e,t,n,this.schemaVersion,this.puller,c,this.memdag,Ie,h);return{result:{beginPullResponse:m,requestID:c},httpRequestInfo:m.httpRequestInfo}},"pull",r(this,z),()=>p(this,E,Ln).call(this,0,-1),()=>p(this,E,Ln).call(this,0,1)),{pullResponse:o}=s;Js(o)?p(this,E,Ec).call(this,o):Qs(s.pullResponse)&&await p(this,E,xc).call(this);const{syncHead:a,httpRequestInfo:u}=s;return{requestID:i,syncHead:a,ok:u.httpStatusCode===200}}persist(){return r(this,dl).withLock(async()=>{var n,s,i;const{clientID:e}=this;if(await r(this,xe),r(this,qe))return;try{await _D(r(this,z),e,this.memdag,this.perdag,r(this,hn),()=>r(this,qe),Ie,(n=r(this,fe))==null?void 0:n.getTxData)}catch(o){if(o instanceof En)p(this,E,co).call(this,e);else if(r(this,qe))(i=(s=r(this,z)).debug)==null||i.call(s,"Exception persisting during close",o);else throw o}const t=await r(this,rt);b(t),r(this,Qa).call(this,{clientID:e,clientGroupID:t})})}async refresh(){var n,s;await r(this,xe);const{clientID:e}=this;if(r(this,qe))return;let t;try{t=await MD(r(this,z),this.memdag,this.perdag,e,r(this,hn),r(this,Se),()=>this.closed,Ie,r(this,fe))}catch(i){if(i instanceof En)p(this,E,co).call(this,e);else if(r(this,qe))(s=(n=r(this,z)).debug)==null||s.call(n,"Exception refreshing during close",i);else throw i}t!==void 0&&await r(this,Se).fire(t.diffs)}async disableClientGroup(){const e=await r(this,rt);b(e),this.isClientGroupDisabled=!0,await he(this.perdag,t=>H0(e,t))}subscribe(e,t){typeof t=="function"&&(t={onData:t});const{onData:n,onError:s,onDone:i,isEqual:o}=t;return r(this,Se).add(new LD(e,n,s,i,o))}experimentalWatch(e,t){return r(this,Se).add(new HD(e,t))}query(e){return r(this,Xa).call(this,e)}get cookie(){return r(this,xe).then(()=>pe(this.memdag,async e=>{const t=await e.getHead(Ce);if(!t)throw new Error("Internal no main head found");const i=(await Bt(t,e)).meta.cookieJSON;return Vy(i),i}))}recoverMutations(){}experimentalPendingMutations(){return pe(this.memdag,YC)}},Yi=new WeakMap,Se=new WeakMap,Rd=new WeakMap,Va=new WeakMap,E=new WeakSet,tg=function(){return{name:this.idbName,replicacheName:this.name,replicacheFormatVersion:Ie,schemaVersion:this.schemaVersion}},qe=new WeakMap,Zi=new WeakMap,hl=new WeakMap,xe=new WeakMap,Wi=new WeakMap,rt=new WeakMap,hn=new WeakMap,ja=new WeakMap,Ga=new WeakMap,er=new WeakMap,hs=new WeakMap,Ba=new WeakMap,dn=new WeakMap,z=new WeakMap,fe=new WeakMap,yt=new WeakMap,dl=new WeakMap,Ua=new WeakMap,Ka=new WeakMap,qa=new WeakMap,fl=new WeakMap,Qa=new WeakMap,pl=new WeakMap,ng=async function(e,t,n,s,i,o,a,u){var g,S;const{clientID:c}=this;await ql.get(this.name),await r(this,dn).getProfileID().then(i),await r(this,dn).putDatabase(r(this,E,tg));const[h,m,,y]=await J0(c,r(this,z),this.perdag,Object.keys(r(this,hn)),e,Ie,t);o(h.clientGroupID),await he(this.memdag,I=>I.setHead(Ce,m)),await((g=r(this,fe))==null?void 0:g.init(m,this.memdag)),a(),r(this,qa)&&(this.pull().catch(ac),this.push().catch(ac));const{signal:w}=r(this,yt);ID(c,this.perdag,()=>{p(this,E,co).call(this,c)},Yv,r(this,z),w),sD(c,this.perdag,s,Qv,u,r(this,z),w),yD(r(this,dn),r(this,Va).drop,pD,mD,2*s,n,u,r(this,z),w),oD(this.perdag,n,u,r(this,z),w),qC(this.name,this.idbName,w,h.clientGroupID,y,()=>{p(this,E,od).call(this,WD)},this.perdag),OD(()=>this.recoverMutations(),ZD,w),this.recoverMutations(),(S=ze("document"))==null||S.addEventListener("visibilitychange",r(this,Ja))},Ja=new WeakMap,nd=async function(){const{clientID:e}=this,t=await pe(this.perdag,n=>Cw(e,n));return t||p(this,E,co).call(this,e),!t},sg=function(){return p(this,E,ig).call(this)?Promise.resolve(!0):p(this,E,sd).call(this,async()=>{try{p(this,E,Ln).call(this,0,1);const{syncHead:e,requestID:t,ok:n}=await this.beginPull();if(!n)return!1;e!==Ve&&await this.maybeEndPull(e,t)}catch(e){throw await p(this,E,Nc).call(this,e)}finally{p(this,E,Ln).call(this,0,-1)}return!0},"Pull")},ig=function(){return this.isClientGroupDisabled||this.pullURL===""&&PI(this.puller)},sd=async function(e,t){var s,i,o,a,u,c,h;let n=!0;try{return await e()}catch(m){return m instanceof Bv||m instanceof jv?(n=!1,(i=(s=r(this,z)).debug)==null||i.call(s,`${t} threw:
`,m,`
with cause:
`,m.causedBy)):m instanceof yf?(a=(o=r(this,z)).error)==null||a.call(o,m):(c=(u=r(this,z)).info)==null||c.call(u,`${t} threw:
`,m),!1}finally{r(this,Zi)!==n&&(d(this,Zi,n),(h=this.onOnlineChange)==null||h.call(this,n),n&&this.recoverMutations())}},id=async function(e,t,n,s=ac,i=ac){var c,h;const{clientID:o}=this;let a=0,u;n=n.withContext(t);do{const m=bp(o),y=n.withContext("requestID",m),{httpRequestInfo:w,result:g}=await e(m,y);if(u=g,!w)return{result:g,authFailure:!1};const{errorMessage:S,httpStatusCode:I}=w;if((S||I!==200)&&((c=y.error)==null||c.call(y,`Got a non 200 response doing ${t}: ${I}`+(S?`: ${S}`:""))),I!==n_)return{result:g,authFailure:!1};if(!this.getAuth)return{result:g,authFailure:!0};let D;try{await s(),D=await this.getAuth()}finally{await i()}if(D==null)return{result:g,authFailure:!0};this.auth=D,a++}while(a<KD);return(h=n.info)==null||h.call(n,"Tried to reauthenticate too many times"),{result:u,authFailure:!0}},rg=function(){return this.isClientGroupDisabled||this.pushURL===""&&MC(this.pusher)},og=async function(){if(p(this,E,rg).call(this))return!0;await r(this,xe);const e=await r(this,Wi),{clientID:t}=this,n=await r(this,rt);return p(this,E,sd).call(this,async()=>{const{result:s}=await p(this,E,id).call(this,async(a,u)=>{try{p(this,E,Ln).call(this,1,0);const c=await VC(a,this.memdag,u,e,n,t,this.pusher,this.schemaVersion,Yh);return{result:c,httpRequestInfo:c==null?void 0:c.httpRequestInfo}}finally{p(this,E,Ln).call(this,-1,0)}},"push",r(this,z));if(s===void 0)return!0;const{response:i,httpRequestInfo:o}=s;return Js(i)?p(this,E,Ec).call(this,i):Qs(i)&&await p(this,E,xc).call(this),o.httpStatusCode===200},"Push")},Ec=function(e){const t={type:e.error};e.versionType&&(t.versionType=e.versionType),p(this,E,od).call(this,t)},rd=function(){var e;(e=this.onClientStateNotFound)==null||e.call(this)},co=function(e){var t,n;(n=(t=r(this,z)).error)==null||n.call(t,`Client state not found on client, clientID: ${e}`),p(this,E,rd).call(this)},xc=async function(){var t,n;const e=await r(this,rt);(n=(t=r(this,z)).error)==null||n.call(t,`Client state not found on server, clientGroupID: ${e}`),await this.disableClientGroup(),p(this,E,rd).call(this)},od=function(e){var t,n,s;(n=(t=r(this,z)).debug)==null||n.call(t,`Update needed, reason: ${e}`),(s=this.onUpdateNeeded)==null||s.call(this,e)},ad=async function(){r(this,Ua)&&await p(this,E,ud).call(this,"persist",r(this,fl))},ag=async function(e){var n,s;(s=(n=r(this,z)).debug)==null||s.call(n,"Handling persist",e);const t=await r(this,rt);e.clientGroupID===t&&p(this,E,ug).call(this)},ug=async function(){r(this,Ka)&&await p(this,E,ud).call(this,"refresh from storage",r(this,pl))},ud=async function(e,t){var n,s,i,o;try{await t.schedule()}catch(a){a instanceof Ur?(s=(n=r(this,z)).debug)==null||s.call(n,`Scheduled ${e} did not complete before close.`):(o=(i=r(this,z)).error)==null||o.call(i,`Error during ${e}`,a)}},Ln=function(e,t){d(this,ja,r(this,ja)+e),d(this,Ga,r(this,Ga)+t);const n=e+t,s=r(this,ja)+r(this,Ga);if(n===1&&s===1||s===0){const i=s>0;Promise.resolve().then(()=>{var o;return(o=this.onSync)==null?void 0:o.call(this,i)})}},Xa=new WeakMap,cg=function(e,t){return r(this,hn)[e]=t,n=>{var o;const s=e==="_zero_crud"||(o=r(this,fe))==null?void 0:o.trackMutation(),i=p(this,E,hg).call(this,s,e,t,n,performance.now());return s?{client:i,server:s.serverPromise,then:(a,u)=>{var c,h;return(h=(c=r(this,z)).warn)==null||h.call(c,"Awaiting the mutator result directly is being deprecated. Please use `await z.mutate[mutatorName].client` or `await result.mutate[mutatorName].server`"),i.then(a,u)}}:i}},lg=function(e){const t=Object.create(null);for(const n in e)t[n]=p(this,E,cg).call(this,n,e[n]);return t},hg=async function(e,t,n,s,i){const o=s??null;r(this,Se).hasPendingSubscriptionRuns&&await Promise.resolve(),await r(this,xe);const{clientID:a}=this;return qc(this.memdag,async u=>{var c,h,m,y;try{let w,g,S,I;try{I=await Vd(Ce,u);const k=await vw(I,t,o,null,u,i,a,Ie),C=await k.getMutationID(),M=new Lv(a,C,"initial",await((c=r(this,fe))==null?void 0:c.getTxData(I,{openLazyRead:u})),k,r(this,z));e&&((h=r(this,fe))==null||h.mutationIDAssigned(e.ephemeralID,C)),w=await n(M,s),xo(k);const _=await k.getMutationID();[g,S]=await k.commitWithDiffs(Ce,r(this,Se)),this.lastMutationID=_}catch(D){throw e&&((m=r(this,fe))==null||m.rejectMutation(e.ephemeralID,D)),D}return(y=r(this,fe))==null||y.advance(I,g,S.get("")??[]),r(this,hs).send(!1).catch(()=>{}),await r(this,Se).fire(S),p(this,E,ad).call(this),w}catch(w){throw await p(this,E,Nc).call(this,w)}})},Nc=async function(e){return e instanceof _y&&await p(this,E,nd).call(this)?new En(this.clientID):e},Gm),ql=new Map;async function Sp(e){const t=await e;if(t)throw t.error}function kp(){typeof location<"u"&&location.reload()}function t_(e){const{name:t,clientMaxAgeMs:n}=e;if(typeof t!="string"||!t)throw new TypeError("name is required and must be non-empty");if(n!==void 0){const s=Math.max(Qv,Yv);if(typeof n!="number"||n<=s)throw new TypeError(`clientAgeMaxMs must be a number larger than ${s}ms`)}}var n_=401;function s_(e,t){return i_(e,t,Ie)}function i_(e,t,n){const s=`rep:${e}:${n}`;return t?`${s}:${t}`:s}var yf=class extends Error{};function r_(e){return new vv(e)}function dg(e,t){switch(t){case"idb":case void 0:return{create:n=>QI(e,n),drop:JI};case"mem":return{create:r_,drop:n=>wv(n)};default:return t}}var V={};Pd(V,{AuthInvalidated:()=>o_,ClientNotFound:()=>a_,Internal:()=>k_,InvalidConnectionRequest:()=>u_,InvalidConnectionRequestBaseCookie:()=>c_,InvalidConnectionRequestClientDeleted:()=>h_,InvalidConnectionRequestLastMutationID:()=>l_,InvalidMessage:()=>d_,InvalidPush:()=>f_,MutationFailed:()=>p_,MutationRateLimited:()=>m_,Rebalance:()=>y_,Rehome:()=>w_,SchemaVersionNotSupported:()=>b_,ServerOverloaded:()=>S_,Unauthorized:()=>v_,VersionNotSupported:()=>g_});var o_="AuthInvalidated",a_="ClientNotFound",u_="InvalidConnectionRequest",c_="InvalidConnectionRequestBaseCookie",l_="InvalidConnectionRequestLastMutationID",h_="InvalidConnectionRequestClientDeleted",d_="InvalidMessage",f_="InvalidPush",p_="MutationFailed",m_="MutationRateLimited",y_="Rebalance",w_="Rehome",v_="Unauthorized",g_="VersionNotSupported",b_="SchemaVersionNotSupported",S_="ServerOverloaded",k_="Internal";function Ip(e,t){const n={};for(const s of Object.entries(e)){const i=t(s[0],s[1]);n[i[0]]=i[1]}return n}function Cp(e,t){const n={};for(const s of t(Object.entries(e)))n[s[0]]=s[1];return n}var I_=Ae("string","number","boolean","null","json"),C_=f.object({type:I_}),D_=f.object({columns:f.record(C_)}),__=f.object({tables:f.record(D_)}),Dp=([e],[t])=>e<t?-1:e>t?1:0;function E_(e){return{tables:Cp(e.tables,t=>t.sort(Dp).map(([n,s])=>[n,{columns:Cp(s.columns,i=>i.sort(Dp))}]))}}function x_(e){const t={tables:Ip(e.tables,(i,{serverName:o,columns:a})=>[o??i,{columns:Ip(a,(u,{serverName:c,type:h})=>[c??u,{type:h}])}])},n=E_(t),s=rf(JSON.stringify(n)).toString(36);return{clientSchema:n,hash:s}}var Mc={};Pd(Mc,{NewClientGroup:()=>N_,SchemaVersionNotSupported:()=>R_,VersionNotSupported:()=>M_});var N_="NewClientGroup",M_="VersionNotSupported",R_="SchemaVersionNotSupported",fg=f.union(re({clientIDs:je(f.string()).optional(),clientGroupIDs:je(f.string()).optional()})),T_=f.tuple([f.literal("deleteClients"),fg]),pg=f.object({op:f.literal("put"),hash:f.string(),ast:Yu.optional(),ttl:f.number().optional()}),O_=pg.extend({ast:Yu.optional(),name:f.string().optional(),args:f.array(Kt).optional()}),mg=f.object({op:f.literal("del"),hash:f.string()}),yg=f.object({op:f.literal("clear")}),P_=f.union(pg,mg,yg),A_=f.union(O_,mg,yg),_p=f.array(P_),L_=f.array(A_),H_=f.object({wsid:f.string(),timestamp:f.number().optional()}),F_=f.tuple([f.literal("connected"),H_]),z_=f.object({queryParams:f.record(f.string()).optional()}),$_=f.object({desiredQueriesPatch:L_,clientSchema:__.optional(),deleted:fg.optional(),userPushParams:z_.optional()});f.tuple([f.literal("initConnection"),$_]);function Ep(e,t){return encodeURIComponent(btoa(JSON.stringify({initConnectionMessage:e,authToken:t})))}var wg=Ae(V.AuthInvalidated,V.ClientNotFound,V.InvalidConnectionRequest,V.InvalidConnectionRequestBaseCookie,V.InvalidConnectionRequestLastMutationID,V.InvalidConnectionRequestClientDeleted,V.InvalidMessage,V.InvalidPush,V.MutationRateLimited,V.MutationFailed,V.Unauthorized,V.VersionNotSupported,V.SchemaVersionNotSupported,V.Internal),V_=f.object({kind:wg,message:f.string()}),vg=Ae(V.Rebalance,V.Rehome,V.ServerOverloaded),j_=f.object({kind:vg,message:f.string(),minBackoffMs:f.number().optional(),maxBackoffMs:f.number().optional(),reconnectParams:f.record(f.string()).optional()}),G_=f.union(wg,vg),B_=f.union(V_,j_),U_=f.tuple([f.literal("error"),B_]),K_=f.object({op:f.literal("put"),tableName:f.string(),value:Xu}),q_=f.object({op:f.literal("update"),tableName:f.string(),id:of,merge:uk.optional(),constrain:f.array(f.string()).optional()}),Q_=f.object({op:f.literal("del"),tableName:f.string(),id:of}),J_=f.object({op:f.literal("clear")}),X_=f.union(K_,q_,Q_,J_),Y_=f.array(X_),wf=f.string(),tl=f.union(wf,f.null()),Z_=f.object({pokeID:f.string(),baseCookie:tl,schemaVersions:f.object({minSupportedVersion:f.number(),maxSupportedVersion:f.number()}).optional(),timestamp:f.number().optional()}),W_=f.object({pokeID:f.string(),lastMutationIDChanges:f.record(f.number()).optional(),desiredQueriesPatches:f.record(_p).optional(),gotQueriesPatch:_p.optional(),rowsPatch:Y_.optional()}),eE=f.object({pokeID:f.string(),cookie:wf,cancel:f.boolean().optional()}),tE=f.tuple([f.literal("pokeStart"),Z_]),nE=f.tuple([f.literal("pokePart"),W_]),sE=f.tuple([f.literal("pokeEnd"),eE]),iE=f.object({}),rE=f.tuple([f.literal("pong"),iE]),oE=f.object({clientGroupID:f.string(),cookie:tl,requestID:f.string()}),aE=f.object({cookie:wf,requestID:f.string(),lastMutationIDChanges:f.record(f.number())});f.tuple([f.literal("pull"),oE]);var uE=f.tuple([f.literal("pull"),aE]),gg="crud",bg="custom",nl="_zero_crud",cE=f.object({op:f.literal("insert"),tableName:f.string(),primaryKey:Rl,value:Xu}),lE=f.object({op:f.literal("upsert"),tableName:f.string(),primaryKey:Rl,value:Xu}),hE=f.object({op:f.literal("update"),tableName:f.string(),primaryKey:Rl,value:Xu}),dE=f.object({op:f.literal("delete"),tableName:f.string(),primaryKey:Rl,value:of}),fE=f.union(cE,lE,hE,dE),pE=f.object({ops:f.array(fE)}),mE=f.tuple([pE]),yE=f.object({type:f.literal(gg),id:f.number(),clientID:f.string(),name:f.literal(nl),args:mE,timestamp:f.number()}),wE=f.object({type:f.literal(bg),id:f.number(),clientID:f.string(),name:f.string(),args:f.array(Kt),timestamp:f.number()}),vE=f.union(yE,wE),gE=f.object({clientGroupID:f.string(),mutations:f.array(vE),pushVersion:f.number(),schemaVersion:f.number().optional(),timestamp:f.number(),requestID:f.string()});f.tuple([f.literal("push"),gE]);var Wu=f.object({id:f.number(),clientID:f.string()}),bE=f.object({error:f.literal("app"),details:Kt.optional()}),SE=f.object({error:Ae("oooMutation","alreadyProcessed"),details:Kt.optional()}),kE=f.object({data:Kt.optional()}),IE=f.union(bE,SE),CE=f.union(kE,IE),DE=f.object({id:Wu,result:CE}),_E=f.object({mutations:f.array(DE)}),EE=f.object({error:f.literal("unsupportedPushVersion"),mutationIDs:f.array(Wu).optional()}),xE=f.object({error:f.literal("unsupportedSchemaVersion"),mutationIDs:f.array(Wu).optional()}),NE=f.object({error:f.literal("http"),status:f.number(),details:f.string(),mutationIDs:f.array(Wu).optional()}),ME=f.object({error:f.literal("zeroPusher"),details:f.string(),mutationIDs:f.array(Wu).optional()}),RE=f.union(EE,xE,NE,ME),TE=f.union(_E,RE),OE=f.tuple([f.literal("pushResponse"),TE]);f.object({schema:f.string(),appID:f.string()});function PE(e,t){return{ops:e.ops.map(({op:n,tableName:s,primaryKey:i,value:o})=>({op:n,tableName:t.tableName(s),primaryKey:t.columns(s,i),value:t.row(s,o)}))}}var AE=f.union(F_,U_,rE,tE,nE,sE,uE,T_,OE,Pk),vf=18,LE=6;b(LE<vf);function gf(e){return Sg("client",e)}function HE(e){return Sg("server",e)}function Sg(e,t){const n=new Map(Object.entries(t).map(([s,{serverName:i,columns:o}])=>{let a=!0;const u={};for(const[c,{serverName:h}]of Object.entries(o))h&&h!==c&&(a=!1),e==="client"?u[c]=h??c:u[h??c]=c;return[e==="client"?s:i??s,{tableName:e==="client"?i??s:s,columns:u,allColumnsSame:a}]}));return new FE(n)}var Ya,ds,lo,Bm,FE=(Bm=class{constructor(e){l(this,ds);l(this,Ya,new Map);d(this,Ya,e)}tableName(e,t){return p(this,ds,lo).call(this,e,t).tableName}columnName(e,t,n){const s=p(this,ds,lo).call(this,e,n).columns[t];if(!s)throw new Error(`unknown column "${t}" of "${e}" table ${n?`in ${JSON.stringify(n)}`:""}`);return s}row(e,t){const n=p(this,ds,lo).call(this,e),{allColumnsSame:s,columns:i}=n;if(s)return t;const o={};for(const a in t)o[i[a]??a]=t[a];return o}columns(e,t){const n=p(this,ds,lo).call(this,e),{allColumnsSame:s,columns:i}=n;return t===void 0||s?t:t.map(o=>i[o]??o)}},Ya=new WeakMap,ds=new WeakSet,lo=function(e,t){const n=r(this,Ya).get(e);if(!n)throw new Error(`unknown table "${e}" ${t?`in ${JSON.stringify(t)}`:""}`);return n},Bm);function xp(e,t){return b(!e.includes("|"),"mutator namespaces must not include a |"),b(!t.includes("|"),"mutator names must not include a |"),`${e}|${t}`}function An(e,t){e.send(JSON.stringify(t))}var qt=0,uc=1,to=2,Hn=32,B,Hs,kg,ld,tr,cd=(tr=class{constructor(t,n){l(this,Hs);l(this,B,Rc);v(this,"size",0);v(this,"comparator");if(this.comparator=t,n)for(const s of n)this.add(s)}clear(){d(this,B,Rc),this.size=0}clone(){r(this,B).isShared=!0;const t=new tr(this.comparator);return d(t,B,r(this,B)),t.size=this.size,t}get(t){return r(this,B).get(t,this)}add(t){r(this,B).isShared&&d(this,B,r(this,B).clone());const n=r(this,B).set(t,this);return n===null?this:(d(this,B,new zE([r(this,B),n])),this)}has(t){return r(this,B).has(t,this)}delete(t){return p(this,Hs,kg).call(this,t)}keys(){return Ql(r(this,B),this.comparator,void 0,!0)}values(){return Ql(r(this,B),this.comparator,void 0,!0)}valuesFrom(t,n=!0){return Ql(r(this,B),this.comparator,t,n)}valuesReversed(){return Np(p(this,Hs,ld).call(this),r(this,B),this.comparator,void 0,!0)}valuesFromReversed(t,n=!0){return Np(p(this,Hs,ld).call(this),r(this,B),this.comparator,t,n)}[Symbol.iterator](){return this.keys()}},B=new WeakMap,Hs=new WeakSet,kg=function(t){let n=r(this,B);n.isShared&&d(this,B,n=n.clone());try{return n.delete(t,this)}finally{let s;for(;n.keys.length<=1&&n.isInternal();)s||(s=n.isShared),d(this,B,n=n.keys.length===0?Rc:n.children[0]);s&&(n.isShared=!0)}},ld=function(){return r(this,B).maxKey()},tr);function Ql(e,t,n,s){const i=hd(n,e,t);if(i===void 0)return sl(()=>({done:!0,value:void 0}));let[o,a,u]=i,c=n===void 0?-1:at(n,u.keys,0,t)-1;return!s&&c<u.keys.length&&t(u.keys[c+1],n)===0&&c++,sl(()=>{for(;;){if(++c<u.keys.length)return{done:!1,value:u.keys[c]};let h=-1;for(;;){if(++h>=o.length)return{done:!0,value:void 0};if(++a[h]<o[h].length)break}for(;h>0;h--)o[h-1]=o[h][a[h]].children,a[h-1]=0;u=o[0][a[0]],c=-1}})}function Np(e,t,n,s,i){if(s===void 0&&(s=e,s===void 0))return sl(()=>({done:!0,value:void 0}));let[o,a,u]=hd(s,t,n)||hd(e,t,n);b(!o[0]||u===o[0][a[0]]);let c=at(s,u.keys,0,n);return i&&c<u.keys.length&&n(u.keys[c],s)<=0&&c++,sl(()=>{for(;;){if(--c>=0)return{done:!1,value:u.keys[c]};let h;for(h=-1;;){if(++h>=o.length)return{done:!0,value:void 0};if(--a[h]>=0)break}for(;h>0;h--)o[h-1]=o[h][a[h]].children,a[h-1]=o[h-1].length-1;u=o[0][a[0]],c=u.keys.length}})}function hd(e,t,n){let s=t;const i=[],o=[];if(s.isInternal()){for(let a=0;s.isInternal();a++){if(i[a]=s.children,o[a]=e===void 0?0:at(e,s.keys,0,n),o[a]>=i[a].length)return;s=i[a][o[a]]}i.reverse(),o.reverse()}return[i,o,s]}function sl(e){return{next:e,[Symbol.iterator](){return this}}}var Ig=class dd{constructor(t){v(this,"keys");v(this,"isShared");this.keys=t,this.isShared=void 0}isInternal(){return!1}maxKey(){return this.keys[this.keys.length-1]}minKey(){return this.keys[0]}clone(){return new dd(this.keys.slice(0))}get(t,n){const s=at(t,this.keys,-1,n.comparator);return s<0?void 0:this.keys[s]}has(t,n){const s=at(t,this.keys,-1,n.comparator);return s>=0&&s<this.keys.length}set(t,n){let s=at(t,this.keys,-1,n.comparator);if(s<0){if(s=~s,n.size++,this.keys.length<Hn)return this.keys.splice(s,0,t),null;const i=this.splitOffRightSide();let o=this;return s>this.keys.length&&(s-=this.keys.length,o=i),o.keys.splice(s,0,t),i}return this.keys[s]=t,null}takeFromRight(t){this.keys.push(t.keys.shift())}takeFromLeft(t){this.keys.unshift(t.keys.pop())}splitOffRightSide(){const t=this.keys.length>>1,n=this.keys.splice(t);return new dd(n)}delete(t,n){const s=n.comparator,i=at(t,this.keys,-1,s),o=i+1;if(i<0)return!1;const{keys:a}=this;for(let u=i;u<o;u++){if(a[u]!==a[u]||this.isShared===!0)throw new Error("BTree illegally changed or cloned in delete");return this.keys.splice(u,1),n.size--,!0}return!1}mergeSibling(t,n){this.keys.push(...t.keys)}},zE=class fd extends Ig{constructor(n,s){if(!s){s=[];for(let i=0;i<n.length;i++)s[i]=n[i].maxKey()}super(s);v(this,"children");this.children=n}isInternal(){return!0}clone(){const n=this.children.slice(0);for(let s=0;s<n.length;s++)n[s].isShared=!0;return new fd(n,this.keys.slice(0))}minKey(){return this.children[0].minKey()}get(n,s){const i=at(n,this.keys,0,s.comparator),{children:o}=this;return i<o.length?o[i].get(n,s):void 0}has(n,s){const i=at(n,this.keys,0,s.comparator),{children:o}=this;return i<o.length?o[i].has(n,s):!1}set(n,s){const i=this.children,o=s.comparator;let a=Math.min(at(n,this.keys,0,o),i.length-1),u=i[a];if(u.isShared&&(i[a]=u=u.clone()),u.keys.length>=Hn){let y;a>0&&(y=i[a-1]).keys.length<Hn&&o(u.keys[0],n)<0?(y.isShared&&(i[a-1]=y=y.clone()),y.takeFromRight(u),this.keys[a-1]=y.maxKey()):(y=i[a+1])!==void 0&&y.keys.length<Hn&&o(u.maxKey(),n)<0&&(y.isShared&&(i[a+1]=y=y.clone()),y.takeFromLeft(u),this.keys[a]=i[a].maxKey())}const c=u.set(n,s);if(this.keys[a]=u.maxKey(),c===null)return null;if(this.keys.length<Hn)return this.insert(a+1,c),null;const h=this.splitOffRightSide();let m=this;return o(c.maxKey(),this.maxKey())>0&&(m=h,a-=this.keys.length),m.insert(a+1,c),h}insert(n,s){this.children.splice(n,0,s),this.keys.splice(n,0,s.maxKey())}splitOffRightSide(){const n=this.children.length>>1;return new fd(this.children.splice(n),this.keys.splice(n))}takeFromRight(n){this.keys.push(n.keys.shift()),this.children.push(n.children.shift())}takeFromLeft(n){this.keys.unshift(n.keys.pop()),this.children.unshift(n.children.pop())}delete(n,s){const i=s.comparator,{keys:o}=this,{children:a}=this;let u=at(n,this.keys,0,i),c=u;const h=Math.min(u,o.length-1);if(c<=h)try{a[c].isShared&&(a[c]=a[c].clone());const m=a[c].delete(n,s);return o[c]=a[c].maxKey(),m}finally{const m=Hn>>1;for(u>0&&u--,c=h;c>=u;c--)a[c].keys.length<=m&&(a[c].keys.length!==0?this.tryMerge(c,Hn):(o.splice(c,1),a.splice(c,1)))}return!1}tryMerge(n,s){const{children:i}=this;return n>=0&&n+1<i.length&&i[n].keys.length+i[n+1].keys.length<=s?(i[n].isShared&&(i[n]=i[n].clone()),i[n].mergeSibling(i[n+1],s),i.splice(n+1,1),this.keys.splice(n+1,1),this.keys[n]=i[n].maxKey(),!0):!1}mergeSibling(n,s){const i=this.keys.length;this.keys.push(...n.keys);const o=n.children;if(this.children.push(...o),n.isShared&&!this.isShared)for(let a=0;a<o.length;a++)o[a].isShared=!0;this.tryMerge(i-1,s)}};function at(e,t,n,s){let i=0,o=t.length,a=o>>1;for(;i<o;){const u=s(t[a],e);if(u<0)i=a+1;else if(u>0)o=a;else{if(u===0)return a;if(e===e)return t.length;throw new Error("NaN was used as a key")}a=i+o>>1}return a^n}var Rc=new Ig([]);Rc.isShared=!0;function $E(e,t){return Ye(e[0],t[0])}var fn,Um,VE=(Um=class{constructor(){l(this,fn,new cd($E))}set(e,t){r(this,fn).add([e,t])}get(e,t){const n=r(this,fn).get([e,null]);return n!==void 0?n[1]:t}del(e){r(this,fn).delete([e,null])}*scan(e){for(const t of r(this,fn).valuesFrom(e&&[e.prefix,null])){if(e&&!t[0].startsWith(e.prefix))return;yield t}}cloneData(){return structuredClone(Object.fromEntries(r(this,fn).values()))}},fn=new WeakMap,Um);function Cg(e,t){for(const n in e)if(!Wd(t[n],e[n]))return!1;return!0}function jE(e,t){const n=Object.keys(e);if(n.length!==t.length)return!1;n.sort($y);for(let s=0;s<n.length;s++)if(n[s][0]!==t[s])return!1;return!0}function pd(e){return e.type==="and"?e.conditions.flatMap(pd):e.type==="simple"?[e]:e.type==="or"&&e.conditions.length===1?pd(e.conditions[0]):[]}function GE(e,t){if(e===void 0)return;const n=pd(e);if(n.length===0)return;const s={};for(const i of n)if(i.op==="="){const o=BE(i);if(o!==void 0){if(!t.includes(o.name))continue;s[o.name]=o.value}}if(Object.keys(s).length===t.length)return s}function BE(e){if(e.left.type==="column")return b(e.right.type==="literal"),{name:e.left.name,value:e.right.value}}var fs,ps,Qe,pn,Pt,At,Za,Wa,se,Dg,_g,ho,Eg,md,xg,nr,UE=(nr=class{constructor(t,n,s,i){l(this,se);l(this,fs);l(this,ps);l(this,Qe);l(this,pn);l(this,Pt,new Map);l(this,At,[]);l(this,Za);l(this,Wa);d(this,fs,t),d(this,ps,n),d(this,Qe,s),d(this,pn,s.map(a=>[a,"asc"]));const o=Mp(r(this,pn));r(this,Pt).set(JSON.stringify(r(this,pn)),{comparator:o,data:i??new cd(o),usedBy:new Set}),Ph(r(this,pn),r(this,Qe))}getSchemaInfo(){return{tableName:r(this,fs),columns:r(this,ps),primaryKey:r(this,Qe)}}fork(){const t=p(this,se,ho).call(this);return new nr(r(this,fs),r(this,ps),r(this,Qe),t.data.clone())}get data(){return p(this,se,ho).call(this).data}connect(t,n,s){const i=nv(n),o={getSchema:()=>u,fetch:c=>p(this,se,md).call(this,c,a),cleanup:c=>p(this,se,xg).call(this,c,a),setOutput:c=>{a.output=c},destroy:()=>{p(this,se,_g).call(this,o)},fullyAppliedFilters:!i.conditionsRemoved},a={input:o,output:void 0,sort:t,splitEditKeys:s,compareRows:ek(t),filters:i.filters?{condition:i.filters,predicate:_o(i.filters)}:void 0},u=p(this,se,Dg).call(this,a);return Ph(t,r(this,Qe)),r(this,At).push(a),o}getIndexKeys(){return[...r(this,Pt).keys()]}push(t){for(const n of this.genPush(t));}*genPush(t){const n=p(this,se,ho).call(this),{data:s}=n,i=u=>s.has(u),o=u=>d(this,Za,u),a=u=>d(this,Wa,u);if(t.type==="set"){const u=s.get(t.row);u!==void 0?t={type:"edit",row:t.row,oldRow:u}:t={type:"add",row:t.row}}for(const u of QE(t,i,r(this,At).entries(),o,a))yield u;for(const{data:u}of r(this,Pt).values())switch(t.type){case"add":{const c=u.add(t.row);b(c);break}case"remove":{const c=u.delete(t.row);b(c);break}case"edit":{const c=u.delete(t.oldRow);b(c),u.add(t.row);break}default:we()}}},fs=new WeakMap,ps=new WeakMap,Qe=new WeakMap,pn=new WeakMap,Pt=new WeakMap,At=new WeakMap,Za=new WeakMap,Wa=new WeakMap,se=new WeakSet,Dg=function(t){return{tableName:r(this,fs),columns:r(this,ps),primaryKey:r(this,Qe),sort:t.sort,system:"client",relationships:{},isHidden:!1,compareRows:t.compareRows}},_g=function(t){const n=r(this,At).findIndex(s=>s.input===t);b(n!==-1,"Connection not found"),r(this,At).splice(n,1)},ho=function(){const t=r(this,Pt).get(JSON.stringify(r(this,pn)));return b(t,"Primary index not found"),t},Eg=function(t,n){const s=JSON.stringify(t),i=r(this,Pt).get(s);if(i)return i.usedBy.add(n),i;const o=Mp(t),a=new cd(o);for(const c of p(this,se,ho).call(this).data)a.add(c);const u={comparator:o,data:a,usedBy:new Set([n])};return r(this,Pt).set(s,u),u},md=function*(t,n){var C,M,_;const s=r(this,At).indexOf(n);b(s!==-1,"Output not found");const i=r(this,At)[s],{sort:o}=i,a=GE((C=i.filters)==null?void 0:C.condition,r(this,Qe)),u=a??t.constraint,c=[];if(u)for(const x of Object.keys(u))c.push([x,"asc"]);(r(this,Qe).length>1||!u||!jE(u,r(this,Qe)))&&c.push(...o);const h=p(this,se,Eg).call(this,c,n),{data:m,comparator:y}=h,w=(x,O)=>y(x,O)*(t.reverse?-1:1),g=(M=t.start)==null?void 0:M.row;let S;if(u){S={};for(const[x,O]of c)Ps(u,x)?S[x]=u[x]:t.reverse?S[x]=O==="asc"?rl:il:S[x]=O==="asc"?il:rl}else S=g;const I=sx(m,S,t.reverse),D=XE(g,a?t0(I):I,t.constraint,r(this,Za),r(this,Wa),s,w,(_=i.filters)==null?void 0:_.predicate),k=KE(JE(D,t.start,w),t.constraint);yield*i.filters?qE(k,i.filters.predicate):k},xg=function(t,n){return p(this,se,md).call(this,t,n)},nr);function*KE(e,t){for(const n of e){if(t&&!Cg(t,n.row))break;yield n}}function*qE(e,t){for(const n of e)t(n.row)&&(yield n)}function*QE(e,t,n,s,i){switch(e.type){case"add":b(!t(e.row),()=>`Row already exists ${Jl(e)}`);break;case"remove":b(t(e.row),()=>`Row not found ${Jl(e)}`);break;case"edit":b(t(e.oldRow),()=>`Row not found ${Jl(e)}`);break;default:we()}for(const[o,{output:a,splitEditKeys:u,filters:c}]of n)if(a){let h=!1;if(e.type==="edit"&&u){for(const m of u)if(!Wd(e.row[m],e.oldRow[m])){h=!0;break}}if(h){b(e.type==="edit"),i({outputIndex:o,change:{type:"remove",row:e.oldRow}});const m={type:"remove",node:{row:e.oldRow,relationships:{}}};Sc(m,a,c==null?void 0:c.predicate),yield,i(void 0),s({outputIndex:o,change:e});const y={type:"add",node:{row:e.row,relationships:{}}};Sc(y,a,c==null?void 0:c.predicate),yield}else{s({outputIndex:o,change:e});const m=e.type==="edit"?{type:e.type,oldNode:{row:e.oldRow,relationships:{}},node:{row:e.row,relationships:{}}}:{type:e.type,node:{row:e.row,relationships:{}}};Sc(m,a,c==null?void 0:c.predicate),yield}}s(void 0)}function*JE(e,t,n){if(!t){yield*e;return}let s=!1;for(const i of e)s||(t.basis==="at"?n(i.row,t.row)>=0&&(s=!0):t.basis==="after"&&n(i.row,t.row)>0&&(s=!0)),s&&(yield i)}function*XE(e,t,n,s,i,o,a,u){let c;i&&i.outputIndex===o?c=i:s&&o<=s.outputIndex&&(c=s);const h=YE(e,n,c,a,u);yield*tx(t,h,a)}function YE(e,t,n,s,i){let o={add:void 0,remove:void 0};switch(n==null?void 0:n.change.type){case"add":o={add:n.change.row,remove:void 0};break;case"remove":o={add:void 0,remove:n.change.row};break;case"edit":o={add:n.change.row,remove:n.change.oldRow};break}return e&&(o=ZE(o,e,s)),t&&(o=WE(o,t)),i&&(o=ex(o,i)),o}function ZE({add:e,remove:t},n,s){const i=o=>o===void 0||s(o,n)<0?void 0:o;return{add:i(e),remove:i(t)}}function WE({add:e,remove:t},n){const s=i=>i===void 0||!Cg(n,i)?void 0:i;return{add:s(e),remove:s(t)}}function ex({add:e,remove:t},n){const s=i=>i===void 0||!n(i)?void 0:i;return{add:s(e),remove:s(t)}}function*tx(e,t,n){let s=!1,i=!1;for(const o of e){if(!s&&t.add&&n(t.add,o)<0&&(s=!0,yield{row:t.add,relationships:{}}),!i&&t.remove&&n(t.remove,o)===0){i=!0;continue}yield{row:o,relationships:{}}}!s&&t.add&&(yield{row:t.add,relationships:{}})}var il=Symbol("min-value"),rl=Symbol("max-value");function Mp(e){return(t,n)=>{for(const s of e){const i=s[0],o=nx(t[i],n[i]);if(o!==0)return s[1]==="asc"?o:-o}return 0}}function nx(e,t){return e===t?0:e===il?-1:t===il||e===rl?1:t===rl?-1:Nl(e,t)}function*sx(e,t,n){yield*e[n?"valuesFromReversed":"valuesFrom"](t)}function Jl(e){return JSON.stringify(e,(t,n)=>typeof n=="bigint"?n.toString():n)}var Lt,sr,ir,ix=(ir=class{constructor(t,n,s=new Map){l(this,Lt);l(this,sr);v(this,"hash");d(this,sr,t),d(this,Lt,s),this.hash=n}getSource(t){if(r(this,Lt).has(t))return r(this,Lt).get(t);const n=r(this,sr)[t],s=n?new UE(t,n.columns,n.primaryKey):void 0;return r(this,Lt).set(t,s),s}clear(){r(this,Lt).clear()}advance(t,n,s){b(this.hash===t,()=>`Expected head must match the main head. Got: ${this.hash}, expected: ${t}`),Ng(s,this),this.hash=n}async forkToHead(t,n,s){const i=this.fork();return i.hash===n||(await rx(n,t,i,s),i.hash=n),i}fork(){return new ir(r(this,sr),this.hash,new Map(s0(r(this,Lt).entries()).map(([t,n])=>[t,n==null?void 0:n.fork()])))}},Lt=new WeakMap,sr=new WeakMap,ir);async function rx(e,t,n,s){const i=await ox(H(n.hash),e,t,s);i&&Ng(i,n)}async function ox(e,t,n,s){const i=a=>F0(e,t,a,{shouldComputeDiffs:()=>!0,shouldComputeDiffsForIndex(u){return!1}},Ie);let o;return s!=null&&s.openLazySourceRead?o=await El(n.read(s.openLazySourceRead),i):s!=null&&s.openLazyRead?o=await i(s.openLazyRead):o=await pe(n,i),o.get("")}function Ng(e,t){for(let n=mf(e,Tn,s=>s.key);n<e.length;n++){const s=e[n],{key:i}=s;if(!i.startsWith(Tn))break;const o=zk(i),a=H(t.getSource(o));switch(s.op){case"del":a.push({type:"remove",row:s.oldValue});break;case"add":a.push({type:"add",row:s.newValue});break;case"change":a.push({type:"edit",row:s.newValue,oldRow:s.oldValue});break}}}var rr,eu,tu,nu,su,iu,or,ar,ms,ml,Rg,Km,Mg=(Km=class{constructor(t,n,s,i,o,a,u,c,h){l(this,ml);l(this,rr);l(this,eu);l(this,tu);l(this,nu);l(this,su);l(this,iu);l(this,or,new Set);l(this,ar);l(this,ms);v(this,"assertValidRunOptions");v(this,"defaultQueryComplete",!1);d(this,rr,n),d(this,eu,s),d(this,nu,o),d(this,su,a),d(this,iu,u),d(this,ms,t),d(this,ar,c),this.assertValidRunOptions=h,d(this,tu,i)}getSource(t){return r(this,rr).getSource(t)}addCustomQuery(t,n,s){return r(this,tu).call(this,t.name,t.args,n,s)}addServerQuery(t,n,s){return r(this,eu).call(this,t,n,s)}updateServerQuery(t,n){r(this,nu).call(this,t,n)}updateCustomQuery(t,n){r(this,su).call(this,t.name,t.args,n)}onQueryMaterialized(t,n,s){var i,o,a,u;r(this,ar)!==void 0&&s>r(this,ar)?(o=(i=r(this,ms)).warn)==null||o.call(i,"Slow query materialization (including server/network)",t,n,s):(u=(a=r(this,ms)).debug)==null||u.call(a,"Materialized query (including server/network)",t,n,s)}mapAst(t){return t}createStorage(){return new VE}decorateInput(t){return t}decorateFilterInput(t){return t}onTransactionCommit(t){return r(this,or).add(t),()=>{r(this,or).delete(t)}}batchViewUpdates(t){let n,s=!1;return r(this,iu).call(this,()=>{n=t(),s=!0}),b(s,"batchViewUpdates must call applyViewUpdates synchronously."),n}processChanges(t,n,s){this.batchViewUpdates(()=>{try{r(this,rr).advance(t,n,s)}finally{p(this,ml,Rg).call(this)}})}},rr=new WeakMap,eu=new WeakMap,tu=new WeakMap,nu=new WeakMap,su=new WeakMap,iu=new WeakMap,or=new WeakMap,ar=new WeakMap,ms=new WeakMap,ml=new WeakSet,Rg=function(){var t,n;for(const s of r(this,or))try{s()}catch(i){(n=(t=r(this,ms)).error)==null||n.call(t,V.Internal,"Failed notifying a commit listener of IVM updates",i)}},Km);function ax(e,t){const{[nl]:n}=t,s=async o=>{const a=[],u={};for(const h of Object.keys(e.tables))u[h]=cx(h,e,a);const c=await o(u);return await n({ops:a}),c},i={};for(const[o,a]of Object.entries(e.tables))i[o]=ux(o,a.primaryKey,n);return{mutate:i,mutateBatch:s}}function ux(e,t,n){return{insert:s=>n({ops:[{op:"insert",tableName:e,primaryKey:t,value:s}]}),upsert:s=>n({ops:[{op:"upsert",tableName:e,primaryKey:t,value:s}]}),update:s=>n({ops:[{op:"update",tableName:e,primaryKey:t,value:s}]}),delete:s=>n({ops:[{op:"delete",tableName:e,primaryKey:t,value:s}]})}}function cx(e,t,n){const{primaryKey:s}=t.tables[e];return{insert:i=>{const o={op:"insert",tableName:e,primaryKey:s,value:i};return n.push(o),me},upsert:i=>{const o={op:"upsert",tableName:e,primaryKey:s,value:i};return n.push(o),me},update:i=>{const o={op:"update",tableName:e,primaryKey:s,value:i};return n.push(o),me},delete:i=>{const o={op:"delete",tableName:e,primaryKey:s,value:i};return n.push(o),me}}}function lx(e){return async function(n,s){for(const i of s.ops)switch(i.op){case"insert":await Og(n,i,e,void 0);break;case"upsert":await Pg(n,i,e,void 0);break;case"update":await Ag(n,i,e,void 0);break;case"delete":await Lg(n,i,e,void 0);break}}}function Tg(e,t){let n=t;for(const s in e.columns)n[s]===void 0&&(n={...n,[s]:null});return n}async function Og(e,t,n,s){const i=Ms(t.tableName,n.tables[t.tableName].primaryKey,t.value);if(!await e.has(i)){const o=Tg(n.tables[t.tableName],t.value);await e.set(i,o),s&&H(s.getSource(t.tableName)).push({type:"add",row:t.value})}}async function Pg(e,t,n,s){const i=Ms(t.tableName,n.tables[t.tableName].primaryKey,t.value),o=Tg(n.tables[t.tableName],t.value);await e.set(i,o),s&&H(s.getSource(t.tableName)).push({type:"set",row:t.value})}async function Ag(e,t,n,s){const i=Ms(t.tableName,n.tables[t.tableName].primaryKey,t.value),o=await e.get(i);if(o===void 0)return;const a=t.value,u={...o};for(const c in a)a[c]!==void 0&&(u[c]=a[c]);await e.set(i,u),s&&H(s.getSource(t.tableName)).push({type:"edit",oldRow:o,row:u})}async function Lg(e,t,n,s){const i=Ms(t.tableName,n.tables[t.tableName].primaryKey,t.value),o=await e.get(i);o!==void 0&&(await e.del(i),s&&H(s.getSource(t.tableName)).push({type:"remove",row:o}))}function cc(){}var hx=Object.freeze({}),dx=class{constructor(e,t,n,s){v(this,"clientID");v(this,"mutationID");v(this,"reason");v(this,"location","client");v(this,"mutate");v(this,"query");v(this,"token");const i=t;H(t.reason==="initial"||t.reason==="rebase"),this.clientID=t.clientID,this.mutationID=t.mutationID,this.reason=t.reason==="initial"?"optimistic":"rebase";const o=H(i[Xh],"zero was not set on replicache internal options!");this.mutate=fx(n,t,o.ivmSources),this.query=mx(e,n,o.ivmSources,s),this.token=o.token}};function Rp(e,t,n,s){return async(i,o)=>{const a=new dx(e,i,n,s);await t(a,o)}}function fx(e,t,n){return new Proxy({},{get(s,i){return i in s||(s[i]=yx(e,i,t,n)),s[i]}})}function px(e){b((e==null?void 0:e.type)!=="complete","Cannot wait for complete results in custom mutations")}function mx(e,t,n,s){const i=new Mg(e,n,()=>cc,()=>cc,cc,cc,o=>o(),s,px);return new Proxy({},{get(o,a){return a in o||(o[a]=hf(i,t,a)),o[a]}})}function yx(e,t,n,s){const i=H(e.tables[t]),{primaryKey:o}=i;return{insert:a=>Og(n,{tableName:t,value:a},e,s),upsert:a=>Pg(n,{tableName:t,value:a},e,s),update:a=>Ag(n,{tableName:t,value:a},e,s),delete:a=>Lg(n,{tableName:t,value:a},e,s)}}var ur,ys,ws,qm,wx=(qm=class{constructor(e,t,n){l(this,ur);l(this,ys);l(this,ws);d(this,ur,e),d(this,ws,t),d(this,ys,n)}onClientsDeleted(e,t){var n,s;(s=(n=r(this,ys)).debug)==null||s.call(n,"DeletedClientsManager, send:",e),r(this,ur).call(this,["deleteClients",{clientIDs:e,clientGroupIDs:t}])}async sendDeletedClientsToServer(){var t,n;const e=await pe(r(this,ws),s=>No(s));(e.clientIDs.length>0||e.clientGroupIDs.length>0)&&(r(this,ur).call(this,["deleteClients",e]),(n=(t=r(this,ys)).debug)==null||n.call(t,"DeletedClientsManager, send:",e))}clientsDeletedOnServer(e){const{clientIDs:t=[],clientGroupIDs:n=[]}=e;return t.length>0||n.length>0?he(r(this,ws),async s=>{var i,o;(o=(i=r(this,ys)).debug)==null||o.call(i,"clientsDeletedOnServer:",t,n),await tD(s,t,n)}):me}getDeletedClients(){return pe(r(this,ws),No)}},ur=new WeakMap,ys=new WeakMap,ws=new WeakMap,qm),vx=/^(?:(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.){3}(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/,gx=/^\[[a-fA-F0-9:]*:[a-fA-F0-9:]*\]$/,bx=new RegExp(`(${vx.source}|${gx.source})`);function Sx(e,t=!0){if(!t)return!1;const n=e===null?null:new URL(e),s=n==null?void 0:n.hostname;return e!==null&&s!==void 0&&s!=="localhost"&&!bx.test(s)}function kx(e){return"ws"+e.slice(4)}function Hg(e,t){return e+(e.endsWith("/")?t.substring(1):t)}var Ix=new URL("https://http-intake.logs.datadoghq.com/api/v2/logs"),Cx=1e3,Tp=250,Dx=5*1024*1024,Op=2,Pp=Dx/4,Je,cr,vs,lr,hr,dr,ru,ou,fr,yl,au,yd,Qm,_x=(Qm=class{constructor(e){l(this,au);l(this,Je,[]);l(this,cr);l(this,vs);l(this,lr);l(this,hr);l(this,dr);l(this,ru);l(this,ou);l(this,fr,0);l(this,yl,new Ku);const{apiKey:t,source:n,service:s,host:i,version:o,interval:a=5e3,baseURL:u=Ix}=e;d(this,cr,t),d(this,vs,n),d(this,lr,s),d(this,hr,i),d(this,dr,o),d(this,ru,a),d(this,ou,u.toString())}log(e,t,...n){r(this,Je).push(Tx(n,t,e)),e==="error"||r(this,Je).length===Tp?this.flush():p(this,au,yd).call(this)}flush(){return r(this,yl).withLock(async()=>{const{length:e}=r(this,Je);if(e!==0){do{const t=Date.now(),n=[];let s=0;for(const u of r(this,Je)){u.flushDelayMs=t-u.date;let c=JSON.stringify(u);if(c.length>Pp&&(u.message=`[Dropped message of length ${c.length}]`,c=JSON.stringify(u)),c.length+s+n.length>Pp||(s+=c.length,n.push(c),n.length===Cx))break}const i=n.join(`
`),o=new URL(r(this,ou));r(this,cr)!==void 0&&o.searchParams.set("dd-api-key",r(this,cr)),r(this,vs)&&(o.searchParams.set("ddsource",r(this,vs)),o.searchParams.set("dd-evp-origin",r(this,vs))),r(this,lr)&&o.searchParams.set("service",r(this,lr)),r(this,hr)&&o.searchParams.set("host",r(this,hr)),r(this,dr)&&o.searchParams.set("ddtags",`version:${r(this,dr)}`);let a=!1;try{const u=await fetch(o.toString(),{method:"POST",body:i,keepalive:!0});a=u.ok,a||console.error("response",u.status,u.statusText,await u.text)}catch(u){console.error("Log flush to datadog failed",u)}if(a)r(this,Je).splice(0,n.length);else{let u=0;for(let c=0;c<n.length;c++){const h=r(this,Je)[c];h.flushRetryCount=(h.flushRetryCount??0)+1,h.flushRetryCount>Op&&u++}u>0&&(console.error(`Dropping ${u} datadog log messages which failed to send ${Op+1} times.`),r(this,Je).splice(0,u))}}while(r(this,Je).length>=Tp);r(this,Je).length&&p(this,au,yd).call(this)}})}},Je=new WeakMap,cr=new WeakMap,vs=new WeakMap,lr=new WeakMap,hr=new WeakMap,dr=new WeakMap,ru=new WeakMap,ou=new WeakMap,fr=new WeakMap,yl=new WeakMap,au=new WeakSet,yd=function(){r(this,fr)||d(this,fr,setTimeout(()=>{d(this,fr,0),this.flush()},r(this,ru)))},Qm);function Fg(e){return Array.isArray(e)&&e.length===1?Fg(e[0]):e}function Ap(e){return{name:e.name,message:e.message,stack:e.stack}}function Ex(e){if(e instanceof Error)return Ap(e);if(e instanceof Array){const t=[];for(const n of e)n instanceof Error?t.push(Ap(n)):t.push(n);return t}return e}var xx="flushRetryCount",Nx="flushDelayMs",Mx="@DATADOG_RESERVED_",Rx=["host","source","status","service","version","trace_id","message","msg","date",Nx,xx];function Tx(e,t,n){let s;if(t!==void 0)for(const o of Rx)Object.hasOwn(t,o)&&(s===void 0&&(s={...t}),s[Mx+o]=s[o],delete s[o]);const i={...s??t,date:Date.now(),message:Ex(Fg(e)),status:n};return n==="error"&&(i.error={origin:"logger"}),i}var zg="0.21.2025062401",uu,pr,Jm,Lp=(Jm=class{constructor(e,t){l(this,uu);l(this,pr);d(this,uu,e),d(this,pr,t)}log(e,t,...n){r(this,pr)==="error"&&e!=="error"||r(this,pr)==="info"&&e==="debug"||r(this,uu).log(e,t,...n)}async flush(){var e;await((e=Nn.flush)==null?void 0:e.call(Nn))}},uu=new WeakMap,pr=new WeakMap,Jm),Ox="info",Hp=".reflect-server.net";function Px(e,t=n=>new _x(n)){const{consoleLogLevel:n,server:s,enableAnalytics:i}=e;if(!i||s===null)return{logLevel:n,logSink:Nn};const o=new URL(s),{hostname:a}=o,u=a.endsWith(Hp)?a.substring(0,a.length-Hp.length).toLowerCase():a,c=new URL(Hg(s,"/logs/v0/log")),h=n==="debug"?"debug":"info",m=new av([new Lp(Nn,n),new Lp(t({service:u,host:location.host,version:zg,baseURL:c}),Ox)]);return{logLevel:h,logSink:m}}var Ax="time_to_connect_ms",Lx="last_connect_error",Hx="time_to_connect_ms_v2",Fx="last_connect_error_v2",zx="total_time_to_connect_ms",$x="not_connected",$g=100*1e3,Vx=5e3;function Vg(e){return"server"in e?`server_${Fp(e.server)}`:`client_${Fp(e.client)}`}function Fp(e){return e.split(/\.?(?=[A-Z])/).join("_").toLowerCase()}var cu,lu,hu,mr,mn,du,yr,wr,vr,gr,$e,Tc,Fn,Xm,jx=(Xm=class{constructor(e){l(this,$e);l(this,cu);l(this,lu);l(this,hu);l(this,mr);l(this,mn);l(this,du,[]);v(this,"timeToConnectMs",p(this,$e,Fn).call(this,new Oc(Ax)));v(this,"lastConnectError",p(this,$e,Fn).call(this,new Xl(Lx,!0)));l(this,yr,p(this,$e,Fn).call(this,new Xl($x)));l(this,wr,p(this,$e,Fn).call(this,new Oc(Hx)));l(this,vr,p(this,$e,Fn).call(this,new Xl(Fx)));l(this,gr,p(this,$e,Fn).call(this,new Oc(zx)));v(this,"tags",[]);d(this,cu,e.reportIntervalMs),d(this,lu,e.host),d(this,hu,e.reporter),d(this,mr,e.lc),this.tags.push(`source:${e.source}`),this.timeToConnectMs.set($g),p(this,$e,Tc).call(this,"init"),d(this,mn,setInterval(()=>{this.flush()},r(this,cu)))}setConnected(e,t){r(this,yr).clear(),r(this,vr).clear(),r(this,wr).set(e),r(this,gr).set(t)}setDisconnectedWaitingForVisible(){r(this,wr).clear(),r(this,gr).clear(),r(this,vr).clear();let e;switch(r(this,yr).get()){case"init":e="hidden_was_init";break;case"error":e="hidden_was_error";break;default:e="hidden";break}p(this,$e,Tc).call(this,e)}setConnectError(e){r(this,wr).clear(),r(this,gr).clear(),p(this,$e,Tc).call(this,"error"),r(this,vr).set(Vg(e))}async flush(){var n,s,i;const e=r(this,mr);if(r(this,mn)===null){(n=e.error)==null||n.call(e,"MetricManager.flush() called but already stopped");return}const t=[];for(const o of r(this,du)){const a=o.flush();a!==void 0&&t.push({...a,host:r(this,lu),tags:this.tags})}if(t.length===0){(s=e==null?void 0:e.debug)==null||s.call(e,"No metrics to report");return}try{await r(this,hu).call(this,t)}catch(o){(i=e==null?void 0:e.error)==null||i.call(e,"Error reporting metrics",o)}}stop(){var e,t;if(r(this,mn)===null){(t=(e=r(this,mr)).error)==null||t.call(e,"MetricManager.stop() called but already stopped");return}clearInterval(r(this,mn)),d(this,mn,null)}},cu=new WeakMap,lu=new WeakMap,hu=new WeakMap,mr=new WeakMap,mn=new WeakMap,du=new WeakMap,yr=new WeakMap,wr=new WeakMap,vr=new WeakMap,gr=new WeakMap,$e=new WeakSet,Tc=function(e){r(this,yr).set(e)},Fn=function(e){return r(this,du).push(e),e},Xm);function Gx(e,t){return[e,[t]]}var fu,yn,Ym,Oc=(Ym=class{constructor(e){l(this,fu);l(this,yn);d(this,fu,e)}set(e){d(this,yn,e)}get(){return r(this,yn)}clear(){d(this,yn,void 0)}flush(){if(r(this,yn)===void 0)return;const e=[Gx(Bx(),r(this,yn))];return{metric:r(this,fu),points:e}}},fu=new WeakMap,yn=new WeakMap,Ym);function Bx(){return Math.round(Date.now()/1e3)}var pu,mu,wn,Zm,Xl=(Zm=class{constructor(e,t=!1){l(this,pu);l(this,mu);l(this,wn);d(this,pu,e),d(this,mu,t)}set(e){d(this,wn,e)}get(){return r(this,wn)}clear(){d(this,wn,void 0)}flush(){if(r(this,wn)===void 0)return;const e=new Oc([r(this,pu),r(this,wn)].join("_"));e.set(1);const t=e.flush();return r(this,mu)&&this.clear(),t}},pu=new WeakMap,mu=new WeakMap,wn=new WeakMap,Zm),Ux=["zeroPusher","http","unsupportedPushVersion","unsupportedSchemaVersion"],Kx=0;function qx(){return++Kx}var He,vn,br,Sr,kr,ie,jg,Gg,wd,Bg,fo,Ug,Wm,Qx=(Wm=class{constructor(e){l(this,ie);l(this,He);l(this,vn);l(this,br);l(this,Sr);l(this,kr);d(this,Sr,e.withContext("MutationTracker")),d(this,He,new Map),d(this,vn,new Map),d(this,br,new Set)}set clientID(e){d(this,kr,e)}trackMutation(){const e=qx(),t=$();return r(this,He).set(e,{resolver:t}),{ephemeralID:e,serverPromise:t.promise}}mutationIDAssigned(e,t){const n=r(this,He).get(e);n&&(n.mutationID=t,r(this,vn).set(t,e))}rejectMutation(e,t){const n=r(this,He).get(e);n&&p(this,ie,fo).call(this,e,n,"reject",t)}processPushResponse(e){var t,n;"error"in e?((n=(t=r(this,Sr)).error)==null||n.call(t,"Received an error response when pushing mutations",e),p(this,ie,jg).call(this,e)):p(this,ie,Gg).call(this,e)}onConnected(e){for(const[t,n]of r(this,He))if(n.mutationID)if(n.mutationID<=e)p(this,ie,fo).call(this,t,n,"resolve",hx);else break}get size(){return r(this,He).size}onAllMutationsConfirmed(e){r(this,br).add(e)}},He=new WeakMap,vn=new WeakMap,br=new WeakMap,Sr=new WeakMap,kr=new WeakMap,ie=new WeakSet,jg=function(e){if(Ux.includes(e.error))return;const t=e.mutationIDs;if(t)for(const n of t)p(this,ie,wd).call(this,n,e)},Gg=function(e){for(const t of e.mutations)"error"in t.result?p(this,ie,wd).call(this,t.id,t.result):p(this,ie,Bg).call(this,t.result,t.id)},wd=function(e,t){var i,o;b(e.clientID===r(this,kr),"received mutation for the wrong client"),(o=(i=r(this,Sr)).error)==null||o.call(i,`Mutation ${e.id} returned an error`,t);const n=r(this,vn).get(e.id);if(!n&&t.error==="alreadyProcessed")return;b(n,`ephemeral ID is missing for mutation error: ${t.error}.`);const s=r(this,He).get(n);b(s&&s.mutationID===e.id),p(this,ie,fo).call(this,n,s,"reject",t)},Bg=function(e,t){b(t.clientID===r(this,kr),"received mutation for the wrong client");const n=r(this,vn).get(t.id);b(n,"ephemeral ID is missing. This can happen if a mutation response is received twice but it should be impossible to receive a success response twice for the same mutation.");const s=r(this,He).get(n);b(s&&s.mutationID===t.id),p(this,ie,fo).call(this,n,s,"resolve",e)},fo=function(e,t,n,s){switch(n){case"resolve":t.resolver.resolve(s);break;case"reject":t.resolver.reject(s);break}const i=r(this,He).delete(e);t.mutationID&&r(this,vn).delete(t.mutationID),i&&r(this,He).size===0&&p(this,ie,Ug).call(this)},Ug=function(){for(const e of r(this,br))e()},Wm),zp=0,Jx=1,yu,wu,gs,ot,vu,gn,Ir,Cr,bs,De,vd,gd,Pc,bd,ey,Xx=(ey=class{constructor(e,t,n,s,i,o){l(this,De);l(this,yu);l(this,wu);l(this,gs);l(this,ot,new Map);l(this,vu);l(this,gn,new Set);l(this,Ir,new Set);l(this,Cr);l(this,bs,[]);d(this,yu,t),d(this,wu,gf(n)),d(this,vu,o),d(this,gs,s),d(this,Cr,e),r(this,Cr).onAllMutationsConfirmed(()=>{if(r(this,bs).length===0)return;const a=r(this,bs);d(this,bs,[]);for(const u of a)u()}),i(a=>{for(const u of a){const c=u.key.substring(Sh.length);switch(u.op){case"add":r(this,Ir).add(c),p(this,De,vd).call(this,c,!0);break;case"del":r(this,Ir).delete(c),p(this,De,vd).call(this,c,!1);break}}},{prefix:Sh,initialValuesInFirstDiff:!0})}async getQueriesPatch(e,t){const n=new Set,s=Hk(r(this,yu));for await(const o of e.scan({prefix:s}).keys())n.add(o.substring(s.length,o.length));const i=new Map;for(const o of n)r(this,ot).has(o)||i.set(o,{op:"del",hash:o});for(const[o,{normalized:a,ttl:u,name:c,args:h}]of r(this,ot))n.has(o)||i.set(o,{op:"put",hash:o,ast:a,name:c,args:h,ttl:wo(u)});if(t){for(const[o,{op:a}]of t)a==="put"&&!i.has(o)&&i.set(o,{op:"del",hash:o});for(const[o,{op:a}]of i){const u=t.get(o);u&&u.op===a&&i.delete(o)}}return i}addCustom(e,t,n,s){const i=Jf(e,t);return p(this,De,gd).call(this,i,void 0,e,t,n,s)}addLegacy(e,t,n){const s=vh(e),i=kh(s);return p(this,De,gd).call(this,i,s,void 0,void 0,t,n)}updateCustom(e,t,n){const s=Jf(e,t),i=H(r(this,ot).get(s));p(this,De,Pc).call(this,i,s,n)}updateLegacy(e,t){const n=vh(e),s=kh(n),i=H(r(this,ot).get(s));p(this,De,Pc).call(this,i,s,t)}},yu=new WeakMap,wu=new WeakMap,gs=new WeakMap,ot=new WeakMap,vu=new WeakMap,gn=new WeakMap,Ir=new WeakMap,Cr=new WeakMap,bs=new WeakMap,De=new WeakSet,vd=function(e,t){var s;const n=((s=r(this,ot).get(e))==null?void 0:s.gotCallbacks)??[];for(const i of n)i(t)},gd=function(e,t,n,s,i,o){b(t===void 0&&n!==void 0&&s!==void 0||t!==void 0&&n===void 0&&s===void 0,"Either normalized or name and args must be defined, but not both.");let a=r(this,ot).get(e);r(this,gn).delete(e),a?(++a.count,p(this,De,Pc).call(this,a,e,i),o&&a.gotCallbacks.push(o)):(t!==void 0&&(t=xk(t,r(this,wu))),a={normalized:t,name:n,args:s,count:1,gotCallbacks:o?[o]:[],ttl:i},r(this,ot).set(e,a),r(this,gs).call(this,["changeDesiredQueries",{desiredQueriesPatch:[{op:"put",hash:e,ast:t,name:n,args:s,ttl:wo(i)}]}])),o&&o(r(this,Ir).has(e));let u=!1;return()=>{if(!u){if(u=!0,r(this,Cr).size>0){r(this,bs).push(()=>p(this,De,bd).call(this,a,e,o));return}p(this,De,bd).call(this,a,e,o)}}},Pc=function(e,t,n){rk(n,e.ttl)>0&&(e.ttl=n,r(this,gs).call(this,["changeDesiredQueries",{desiredQueriesPatch:[{op:"put",hash:t,ast:e.normalized,name:e.name,args:e.args,ttl:wo(n)}]}]))},bd=function(e,t,n){if(n){const s=e.gotCallbacks.indexOf(n);e.gotCallbacks.splice(s,1)}if(--e.count,e.count===0&&(r(this,gn).add(t),r(this,gn).size>r(this,vu))){const s=r(this,gn).values().next().value;b(s),r(this,ot).delete(s),r(this,gn).delete(s),r(this,gs).call(this,["changeDesiredQueries",{desiredQueriesPatch:[{op:"del",hash:s}]}])}},ey),Yx=Ae(Mc.NewClientGroup,Mc.VersionNotSupported,Mc.SchemaVersionNotSupported),Sd="_zeroReloadReason",bf="_zeroReloadBackoffState",Zx=f.tuple([f.union(Yx,G_),f.string()]),Wx=f.object({lastReloadTime:f.number().default(0),nextIntervalMs:f.number().default(0)}),lc=500,$p=6e4,Vp=1e4,Ac=null;function Yl(e,t,n,s){var u,c;if(Ac){(u=e.info)==null||u.call(e,"reload timer already scheduled");return}const i=Date.now(),o=nN(e,i);typeof sessionStorage<"u"&&(sessionStorage.setItem(bf,JSON.stringify(o)),sessionStorage.setItem(Sd,JSON.stringify([n,s])));const a=o.lastReloadTime-i;(c=e.error)==null||c.call(e,n,`
`,"reloading",a>0?`in ${a/1e3} seconds`:""),Ac=setTimeout(()=>{Ac=null,t()},a)}function eN(e){var t,n;if(typeof sessionStorage<"u"){const s=sessionStorage.getItem(Sd);if(s){sessionStorage.removeItem(Sd);try{const i=JSON.parse(s),[o,a]=Ct(i,Zx);(t=e.error)==null||t.call(e,o,"Zero reloaded the page.",a)}catch(i){(n=e.error)==null||n.call(e,"Zero reloaded the page.",i);return}}}}function tN(){return Ac!==null}function jp(){typeof sessionStorage<"u"&&sessionStorage.removeItem(bf)}function nN(e,t){var u,c;if(typeof sessionStorage>"u")return(u=e.warn)==null||u.call(e,`sessionStorage not supported. backing off in ${Vp/1e3} seconds`),{lastReloadTime:t+Vp,nextIntervalMs:lc};const n=sessionStorage.getItem(bf);if(!n)return{lastReloadTime:t,nextIntervalMs:lc};let s;try{s=Ct(JSON.parse(n),Wx,"passthrough")}catch(h){return(c=e.warn)==null||c.call(e,"ignoring unparsable backoff state",n,h),{lastReloadTime:t,nextIntervalMs:lc}}const{lastReloadTime:i,nextIntervalMs:o}=s;return t-i>$p*2?{lastReloadTime:t,nextIntervalMs:lc}:t<i?s:{lastReloadTime:Math.max(t,i+o),nextIntervalMs:Math.min(o*2,$p)}}var Kg=class extends Error{constructor(t){super(t.kind+": "+t.message);v(this,"name","ServerError");v(this,"errorBody");this.errorBody=t}get kind(){return this.errorBody.kind}};function ol(e){return e instanceof Kg}function Gp(e){return ol(e)&&sN(e.kind)}function sN(e){return e===V.AuthInvalidated||e===V.Unauthorized}function iN(e){if(ol(e))switch(e.errorBody.kind){case V.Rebalance:case V.Rehome:case V.ServerOverloaded:return e.errorBody}}function rN(e,t){const n="http",s=(u="")=>` For example: "${n}s://myapp-myteam.zero.ms/${u}".`;if(!t.startsWith(`${n}://`)&&!t.startsWith(`${n}s://`))throw new Error(`ZeroOptions.${e} must use the "${n}" or "${n}s" scheme.`);let i;try{i=new URL(t)}catch{throw new Error(`ZeroOptions.${e} must be a valid URL.${s()}`)}const o=i.toString(),a=i.pathname.split("/");if(a[0]===""&&a.shift(),a[a.length-1]===""&&a.pop(),a.length>1)throw new Error(`ZeroOptions.${e} may have at most one path component.${s("zero")}`);for(const[u,c]of[["search","?"],["hash","#"]])if(i[u]||o.endsWith(c))throw new Error(`ZeroOptions.${e} must not contain a ${u} component.${s()}`);return o}function oN(e){return ze("WebSocket")?e==null?(console.warn("Zero starting up with no server URL. No data will be synced."),null):rN("server",e):(console.warn("Zero started in an unsupported environment, no data will be synced."),null)}var aN=Jc,gu,bu,Su,Ht,ke,Ft,Dr,ku,wl,Iu,Cu,Du,Me,qg,_u,Qg,po,kd,ty,uN=(ty=class{constructor(e,t,n,s,i){l(this,Me);l(this,gu);l(this,bu);l(this,Su);l(this,Ht);l(this,ke);l(this,Ft,[]);l(this,Dr,!1);l(this,ku,0);l(this,wl,new Ku);l(this,Iu);l(this,Cu);l(this,Du,FI("requestAnimationFrame")??hN);l(this,_u,async()=>{var n,s,i;const e=r(this,Ht).withContext("rafAt",Math.floor(performance.now()));if(r(this,Ft).length===0){(n=e.debug)==null||n.call(e,"stopping playback loop"),d(this,Dr,!1);return}r(this,Du).call(this,r(this,_u));const t=performance.now();(s=e.debug)==null||s.call(e,"raf fired, processing pokes.  Since last raf",t-r(this,ku)),d(this,ku,t),await p(this,Me,Qg).call(this,e),(i=e.debug)==null||i.call(e,"processing pokes took",performance.now()-t)});d(this,gu,e),d(this,bu,t),d(this,Su,n),d(this,Iu,s),d(this,Cu,HE(s.tables)),d(this,Ht,i.withContext("PokeHandler"))}handlePokeStart(e){if(r(this,ke)){p(this,Me,po).call(this,`pokeStart ${JSON.stringify(e)} while still receiving  ${JSON.stringify(r(this,ke).pokeStart)} `);return}d(this,ke,{pokeStart:e,parts:[]})}handlePokePart(e){var t,n,s;if(e.pokeID!==((t=r(this,ke))==null?void 0:t.pokeStart.pokeID)){p(this,Me,po).call(this,`pokePart for ${e.pokeID}, when receiving ${(n=r(this,ke))==null?void 0:n.pokeStart.pokeID}`);return}return r(this,ke).parts.push(e),(s=e.lastMutationIDChanges)==null?void 0:s[r(this,Su)]}handlePokeEnd(e){var t,n;if(e.pokeID!==((t=r(this,ke))==null?void 0:t.pokeStart.pokeID)){p(this,Me,po).call(this,`pokeEnd for ${e.pokeID}, when receiving ${(n=r(this,ke))==null?void 0:n.pokeStart.pokeID}`);return}if(e.cancel){d(this,ke,void 0);return}r(this,Ft).push({...r(this,ke),pokeEnd:e}),d(this,ke,void 0),r(this,Dr)||p(this,Me,qg).call(this)}handleDisconnect(){var e,t;(t=(e=r(this,Ht)).debug)==null||t.call(e,"clearing due to disconnect"),p(this,Me,kd).call(this)}},gu=new WeakMap,bu=new WeakMap,Su=new WeakMap,Ht=new WeakMap,ke=new WeakMap,Ft=new WeakMap,Dr=new WeakMap,ku=new WeakMap,wl=new WeakMap,Iu=new WeakMap,Cu=new WeakMap,Du=new WeakMap,Me=new WeakSet,qg=function(){var e,t;(t=(e=r(this,Ht)).debug)==null||t.call(e,"starting playback loop"),d(this,Dr,!0),r(this,Du).call(this,r(this,_u))},_u=new WeakMap,Qg=function(e){return r(this,wl).withLock(async()=>{var n,s,i,o,a;const t=Date.now();(n=e.debug)==null||n.call(e,"got poke lock at",t),(s=e.debug)==null||s.call(e,"merging",r(this,Ft).length);try{const u=cN(r(this,Ft),r(this,Iu),r(this,Cu));if(r(this,Ft).length=0,u===void 0){(i=e.debug)==null||i.call(e,"frame is empty");return}const c=performance.now();(o=e.debug)==null||o.call(e,"poking replicache"),await r(this,gu).call(this,u),(a=e.debug)==null||a.call(e,"poking replicache took",performance.now()-c)}catch(u){p(this,Me,po).call(this,u)}})},po=function(e){var t,n,s,i;String(e).includes("unexpected base cookie for poke")?(n=(t=r(this,Ht)).debug)==null||n.call(t,"clearing due to",e):(i=(s=r(this,Ht)).error)==null||i.call(s,"clearing due to unexpected poke error",e),p(this,Me,kd).call(this),r(this,bu).call(this)},kd=function(){d(this,ke,void 0),r(this,Ft).length=0},ty);function cN(e,t,n){if(e.length===0)return;const{baseCookie:s}=e[0].pokeStart,i=e[e.length-1],{cookie:o}=i.pokeEnd,a=[],u={};let c;for(const h of e){if(c&&h.pokeStart.baseCookie&&h.pokeStart.baseCookie>c.cookie)throw Error(`unexpected cookie gap ${JSON.stringify(c)} ${JSON.stringify(h.pokeStart)}`);c=h.pokeEnd;for(const m of h.parts){if(m.lastMutationIDChanges)for(const[y,w]of Object.entries(m.lastMutationIDChanges))u[y]=w;if(m.desiredQueriesPatches)for(const[y,w]of Object.entries(m.desiredQueriesPatches))a.push(...w.map(g=>Bp(g,S=>Lk(y,S))));m.gotQueriesPatch&&a.push(...m.gotQueriesPatch.map(y=>Bp(y,Fk))),m.rowsPatch&&a.push(...m.rowsPatch.map(y=>lN(y,t,n)))}}return{baseCookie:s,pullResponse:{lastMutationIDChanges:u,patch:a,cookie:o}}}function Bp(e,t){switch(e.op){case"clear":return e;case"del":return{op:"del",key:t(e.hash)};case"put":default:return{op:"put",key:t(e.hash),value:null}}}function lN(e,t,n){if(e.op==="clear")return e;const s=n.tableName(e.tableName,e);switch(e.op){case"del":return{op:"del",key:Ms(s,t.tables[s].primaryKey,n.row(e.tableName,e.id))};case"put":return{op:"put",key:Ms(s,t.tables[s].primaryKey,n.row(e.tableName,e.value)),value:n.row(e.tableName,e.value)};case"update":return{op:"update",key:Ms(s,t.tables[s].primaryKey,n.row(e.tableName,e.id)),merge:e.merge?n.row(e.tableName,e.merge):void 0,constrain:n.columns(e.tableName,e.constrain)};default:throw new Error("to be implemented")}}function hN(e){setTimeout(e,0)}var _r,Eu,xu,Ss,Nu,Er,ny,dN=(ny=class{constructor(e,t,n,s){l(this,_r);l(this,Eu);l(this,xu);l(this,Ss);l(this,Nu);l(this,Er);v(this,"getTxData",(e,t)=>{if(r(this,xu))return r(this,Eu).forkToHead(H(r(this,Nu)),e,t).then(n=>({ivmSources:n,token:r(this,Er)}))});v(this,"advance",(e,t,n)=>{r(this,_r).processChanges(e,t,n)});d(this,_r,e),d(this,Eu,t),d(this,xu,n),d(this,Ss,s)}set auth(e){e===""?d(this,Er,void 0):d(this,Er,e)}async init(e,t){const n=[];await pe(t,async s=>{const i=await E0(e,s,Ie);for await(const o of i.map.scan(Tn)){if(!o[0].startsWith(Tn))break;n.push({op:"add",key:o[0],newValue:o[1]})}}),d(this,Nu,t),r(this,_r).processChanges(void 0,e,n)}trackMutation(){return r(this,Ss).trackMutation()}mutationIDAssigned(e,t){r(this,Ss).mutationIDAssigned(e,t)}rejectMutation(e,t){r(this,Ss).rejectMutation(e,t)}},_r=new WeakMap,Eu=new WeakMap,xu=new WeakMap,Ss=new WeakMap,Nu=new WeakMap,Er=new WeakMap,ny),Up=5e3,fN=5e3,pN=5e3,mN=5e3,yN=5e3,wN=1e4,vN=6,hc={clientID:"",id:-1};function gN(e){return{type:e.type}}function bN(e,t){const{type:n}=e;let s="";switch(n){case"NewClientGroup":s="This client could not sync with a newer client. This is probably due to another tab loading a newer incompatible version of the app's code.";break;case"VersionNotSupported":s="The server no longer supports this client's protocol version.";break;case"SchemaVersionNotSupported":s="Client and server schemas incompatible.";break;default:we()}return t&&(s+=" "+t),s}var SN="Server reported that client is ahead of server. This probably happened because the server is in development mode and restarted. Currently when this happens, the dev server loses its state and on reconnect sees the client as ahead. If you see this in other cases, it may be a bug in Zero.";function kN(e){return`Server could not find state needed to synchronize this client. ${e}`}var IN="The local persistent state needed to synchronize this client has been garbage collected.",CN=1e3,U,bn,q,Mu,xr,Ru,Nr,Sn,wt,Mr,Tu,ks,zt,kn,vt,$t,Ou,Rr,Pu,Tr,Au,Is,Or,Pr,In,gt,Cn,Dn,Xe,Ar,Cs,Q,Lu,Lr,bt,Ds,_s,ce,N,Lc,Ne,St,Vt,Fe,Hr,Jg,Xg,Id,Yg,Hu,Fu,zu,$u,Zg,Wg,eb,Qt,tb,nb,sb,ib,rb,ob,Cd,ab,ub,Hc,cb,lb,Fc,hb,db,Ts,DN=(Ts=class{constructor(t){l(this,N);v(this,"version",zg);l(this,U);l(this,bn);v(this,"userID");v(this,"storageKey");l(this,q);l(this,Mu);l(this,xr);l(this,Ru);l(this,Nr);l(this,Sn);l(this,wt);l(this,Mr);l(this,Tu);l(this,ks);l(this,zt);l(this,kn);l(this,vt);l(this,$t,hc);l(this,Ou,()=>{});l(this,Rr,!1);l(this,Pu);l(this,Tr);l(this,Au);l(this,Is,null);l(this,Or,0);l(this,Pr,0);l(this,In,0);l(this,gt,0);l(this,Cn,()=>{});l(this,Dn);v(this,"queryDelegate");l(this,Xe,$());l(this,Ar,new Map);l(this,Cs,0);l(this,Q);l(this,Lu,$());l(this,Lr,$());l(this,bt);l(this,Ds,new AbortController);l(this,_s);l(this,ce,qt);l(this,Ne);l(this,St);l(this,Vt);v(this,"query");l(this,Fe);l(this,Hr,()=>{var t;return(t=ze("location"))==null?void 0:t.reload()});v(this,"mutate");v(this,"mutateBatch");l(this,Hu,t=>{var n,s,i,o;t.persisted?(s=(n=r(this,q)).debug)==null||s.call(n,"Ignoring pagehide event because it was persisted"):((o=(i=r(this,q)).debug)==null||o.call(i,"Closing client because we got a clean close"),this.close().catch(()=>{}))});l(this,Fu,t=>{var u,c;const n=r(this,q);if((u=n.debug)==null||u.call(n,"received message",t.data),this.closed){(c=n.debug)==null||c.call(n,"ignoring message because already closed");return}const s=h=>{var m;return(m=r(this,bt))==null?void 0:m.reject(new Error(`Invalid message received from server: ${h instanceof Error?h.message+". ":""}${o}`))};let i;const{data:o}=t;try{i=Ct(JSON.parse(o),AE)}catch(h){s(h);return}switch(Et(this,Pr)._++,i[0]){case"connected":return p(this,N,Wg).call(this,n,i);case"error":return p(this,N,Zg).call(this,n,i);case"pong":return jp(),r(this,Ou).call(this);case"pokeStart":return p(this,N,tb).call(this,n,i);case"pokePart":return i[1].rowsPatch&&jp(),p(this,N,nb).call(this,n,i);case"pokeEnd":return p(this,N,sb).call(this,n,i);case"pull":return p(this,N,rb).call(this,n,i);case"deleteClients":return r(this,ks).clientsDeletedOnServer(i[1]);case"pushResponse":return r(this,zt).processPushResponse(i[1]);case"inspect":break;default:s()}});l(this,zu,()=>{var n,s;const t=Zl(r(this,Q),r(this,q));if(r(this,Ne)===void 0)(n=t.error)==null||n.call(t,"Got open event but connect start time is undefined.");else{const o=Date.now()-r(this,Ne);(s=t.info)==null||s.call(t,"Got socket open event",{navigatorOnline:ge==null?void 0:ge.onLine,timeToOpenMs:o})}});l(this,$u,t=>{var u,c;const n=Zl(r(this,Q),r(this,q)),{code:s,reason:i,wasClean:o}=t;s<=1001?(u=n.info)==null||u.call(n,"Got socket close event",{code:s,reason:i,wasClean:o}):(c=n.error)==null||c.call(n,"Got unexpected socket close event",{code:s,reason:i,wasClean:o});const a=o?"CleanClose":"AbruptClose";r(this,Xe).reject(new qp(a)),p(this,N,Qt).call(this,n,{client:a})});var Xr;const{userID:n,storageKey:s,onOnlineChange:i,onUpdateNeeded:o,onClientStateNotFound:a,hiddenTabDisconnectDelay:u=yN,schema:c,batchViewUpdates:h=R=>R(),maxRecentQueries:m=0,slowMaterializeThreshold:y=5e3}=t;if(!n)throw new Error("ZeroOptions.userID must not be empty.");const w=oN(t.server);d(this,xr,Sx(w,!1));let{kvStore:g="idb"}=t;if(g==="idb"&&(ze("indexedDB")||(console.warn("IndexedDB is not supported in this environment. Falling back to memory storage."),g="mem")),u<0)throw new Error("ZeroOptions.hiddenTabDisconnectDelay must not be negative.");d(this,Pu,i),d(this,Vt,t),d(this,Mu,p(this,N,Yg).call(this,{consoleLogLevel:t.logLevel??"error",server:null,enableAnalytics:r(this,xr)}));const S=r(this,Mu),I={[nl]:lx(c)};d(this,Mr,new ix(c.tables));function D(R){b(I[R]===void 0,`A mutator, or mutator namespace, has already been defined for ${R}`)}const{onError:k}=t,C=S.logSink,M={log(R,j,...Z){R==="error"&&k?k(...Z):C.log(R,j,...Z)},async flush(){var R;await((R=C.flush)==null?void 0:R.call(C))}},_=new aN(S.logLevel,{},M);if(d(this,zt,new Qx(_)),t.mutators)for(const[R,j]of Object.entries(t.mutators)){if(typeof j=="function"){const Z=R;D(Z),I[Z]=Rp(_,j,c,y);continue}if(typeof j=="object"){for(const[Z,zs]of Object.entries(j)){const If=xp(R,Z);D(If),I[If]=Rp(_,zs,c,y)}continue}we()}this.storageKey=s??"",d(this,Ru,c);const{clientSchema:x,hash:O}=x_(c);d(this,Nr,x);const T={schemaVersion:`${vf}.${O}`,logLevel:S.logLevel,logSinks:[S.logSink],mutators:I,name:`zero-${n}-${this.storageKey}`,pusher:(R,j)=>p(this,N,ob).call(this,R,j),puller:(R,j)=>p(this,N,ub).call(this,R,j),pushDelay:0,requestOptions:{maxDelayMs:0,minDelayMs:0},licenseKey:"zero-client-static-key",kvStore:g};d(this,Dn,new Mg(_,r(this,Mr),(R,j,Z)=>r(this,wt).addLegacy(R,j,Z),(R,j,Z,zs)=>r(this,wt).addCustom(R,j,Z,zs),(R,j)=>r(this,wt).updateLegacy(R,j),(R,j,Z)=>r(this,wt).updateCustom(R,j,Z),h,y,EN)),this.queryDelegate=r(this,Dn);const L={enableClientGroupForking:!1,enableMutationRecovery:!1,enablePullAndPushInOpen:!1,onClientsDeleted:(R,j)=>r(this,ks).onClientsDeleted(R,j),zero:new dN(r(this,Dn),r(this,Mr),t.mutators!==void 0,r(this,zt))},P=new e_(T,L);d(this,U,P),d(this,bn,w),this.userID=n,d(this,q,_.withContext("clientID",P.clientID)),r(this,zt).clientID=P.clientID;const X=(R,j)=>{o?o(R):Yl(r(this,q),r(this,Hr),R.type,bN(R,j))};d(this,Tr,X),r(this,U).onUpdateNeeded=R=>{X(gN(R))};const Y=a??(R=>{Yl(r(this,q),r(this,Hr),V.ClientNotFound,R??IN)});d(this,Au,Y),r(this,U).onClientStateNotFound=Y;const{mutate:oe,mutateBatch:ec}=ax(c,P.mutate);if(t.mutators)for(const[R,j]of Object.entries(t.mutators)){if(typeof j=="function"){oe[R]=H(P.mutate[R]);continue}let Z=oe[R];Z===void 0&&(Z={},oe[R]=Z);for(const zs of Object.keys(j))Z[zs]=H(P.mutate[xp(R,zs)])}this.mutate=oe,this.mutateBatch=ec,d(this,wt,new Xx(r(this,zt),P.clientID,c.tables,R=>p(this,N,Id).call(this,R),P.experimentalWatch.bind(P),m)),d(this,Tu,gf(c.tables)),d(this,ks,new wx(R=>p(this,N,Id).call(this,R),P.perdag,r(this,q))),this.query=p(this,N,db).call(this,c),eN(r(this,q)),d(this,Fe,new jx({reportIntervalMs:Vx,host:((Xr=ze("location"))==null?void 0:Xr.host)??"",source:"client",reporter:r(this,xr)?R=>p(this,N,lb).call(this,R):()=>Promise.resolve(),lc:r(this,q)})),r(this,Fe).tags.push(`version:${this.version}`),d(this,Sn,new uN(R=>r(this,U).poke(R),()=>p(this,N,ib).call(this),P.clientID,c,r(this,q))),d(this,_s,bv(ze("document"),u,r(this,Ds).signal)),p(this,N,ab).call(this),p(this,N,Jg).call(this)}preload(t,n){return t.delegate(r(this,Dn)).preload(n)}get server(){return r(this,bn)}get idbName(){return r(this,U).idbName}get schemaVersion(){return r(this,U).schemaVersion}get clientID(){return r(this,U).clientID}get clientGroupID(){return r(this,U).clientGroupID}get closed(){return r(this,U).closed}async close(){var s,i,o;const t=r(this,q).withContext("close");if((s=t.debug)==null||s.call(t,"Closing Zero instance. Stack:",new Error().stack),r(this,ce)!==qt){let a=JSON.stringify(["closeConnection",[]]);a.length>123&&((i=t.warn)==null||i.call(t,"Close reason is too long. Removing it."),a=""),p(this,N,Qt).call(this,t,{client:"ClientClosed"},CN,a)}(o=t.debug)==null||o.call(t,"Aborting closeAbortController due to close()"),r(this,Ds).abort(),r(this,Fe).stop();const n=await r(this,U).close();return p(this,N,Xg).call(this),n}get online(){return r(this,Rr)}async inspect(){return(await kb(()=>import("./inspector-LF6RTN44-DguwnzB1.js"),__vite__mapDeps([0,1,2]))).newInspector(r(this,U),r(this,Ru),async()=>(await r(this,Xe).promise,r(this,Q)))}},U=new WeakMap,bn=new WeakMap,q=new WeakMap,Mu=new WeakMap,xr=new WeakMap,Ru=new WeakMap,Nr=new WeakMap,Sn=new WeakMap,wt=new WeakMap,Mr=new WeakMap,Tu=new WeakMap,ks=new WeakMap,zt=new WeakMap,kn=new WeakMap,vt=new WeakMap,$t=new WeakMap,Ou=new WeakMap,Rr=new WeakMap,Pu=new WeakMap,Tr=new WeakMap,Au=new WeakMap,Is=new WeakMap,Or=new WeakMap,Pr=new WeakMap,In=new WeakMap,gt=new WeakMap,Cn=new WeakMap,Dn=new WeakMap,Xe=new WeakMap,Ar=new WeakMap,Cs=new WeakMap,Q=new WeakMap,Lu=new WeakMap,Lr=new WeakMap,bt=new WeakMap,Ds=new WeakMap,_s=new WeakMap,ce=new WeakMap,N=new WeakSet,Lc=function(t){t!==r(this,ce)&&(d(this,ce,t),r(this,Lr).resolve(t),d(this,Lr,$()))},Ne=new WeakMap,St=new WeakMap,Vt=new WeakMap,Fe=new WeakMap,Hr=new WeakMap,Jg=function(){const t=globalThis;if(t.__zero===void 0)t.__zero=this;else if(t.__zero instanceof Ts){const n=t.__zero;t.__zero={[n.clientID]:n,[this.clientID]:this}}else t.__zero[this.clientID]=this},Xg=function(){const t=globalThis;b(t.__zero!==void 0),t.__zero instanceof Ts?(b(t.__zero===this),delete t.__zero):(delete t.__zero[this.clientID],Object.entries(t.__zero).length===1&&(t.__zero=Object.values(t.__zero)[0]))},Id=function(t){r(this,Q)&&r(this,ce)===to&&An(r(this,Q),t)},Yg=function(t){return Px(t)},Hu=new WeakMap,Fu=new WeakMap,zu=new WeakMap,$u=new WeakMap,Zg=async function(t,n){var a,u,c,h,m,y,w;const[,{kind:s,message:i}]=n;if(s===V.MutationRateLimited){d(this,$t,hc),(a=t.error)==null||a.call(t,s,"Mutation rate limited",{message:i});return}(u=t.info)==null||u.call(t,`${s}: ${i}}`);const o=new Kg(n[1]);(c=r(this,bt))==null||c.reject(o),(h=t.debug)==null||h.call(t,"Rejecting connect resolver due to error",o),r(this,Xe).reject(o),p(this,N,Qt).call(this,t,{server:s}),s===V.VersionNotSupported?(m=r(this,Tr))==null||m.call(this,{type:s},i):s===V.SchemaVersionNotSupported?(await r(this,U).disableClientGroup(),(y=r(this,Tr))==null||y.call(this,{type:"SchemaVersionNotSupported"},i)):s===V.ClientNotFound?(await r(this,U).disableClientGroup(),(w=r(this,Au))==null||w.call(this,kN(i))):(s===V.InvalidConnectionRequestLastMutationID||s===V.InvalidConnectionRequestBaseCookie)&&(await SD(r(this,U).idbName),Yl(t,r(this,Hr),s,SN))},Wg=async function(t,n){var g,S,I,D;const s=Date.now(),[,i]=n;t=_d(i.wsid,t),r(this,Or)===0?p(this,N,Fc).call(this,"firstConnect"):r(this,gt)>0&&p(this,N,Fc).call(this,"connectAfterError"),Et(this,Or)._++,d(this,In,s),r(this,Fe).lastConnectError.clear();const o=r(this,gt);d(this,gt,0);let a,u;r(this,Ne)===void 0?(g=t.error)==null||g.call(t,"Got connected message but connect start time is undefined."):(a=s-r(this,Ne),r(this,Fe).timeToConnectMs.set(a),u=i.timestamp!==void 0?s-i.timestamp:void 0,d(this,Ne,void 0));let c;r(this,St)===void 0?(S=t.error)==null||S.call(t,"Got connected message but total to connect start time is undefined."):(c=s-r(this,St),d(this,St,void 0)),r(this,Fe).setConnected(a??0,c??0),(I=t.info)==null||I.call(t,"Connected",{navigatorOnline:ge==null?void 0:ge.onLine,timeToConnectMs:a,totalTimeToConnectMs:c,connectMsgLatencyMs:u,connectedCount:r(this,Or),proceedingConnectErrorCount:o}),d(this,$t,hc),(D=t.debug)==null||D.call(t,"Resolving connect resolver");const h=H(r(this,Q)),m=await r(this,U).query(k=>r(this,wt).getQueriesPatch(k,r(this,kn))),y=()=>{var k,C;return al((k=r(this,vt))==null?void 0:k.clientIDs)||al((C=r(this,vt))==null?void 0:C.clientGroupIDs)},w=()=>{y()&&(An(h,["deleteClients",r(this,vt)]),d(this,vt,void 0))};if(m.size>0&&r(this,kn)!==void 0)w(),An(h,["changeDesiredQueries",{desiredQueriesPatch:[...m.values()]}]);else if(r(this,kn)===void 0){const k=r(this,Nr);An(h,["initConnection",{desiredQueriesPatch:[...m.values()],deleted:Dd(r(this,vt)),...r(this,Is)===null?{clientSchema:k}:{},userPushParams:r(this,Vt).push}]),d(this,vt,void 0)}d(this,kn,void 0),w(),p(this,N,Lc).call(this,to),r(this,Xe).resolve()},eb=async function(t,n){var m,y,w,g;b(r(this,bn)),b(r(this,ce)===qt);const s=Fw();t=_d(s,t),(m=t.info)==null||m.call(t,"Connecting...",{navigatorOnline:ge==null?void 0:ge.onLine}),p(this,N,Lc).call(this,uc),b(r(this,Ne)===void 0);const i=Date.now();if(d(this,Ne,i),r(this,St)===void 0&&d(this,St,i),this.closed||(d(this,Is,Ct(await r(this,U).cookie,tl)),this.closed))return;const o=setTimeout(()=>{var S;(S=t.debug)==null||S.call(t,"Rejecting connect resolver due to timeout"),r(this,Xe).reject(new Kp("Connect")),p(this,N,Qt).call(this,t,{client:"ConnectTimeout"})},wN),a=()=>{clearTimeout(o)};r(this,Ds).signal.addEventListener("abort",a);const[u,c,h]=await _N(r(this,U),r(this,wt),r(this,ks),kx(r(this,bn)),r(this,Is),this.clientID,await this.clientGroupID,r(this,Nr),this.userID,r(this,U).auth,r(this,Cs),s,r(this,Vt).logLevel==="debug",t,r(this,Vt).push,r(this,Vt).maxHeaderLength,n);if(!this.closed){d(this,kn,c),d(this,vt,h),u.addEventListener("message",r(this,Fu)),u.addEventListener("open",r(this,zu)),u.addEventListener("close",r(this,$u)),d(this,Q,u),r(this,Lu).resolve(u),(w=(y=ze("window"))==null?void 0:y.addEventListener)==null||w.call(y,"pagehide",r(this,Hu));try{(g=t.debug)==null||g.call(t,"Waiting for connection to be acknowledged"),await r(this,Xe).promise,r(this,zt).onConnected(r(this,Cs)),r(this,U).push().catch(()=>{})}finally{clearTimeout(o),r(this,Ds).signal.removeEventListener("abort",a)}}},Qt=function(t,n,s,i){var o,a,u,c,h,m,y,w,g,S,I;switch(r(this,ce)===uc&&Et(this,gt)._++,(o=t.info)==null||o.call(t,"disconnecting",{navigatorOnline:ge==null?void 0:ge.onLine,reason:n,connectStart:r(this,Ne),totalToConnectStart:r(this,St),connectedAt:r(this,In),connectionDuration:r(this,In)?Date.now()-r(this,In):0,messageCount:r(this,Pr),connectionState:r(this,ce),connectErrorCount:r(this,gt)}),r(this,ce)){case to:{r(this,Ne)!==void 0&&((a=t.error)==null||a.call(t,"disconnect() called while connected but connect start time is defined."));break}case uc:{r(this,Fe).lastConnectError.set(Vg(n)),r(this,Fe).timeToConnectMs.set($g),r(this,Fe).setConnectError(n),r(this,gt)%vN===1&&p(this,N,Fc).call(this,`connectErrorCount=${r(this,gt)}`),r(this,Ne)===void 0&&((u=t.error)==null||u.call(t,"disconnect() called while connecting but connect start time is undefined."));break}case qt:(c=t.error)==null||c.call(t,"disconnect() called while disconnected");break}d(this,Lu,$()),(h=t.debug)==null||h.call(t,"Creating new connect resolver"),d(this,Xe,$()),p(this,N,Lc).call(this,qt),d(this,Pr,0),d(this,Ne,void 0),d(this,In,0),(m=r(this,Q))==null||m.removeEventListener("message",r(this,Fu)),(y=r(this,Q))==null||y.removeEventListener("open",r(this,zu)),(w=r(this,Q))==null||w.removeEventListener("close",r(this,$u)),(g=r(this,Q))==null||g.close(s,i),d(this,Q,void 0),d(this,$t,hc),r(this,Sn).handleDisconnect(),(I=(S=ze("window"))==null?void 0:S.removeEventListener)==null||I.call(S,"pagehide",r(this,Hu))},tb=function(t,n){r(this,Cn).call(this),r(this,Sn).handlePokeStart(n[1])},nb=function(t,n){r(this,Cn).call(this);const s=r(this,Sn).handlePokePart(n[1]);s!==void 0&&d(this,Cs,s)},sb=function(t,n){r(this,Cn).call(this),r(this,Sn).handlePokeEnd(n[1])},ib=function(){var n;const t=r(this,q);(n=t.info)==null||n.call(t,"poke error, disconnecting?",r(this,ce)!==qt),r(this,ce)!==qt&&p(this,N,Qt).call(this,t,{client:"UnexpectedBaseCookie"})},rb=function(t,n){var o,a;r(this,Cn).call(this);const s=n[1];t=t.withContext("requestID",s.requestID),(o=t.debug)==null||o.call(t,"Handling pull response",s);const i=r(this,Ar).get(s.requestID);if(!i){(a=t.debug)==null||a.call(t,"No resolver found");return}i.resolve(n[1])},ob=async function(t,n){var c,h;b(t.pushVersion===1),await r(this,Xe).promise;const s=r(this,q).withContext("requestID",n);(c=s.debug)==null||c.call(s,`pushing ${t.mutations.length} mutations`);const i=r(this,Q);b(i);const o=t.clientGroupID!==await this.clientGroupID,a=o?0:t.mutations.findIndex(m=>m.clientID===r(this,$t).clientID&&m.id===r(this,$t).id)+1;(h=s.debug)==null||h.call(s,o?"pushing for recovery":"pushing",t.mutations.length-a,"mutations of",t.mutations.length,"mutations.");const u=Date.now();for(let m=a;m<t.mutations.length;m++){const y=t.mutations[m],w=u-Math.round(performance.now()-y.timestamp),g=y.name===nl?{type:gg,timestamp:w,id:y.id,clientID:y.clientID,name:y.name,args:[PE(y.args,r(this,Tu))]}:{type:bg,timestamp:w,id:y.id,clientID:y.clientID,name:y.name,args:[y.args]},S=["push",{timestamp:u,clientGroupID:t.clientGroupID,mutations:[g],pushVersion:t.pushVersion,requestID:n}];An(i,S),o||d(this,$t,{clientID:y.clientID,id:y.id})}return{httpRequestInfo:{errorMessage:"",httpStatusCode:200}}},Cd=async function(t,n){var o;const{auth:s}=r(this,Vt),i=await(typeof s=="function"?s(n):s);i&&((o=t.debug)==null||o.call(t,"Got auth token"),r(this,U).auth=i)},ab=async function(){var c,h,m,y,w,g,S,I,D;if((h=(c=r(this,q)).info)==null||h.call(c,`Starting Zero version: ${this.version}`),r(this,bn)===null){(y=(m=r(this,q)).info)==null||y.call(m,"No socket origin provided, not starting connect loop.");return}let t=0;const n=r(this,q),s=()=>{let k=n;return r(this,Q)&&(k=Zl(r(this,Q),k)),k.withContext("runLoopCounter",t)};await p(this,N,Cd).call(this,n);let i=!1,o=!1,a=Up,u;for(;!this.closed;){t++;let k=s();a=Up;try{switch(r(this,ce)){case qt:{if(r(this,_s).visibilityState==="hidden"&&(r(this,Fe).setDisconnectedWaitingForVisible(),d(this,St,void 0)),await r(this,_s).waitForVisible(),i&&await p(this,N,Cd).call(this,k,"invalid-token"),tN()||(await p(this,N,eb).call(this,k,u),u=void 0,this.closed))break;b(r(this,Q)),k=s(),(w=k.debug)==null||w.call(k,"Connected successfully"),o=!1,i=!1,p(this,N,Hc).call(this,!0);break}case uc:(g=k.error)==null||g.call(k,"unreachable"),o=!0;break;case to:{const C=new AbortController;d(this,Cn,()=>C.abort());const[M,_]=sC(fN,C.signal);d(this,bt,$());const x=0,O=2,T=await Wl([M,_,r(this,_s).waitForHidden(),r(this,Lr).promise,r(this,bt).promise]);if(this.closed){d(this,bt,void 0);break}switch(T){case x:{await p(this,N,cb).call(this,k,r(this,bt).promise)===zp&&(o=!0);break}case O:p(this,N,Qt).call(this,k,{client:"Hidden"}),p(this,N,Hc).call(this,!1);break}d(this,bt,void 0)}}}catch(C){if(r(this,ce)!==to){const _=Gp(C)?"warn":"error",x=ol(C)?C.kind:"Unknown Error";(S=k[_])==null||S.call(k,"Failed to connect",C,x,{lmid:r(this,Cs),baseCookie:r(this,Is)})}if((I=k.debug)==null||I.call(k,"Got an exception in the run loop","state:",r(this,ce),"exception:",C),Gp(C)){if(!i){i=!0;continue}i=!0}(ol(C)||C instanceof Kp||C instanceof qp)&&(o=!0);const M=iN(C);M&&(M.minBackoffMs!==void 0&&(a=Math.max(a,M.minBackoffMs)),M.maxBackoffMs!==void 0&&(a=Math.min(a,M.maxBackoffMs)),u=M.reconnectParams)}o&&(p(this,N,Hc).call(this,!1),(D=k.debug)==null||D.call(k,"Sleeping",a,"ms before reconnecting due to error, state:",r(this,ce)),await Mn(a))}},ub=async function(t,n){var c,h,m,y;b(t.pullVersion===1);const s=r(this,q).withContext("requestID",n);if((c=s.debug)==null||c.call(s,"Pull",t),t.clientGroupID===await this.clientGroupID)return{httpRequestInfo:{errorMessage:"",httpStatusCode:200}};await r(this,Xe).promise;const i=r(this,Q);b(i),(h=s.debug)==null||h.call(s,"Pull is for mutation recovery");const o=Ct(t.cookie,tl),a=["pull",{clientGroupID:t.clientGroupID,cookie:o,requestID:n}];An(i,a);const u=$();r(this,Ar).set(n,u);try{switch(await Wl([Mn(mN),u.promise])){case 0:throw(m=s.debug)==null||m.call(s,"Mutation recovery pull timed out"),new Error("Pull timed out");case 1:{(y=s.debug)==null||y.call(s,"Returning mutation recovery pull response");const I=await u.promise;return{response:{cookie:I.cookie,lastMutationIDChanges:I.lastMutationIDChanges,patch:[]},httpRequestInfo:{errorMessage:"",httpStatusCode:200}}}default:we()}}finally{u.reject("timed out"),r(this,Ar).delete(n)}},Hc=function(t){var n;r(this,Rr)!==t&&(d(this,Rr,t),(n=r(this,Pu))==null||n.call(this,t))},cb=async function(t,n){var h,m,y;(h=t.debug)==null||h.call(t,"pinging");const{promise:s,resolve:i}=$();d(this,Ou,i);const o=["ping",{}],a=performance.now();b(r(this,Q)),An(r(this,Q),o);const u=await Wl([s,Mn(pN),n])===0,c=performance.now()-a;return u?((y=t.debug)==null||y.call(t,"ping succeeded in",c,"ms"),Jx):((m=t.info)==null||m.call(t,"ping failed in",c,"ms - disconnecting"),p(this,N,Qt).call(this,t,{client:"PingTimeout"}),zp)},lb=async function(t){},Fc=function(t){p(this,N,hb).call(this,t)},hb=function(t){},db=function(t){const n={},s=r(this,Dn);for(const i of Object.keys(t.tables))n[i]=hf(s,t,i);return n},Ts);async function _N(e,t,n,s,i,o,a,u,c,h,m,y,w,g,S,I=1024*8,D){var L,P,X;const k=new URL(Hg(s,`/sync/v${vf}/connect`)),{searchParams:C}=k;if(C.set("clientID",o),C.set("clientGroupID",a),C.set("userID",c),C.set("baseCookie",i===null?"":String(i)),C.set("ts",String(performance.now())),C.set("lmid",String(m)),C.set("wsid",y),w&&C.set("debugPerf","true"),D)for(const Y in D)C.has(Y)?(L=g.warn)==null||L.call(g,`skipping conflicting parameter ${Y}`):C.set(Y,D[Y]);(P=g.info)==null||P.call(g,"Connecting to",k.toString());const M=df("WebSocket"),_=e.query(Y=>t.getQueriesPatch(Y));let x=await n.getDeletedClients(),O=await _,T=Ep(["initConnection",{desiredQueriesPatch:[...O.values()],deleted:Dd(x),...i===null?{clientSchema:u}:{},userPushParams:S}],h);return T.length>I?(T=Ep(void 0,h),T.length>I&&((X=g.warn)==null||X.call(g,`Encoded auth token length (${T.length}) exceeds ZeroOptions.maxHeaderLength (${I}). This may cause connection failures.`)),O=void 0):x=void 0,[new M(k.toString(),T),O,Dd(x)]}function al(e){return e&&e.length>0?e:void 0}function Dd(e){if(!e)return;const{clientIDs:t,clientGroupIDs:n}=e;if((!t||t.length===0)&&(!n||n.length===0))return;const s={};return s.clientIDs=al(t),s.clientGroupIDs=al(n),s}function Zl({url:e},t){const n=new URL(e).searchParams.get("wsid")??Fw();return _d(n,t)}function _d(e,t){return t.withContext("wsid",e)}function Wl(e){return Promise.race(e.map((t,n)=>t.then(()=>n)))}var Kp=class extends Error{constructor(e){super(`${e} timed out`)}},qp=class extends Error{};function EN(e){}var xN=f.array(f.object({id:f.string(),name:f.string(),args:f.array(Kt)})),NN=f.object({id:f.string(),name:f.string(),ast:Yu}),MN=f.object({error:f.literal("app"),id:f.string(),name:f.string(),details:Kt}),RN=f.array(f.union(NN,MN));f.tuple([f.literal("transform"),xN]);f.tuple([f.literal("transformed"),RN]);var TN=class fb extends ov{constructor(t,n,s,i,o="permissions",a,u){super(void 0,t,n,s,i,o,a,u)}expressionBuilder(){return new Xw(this._exists)}[ve](t,n,s,i,o,a,u){return new fb(n,s,i,o,"permissions",a,u)}get ast(){return this._completeAst()}materialize(){throw new Error("StaticQuery cannot be materialized")}run(){return Promise.reject(new Error("StaticQuery cannot be run"))}preload(){throw new Error("StaticQuery cannot be preloaded")}},F=[(e,t)=>t.and()];async function ON(e,t){const n={};for(const i of Object.keys(e.tables))n[i]=new TN(e,i,{table:i},Eo).expressionBuilder();const s=await t();return PN(e,s,n)}function PN(e,t,n){if(!t)return;const s=gf(e.tables),i={tables:{}};for(const[o,a]of Object.entries(t)){const u=e.tables[o].serverName??o;i.tables[u]={row:AN(s,o,a.row,n[o]),cell:LN(s,o,a.cell,n[o])}}return i}function AN(e,t,n,s){var i,o;if(n)return{select:kt(e,t,n.select,s),insert:kt(e,t,n.insert,s),update:{preMutation:kt(e,t,(i=n.update)==null?void 0:i.preMutation,s),postMutation:kt(e,t,(o=n.update)==null?void 0:o.postMutation,s)},delete:kt(e,t,n.delete,s)}}function kt(e,t,n,s){if(n)return n.map(i=>{const o=i(FN,s);return["allow",Nk(o,t,e)]})}function LN(e,t,n,s){var o,a;if(!n)return;const i={};for(const[u,c]of Object.entries(n))i[u]={select:kt(e,t,c.select,s),insert:kt(e,t,c.insert,s),update:{preMutation:kt(e,t,(o=c.update)==null?void 0:o.preMutation,s),postMutation:kt(e,t,(a=c.update)==null?void 0:a.postMutation,s)},delete:kt(e,t,c.delete,s)};return i}var Fr,Vu,zr,HN=(zr=class{constructor(t,n){l(this,Fr);l(this,Vu);d(this,Fr,t),d(this,Vu,n)}get(t,n){if(n===xn)return t[xn];b(typeof n=="string");const s=[...r(this,Vu),n];return new Proxy({[xn]:()=>SI(r(this,Fr),s)},new zr(r(this,Fr),s))}},Fr=new WeakMap,Vu=new WeakMap,zr);function pb(e){return new Proxy({[xn]:()=>{throw new Error("no JWT field specified")}},new HN(e,[]))}var FN=pb("authData");pb("preMutationRow");function zN(e){return $N(e)}function $N(e){return new Proxy({},{get:(t,n)=>{if(n in t)return t[n];if(!(n in e.tables))throw new Error(`Table ${n} does not exist in schema`);const s=hf(void 0,e,n);return t[n]=s,s}})}var _n,sy,VN=(sy=class{constructor(){l(this,_n,new WeakMap)}inc(e){const t=r(this,_n).get(e)??0;return r(this,_n).set(e,t+1),t===0}dec(e){const t=H(r(this,_n).get(e));return t===1?r(this,_n).delete(e):(r(this,_n).set(e,t-1),!1)}},_n=new WeakMap,sy),Qp={type:"complete"},jN={type:"unknown"},ju,$r,Gu,Vr,Es,jt,jr,Bu,vl,Te,mb,Ed,xd,zc,iy,GN=(iy=class{constructor(e,t,n,s,i,o){l(this,Te);l(this,ju);l(this,$r);l(this,Gu);l(this,Vr);l(this,Es);l(this,jt);l(this,jr,[]);l(this,Bu);l(this,vl,()=>{const e=r(this,jt);if(e)eh(e)||(r(this,Es).call(this,t=>[e,t[1]]),d(this,jt,void 0));else try{p(this,Te,mb).call(this,r(this,jr),t=>t)}finally{d(this,jr,[])}});d(this,ju,e),t(r(this,vl)),d(this,$r,n),d(this,Gu,s),d(this,Bu,o),e.setOutput(this);const a=p(this,Te,zc).call(this);p(this,Te,Ed).call(this,e.fetch({}),u=>({type:"add",node:u}),a),[Et(this,Vr)._,Et(this,Es)._]=Cb([a,i===!0?Qp:jN]),eh(a)&&d(this,jt,p(this,Te,zc).call(this)),i!==!0&&i.then(()=>{r(this,Es).call(this,u=>[u[0],Qp])})}get data(){return r(this,Vr)[0][""]}get resultDetails(){return r(this,Vr)[1]}destroy(){r(this,Gu).call(this)}push(e){r(this,jt)?p(this,Te,xd).call(this,e,r(this,jt)):r(this,jr).push(yb(e))}updateTTL(e){r(this,Bu).call(this,e)}},ju=new WeakMap,$r=new WeakMap,Gu=new WeakMap,Vr=new WeakMap,Es=new WeakMap,jt=new WeakMap,jr=new WeakMap,Bu=new WeakMap,vl=new WeakMap,Te=new WeakSet,mb=function(e,t){r(this,Es).call(this,Db(n=>{p(this,Te,Ed).call(this,e,t,n[0]),eh(n[0])&&d(this,jt,p(this,Te,zc).call(this))}))},Ed=function(e,t,n){for(const s of e)p(this,Te,xd).call(this,t(s),n)},xd=function(e,t){zn(t,e,r(this,ju).getSchema(),"",r(this,$r))},zc=function(){return{"":r(this,$r).singular?void 0:[]}},iy);function yb(e){switch(e.type){case"add":return{type:"add",node:Nd(e.node)};case"remove":return{type:"remove",node:Nd(e.node)};case"child":return{type:"child",node:{row:e.node.row},child:{relationshipName:e.child.relationshipName,change:yb(e.child.change)}};case"edit":return{type:"edit",node:{row:e.node.row},oldNode:{row:e.oldNode.row}}}}function Nd(e){const t={};for(const n in e.relationships){const s=[];for(const i of e.relationships[n]())s.push(Nd(i));t[n]=()=>s}return{row:e.row,relationships:t}}function eh(e){const t=e[""];return t===void 0||Array.isArray(t)&&t.length===0}function BN(e,t,n,s,i,o,a){return new GN(t,i,n,s,o,a)}function aM(e,t){const n=mo(()=>{var a;const s=e(),i=((a=qN(t))==null?void 0:a.ttl)??so,o=UN(s,i);return Ib(()=>queueMicrotask(()=>KN(s,o))),o});return[()=>n().data,()=>n().resultDetails]}var Md=new WeakMap,wb=new VN;function UN(e,t){let n=Md.get(e);return n?n.updateTTL(t):(n=e.materialize(BN,t),Md.set(e,n)),wb.inc(n),n}function KN(e,t){wb.dec(t)&&(Md.delete(e),t.destroy())}function qN(e){return typeof e=="function"?e():e}function QN(e){const t={...e,batchViewUpdates:_b};return new DN(t)}const Jp=e=>typeof e=="boolean"?`${e}`:e===0?"0":e,JN=e=>{const t=function(){for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];return Pb(o)};return{compose:function(){for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];return u=>{const c=Object.fromEntries(Object.entries(u||{}).filter(h=>{let[m]=h;return!["class","className"].includes(m)}));return t(o.map(h=>h(c)),u==null?void 0:u.class,u==null?void 0:u.className)}},cva:i=>o=>{var a;if((i==null?void 0:i.variants)==null)return t(i==null?void 0:i.base,o==null?void 0:o.class,o==null?void 0:o.className);const{variants:u,defaultVariants:c}=i,h=Object.keys(u).map(w=>{const g=o==null?void 0:o[w],S=c==null?void 0:c[w],I=Jp(g)||Jp(S);return u[w][I]}),m={...c,...o&&Object.entries(o).reduce((w,g)=>{let[S,I]=g;return typeof I>"u"?w:{...w,[S]:I}},{})},y=i==null||(a=i.compoundVariants)===null||a===void 0?void 0:a.reduce((w,g)=>{let{class:S,className:I,...D}=g;return Object.entries(D).every(k=>{let[C,M]=k;const _=m[C];return Array.isArray(M)?M.includes(_):_===M})?[...w,S,I]:w},[]);return t(i==null?void 0:i.base,h,y,o==null?void 0:o.class,o==null?void 0:o.className)},cx:t}},{cva:XN}=JN(),YN=XN({base:"inline-flex items-center justify-center whitespace-nowrap text-sm font-medium disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] cursor-pointer rounded-lg active:scale-95 transition-all duration-200 [&_svg:not([class*='size-'])]:size-4 select-none",variants:{variant:{default:"bg-primary text-primary-foreground shadow hover:bg-primary/90",secondary:"bg-secondary text-secondary-foreground shadow hover:bg-secondary/80 ",destructive:"bg-destructive text-destructive-foreground shadow hover:bg-destructive/90",outline:"border border-input hover:bg-accent hover:text-accent-foreground",ghost:"hover:bg-accent hover:text-accent-foreground",link:"text-primary underline-offset-4 hover:underline"},size:{default:"gap-2 h-9 px-4 py-2 has-[>svg]:px-3",sm:"gap-1.5 h-8 px-3 text-sm has-[>svg]:px-2.5",lg:"gap-2 h-10 px-6 text-lg has-[>svg]:px-4",icon:"size-9"}},defaultVariants:{variant:"default",size:"default"}}),uM=e=>{const[t,n]=ry(e,["variant","size","class"]);return Td(Od,oy({get class(){return Ab(YN({variant:t.variant,size:t.size}),t.class)}},n))},Sf={tables:{comment:{name:"comment",columns:{id:{type:"string",optional:!1,customType:null},feedbackId:{type:"string",optional:!1,customType:null,serverName:"feedback_id"},userId:{type:"string",optional:!1,customType:null,serverName:"user_id"},message:{type:"string",optional:!1,customType:null},createdAt:{type:"number",optional:!0,customType:null,serverName:"created_at"},updatedAt:{type:"number",optional:!0,customType:null,serverName:"updated_at"}},primaryKey:["id"]},feedback:{name:"feedback",columns:{id:{type:"string",optional:!1,customType:null},userId:{type:"string",optional:!0,customType:null,serverName:"user_id"},workspaceId:{type:"string",optional:!1,customType:null,serverName:"workspace_id"},title:{type:"string",optional:!1,customType:null},message:{type:"string",optional:!1,customType:null},type:{type:"string",optional:!1,customType:null},tags:{type:"json",optional:!0,customType:null},likesCount:{type:"number",optional:!0,customType:null,serverName:"likes_count"},commentsCount:{type:"number",optional:!0,customType:null,serverName:"comments_count"},status:{type:"string",optional:!0,customType:null},createdAt:{type:"number",optional:!0,customType:null,serverName:"created_at"},updatedAt:{type:"number",optional:!0,customType:null,serverName:"updated_at"}},primaryKey:["id"]},like:{name:"like",columns:{id:{type:"string",optional:!1,customType:null},feedbackId:{type:"string",optional:!1,customType:null,serverName:"feedback_id"},userId:{type:"string",optional:!1,customType:null,serverName:"user_id"},createdAt:{type:"number",optional:!0,customType:null,serverName:"created_at"},updatedAt:{type:"number",optional:!0,customType:null,serverName:"updated_at"}},primaryKey:["id"]},member:{name:"member",columns:{id:{type:"string",optional:!1,customType:null},organizationId:{type:"string",optional:!1,customType:null,serverName:"organization_id"},userId:{type:"string",optional:!1,customType:null,serverName:"user_id"},role:{type:"string",optional:!0,customType:null},teamId:{type:"string",optional:!0,customType:null,serverName:"team_id"},createdAt:{type:"number",optional:!1,customType:null,serverName:"created_at"}},primaryKey:["id"]},organization:{name:"organization",columns:{id:{type:"string",optional:!1,customType:null},name:{type:"string",optional:!1,customType:null},slug:{type:"string",optional:!0,customType:null},logo:{type:"string",optional:!0,customType:null},createdAt:{type:"number",optional:!1,customType:null,serverName:"created_at"},metadata:{type:"string",optional:!0,customType:null}},primaryKey:["id"]},team:{name:"team",columns:{id:{type:"string",optional:!1,customType:null},name:{type:"string",optional:!1,customType:null},organizationId:{type:"string",optional:!1,customType:null,serverName:"organization_id"},createdAt:{type:"number",optional:!1,customType:null,serverName:"created_at"},updatedAt:{type:"number",optional:!0,customType:null,serverName:"updated_at"}},primaryKey:["id"]},user:{name:"user",columns:{id:{type:"string",optional:!1,customType:null},name:{type:"string",optional:!1,customType:null},email:{type:"string",optional:!1,customType:null},emailVerified:{type:"boolean",optional:!1,customType:null,serverName:"email_verified"},image:{type:"string",optional:!0,customType:null},createdAt:{type:"number",optional:!1,customType:null,serverName:"created_at"},updatedAt:{type:"number",optional:!1,customType:null,serverName:"updated_at"}},primaryKey:["id"]},workspace:{name:"workspace",columns:{id:{type:"string",optional:!1,customType:null},organizationId:{type:"string",optional:!1,customType:null,serverName:"organization_id"},name:{type:"string",optional:!1,customType:null},domain:{type:"string",optional:!1,customType:null},workspaceUrl:{type:"string",optional:!1,customType:null,serverName:"workspace_url"},logo:{type:"string",optional:!0,customType:null},createdAt:{type:"number",optional:!0,customType:null,serverName:"created_at"},updatedAt:{type:"number",optional:!0,customType:null,serverName:"updated_at"}},primaryKey:["id"]}},relationships:{workspace:{member:[{sourceField:["organizationId"],destField:["id"],destSchema:"organization",cardinality:"many"},{sourceField:["id"],destField:["organizationId"],destSchema:"member",cardinality:"many"}],organization:[{sourceField:["organizationId"],destField:["id"],destSchema:"organization",cardinality:"one"}],feedback:[{sourceField:["id"],destField:["workspaceId"],destSchema:"feedback",cardinality:"many"}]},member:{user:[{sourceField:["id"],destField:["id"],destSchema:"member",cardinality:"many"},{sourceField:["userId"],destField:["id"],destSchema:"user",cardinality:"many"}],organization:[{sourceField:["organizationId"],destField:["id"],destSchema:"organization",cardinality:"one"}]},comment:{feedback:[{sourceField:["feedbackId"],destField:["id"],destSchema:"feedback",cardinality:"one"}],user:[{sourceField:["userId"],destField:["id"],destSchema:"user",cardinality:"one"}]},feedback:{user:[{sourceField:["userId"],destField:["id"],destSchema:"user",cardinality:"one"}],workspace:[{sourceField:["workspaceId"],destField:["id"],destSchema:"workspace",cardinality:"one"}],comments:[{sourceField:["id"],destField:["feedbackId"],destSchema:"comment",cardinality:"many"}],likes:[{sourceField:["id"],destField:["feedbackId"],destSchema:"like",cardinality:"many"}]},like:{feedback:[{sourceField:["feedbackId"],destField:["id"],destSchema:"feedback",cardinality:"one"}]},organization:{members:[{sourceField:["id"],destField:["organizationId"],destSchema:"member",cardinality:"many"}],workspaces:[{sourceField:["id"],destField:["organizationId"],destSchema:"workspace",cardinality:"many"}]}}};zN(Sf);ON(Sf,()=>({user:{row:{select:F}},organization:{row:{insert:F,select:F,update:{preMutation:F,postMutation:F},delete:F}},member:{row:{select:F,insert:F,update:{preMutation:F,postMutation:F},delete:F}},comment:{row:{select:F,insert:F,update:{preMutation:F,postMutation:F},delete:F}},workspace:{row:{select:F,insert:F,update:{preMutation:F,postMutation:F},delete:F}},feedback:{row:{select:F,insert:F,update:{preMutation:F,postMutation:F},delete:F}},like:{row:{select:F,insert:F,update:{preMutation:F,postMutation:F},delete:F}},team:{row:{select:F,insert:F,update:{preMutation:F,postMutation:F},delete:F}}}));let ZN=e=>crypto.getRandomValues(new Uint8Array(e)),WN=(e,t,n)=>{let s=(2<<Math.log2(e.length-1))-1,i=-~(1.6*s*t/e.length);return(o=t)=>{let a="";for(;;){let u=n(i),c=i|0;for(;c--;)if(a+=e[u[c]&s]||"",a.length>=o)return a}}},dc=(e,t=21)=>WN(e,t|0,ZN);function eM({authData:e}){return{workspace:{create:async(t,n)=>{if(!e)throw new Error("Not authenticated");const s=dc("abcdefghijklmnopqrstuvwxyz0123456789",21)();try{await t.mutate.workspace.insert({id:s,name:n.name,domain:n.domain,organizationId:"MR7wSx5lyqDCeMc96f1ovf0ZUw62cEL1",workspaceUrl:n.workspaceUrl,logo:n.logo,createdAt:Date.now(),updatedAt:Date.now()})}catch(i){throw console.error("error adding workspace",i),i}}},feedback:{create:async(t,n)=>{if(!e)throw new Error("Not authenticated");const s=dc("abcdefghijklmnopqrstuvwxyz0123456789",21)();try{await t.mutate.feedback.insert({id:s,workspaceId:n.workspaceId,userId:e,title:n.title,message:n.message,status:n.status,type:n.type,tags:n.tags})}catch(i){throw console.error("error adding feedback",i),i}}},like:{add:async(t,n)=>{if(!e)throw new Error("Not authenticated");const s=dc("abcdefghijklmnopqrstuvwxyz0123456789",21)();if(await t.query.like.where("feedbackId","=",n).where("userId","=",e).one())throw new Error("Like already exists");await t.mutate.like.insert({id:s,feedbackId:n,userId:e})},remove:async(t,{likeId:n})=>{if(!e)throw new Error("Not authenticated");await t.mutate.like.delete({id:n})}},comment:{add:async(t,{feedbackId:n,message:s})=>{if(!e)throw new Error("Not authenticated");const i=dc("abcdefghijklmnopqrstuvwxyz0123456789",21)();await t.mutate.comment.insert({id:i,feedbackId:n,userId:e,message:s})}}}}const vb=xb();function cM(e){const t=Nb({from:"/_layout"});console.log(t());const n=mo(()=>QN({userID:t().user.id,auth:async s=>t().jwt,server:"http://localhost:4848",schema:Sf,mutators:eM({authData:t().user.id}),logLevel:"info"}));return Td(vb.Provider,{value:n,get children(){return e.children}})}function lM(){return Eb(vb)}export{Od as B,Tn as E,Ie as L,eo as S,cM as Z,uM as a,aM as b,XN as c,rM as d,we as e,b as f,Zd as g,_l as h,Tk as i,Fs as j,H as m,Fw as n,E0 as r,Sl as t,lM as u,pe as w};

var J=Object.defineProperty;var E=t=>{throw TypeError(t)};var F=(t,e,i)=>e in t?J(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i;var u=(t,e,i)=>F(t,typeof e!="symbol"?e+"":e,i),G=(t,e,i)=>e.has(t)||E("Cannot "+i);var a=(t,e,i)=>(G(t,e,"read from private field"),i?i.call(t):e.get(t)),l=(t,e,i)=>e.has(t)?E("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(t):e.set(t,i),h=(t,e,i,s)=>(G(t,e,"write to private field"),s?s.call(t,i):e.set(t,i),i);import{w as X,n as H,d as K,t as M,e as T,m as U,S as I,i as _,E as V,g as Y,f as Q,h as Z,r as tt,L as et,j as it}from"./zero-app-CdYV702a.js";import"./main-Dn08EaJy.js";import"./cn-BW4RVDli.js";function m(t){var i;let e="";if(t.where&&(e+=C(t.where,".where",new Set)),t.related&&t.related.length>0)for(const s of t.related)if(s.hidden){const n=(i=s.subquery.related)==null?void 0:i[0];n&&(e+=A(n))}else e+=A(s);if(t.orderBy&&t.orderBy.length>0&&(e+=at(t.orderBy)),t.limit!==void 0&&(e+=`.limit(${t.limit})`),t.start){const{row:s,exclusive:n}=t.start;e+=`.start(${JSON.stringify(s)}${n?"":", { inclusive: true }"})`}return e}function C(t,e,i){switch(t.type){case"simple":return st(t,e);case"and":case"or":return nt(t,e,i);case"correlatedSubquery":return rt(t,e,i);default:T()}}function st(t,e){const{left:i,op:s,right:n}=t,o=B(i),r=B(n);return s==="="?`${e}(${o}, ${r})`:`${e}(${o}, '${s}', ${r})`}function nt(t,e,i){const{type:s,conditions:n}=t;if(n.length===1)return C(n[0],e,i);if(s==="and"){const c=n.map(b=>C(b,e,i));return e===".where"?c.join(""):(i.add("and"),"and("+c.join(", ")+")")}i=new Set;const o=n.map(c=>C(c,"cmp",i)).join(", ");return i.add("cmp"),i.add(s),`.where(({${[...i].sort().join(", ")}}) => ${s}(${o}))`}function rt(t,e,i){const{related:s,op:n}=t,o=ot(s),r=j(s),c=r.where||r.related&&r.related.length>0||r.orderBy||r.limit;return n==="EXISTS"?c?e===".where"?`.whereExists('${o}', q => q${m(r)})`:(i.add("exists"),`exists('${o}', q => q${m(r)})`):e===".where"?`.whereExists('${o}')`:(i.add("exists"),`exists('${o}')`):c?e===".where"?`.where(({exists, not}) => not(exists('${o}', q => q${m(r)})))`:(i.add("not"),i.add("exists"),`not(exists('${o}', q => q${m(r)}))`):e===".where"?`.where(({exists, not}) => not(exists('${o}')))`:(i.add("not"),i.add("exists"),`not(exists('${o}')))`)}function j(t){var e,i;return((e=t.subquery.where)==null?void 0:e.type)==="correlatedSubquery"&&((i=t.subquery.where.related.subquery.alias)!=null&&i.includes(I+"zhidden_"))?j(t.subquery.where.related):t.subquery}function ot(t){const e=U(t.subquery.alias);return e.startsWith(I)?e.substring(I.length):e}function A(t){const{alias:e}=t.subquery;if(!e)return"";let s=`.related('${e}'`;return(t.subquery.where||t.subquery.related&&t.subquery.related.length>0||t.subquery.orderBy||t.subquery.limit)&&(s+=", q => q"+m(t.subquery)),s+=")",s}function at(t){let e="";for(const[i,s]of t)e+=`.orderBy('${i}', '${s}')`;return e}function B(t){switch(t.type){case"literal":return ut(t);case"column":return`'${t.name}'`;case"static":return ct(t);default:T()}}function ut(t){return t.value===null?"null":Array.isArray(t.value)?JSON.stringify(t.value):typeof t.value=="string"?`'${t.value.replace(/'/g,"\\'")}'`:String(t.value)}function ct(t){return`authParam(${Array.isArray(t.field)?`[${t.field.map(i=>`'${i}'`).join(", ")}]`:`'${t.field}'`})`}async function mt(t,e,i){const s=await t.clientGroupID;return new lt(t,e,t.clientID,s,i)}var d,p,P,lt=(P=class{constructor(t,e,i,s,n){l(this,d);u(this,"client");u(this,"clientGroup");l(this,p);u(this,"socket");h(this,d,t),h(this,p,e),this.client=new W(t,e,n,i,s),this.clientGroup=this.client.clientGroup,this.socket=n}clients(){return $(a(this,d),t=>x(a(this,d),this.socket,a(this,p),t))}clientsWithQueries(){return $(a(this,d),t=>O(a(this,d),this.socket,a(this,p),t))}},d=new WeakMap,p=new WeakMap,P);function k(t,e,i){return new Promise((s,n)=>{const o=H(),r=c=>{const b=JSON.parse(c.data);if(b[0]==="inspect"){const D=b[1];if(D.id!==o)return;const g=M(D,i);g.ok?s(g.value.value):n(g.error),t.removeEventListener("message",r)}};t.addEventListener("message",r),t.send(JSON.stringify(["inspect",{...e,id:o}]))})}var q,v,S,N,W=(N=class{constructor(t,e,i,s,n){l(this,q);u(this,"id");u(this,"clientGroup");l(this,v);l(this,S);h(this,q,t),h(this,v,e),h(this,S,i),this.id=s,this.clientGroup=new ht(t,i,e,n)}async queries(){return(await k(await a(this,S).call(this),{op:"queries",clientID:this.id},_)).map(e=>new z(e,a(this,v)))}map(){return $(a(this,q),async t=>{const e=await L(t,this.id),i=new Map;for await(const[s,n]of e.scan(""))i.set(s,n);return i})}rows(t){return $(a(this,q),async e=>{const i=V+t,s=await L(e,this.id),n=[];for await(const[o,r]of s.scan(i)){if(!o.startsWith(i))break;n.push(r)}return n})}},q=new WeakMap,v=new WeakMap,S=new WeakMap,N),f,w,y,R,ht=(R=class{constructor(t,e,i,s){l(this,f);u(this,"id");l(this,w);l(this,y);h(this,f,t),h(this,y,e),h(this,w,i),this.id=s}clients(){return $(a(this,f),t=>x(a(this,f),a(this,y),a(this,w),t,([e,i])=>i.clientGroupID===this.id))}clientsWithQueries(){return $(a(this,f),t=>O(a(this,f),a(this,y),a(this,w),t,([e,i])=>i.clientGroupID===this.id))}async queries(){return(await k(await a(this,y).call(this),{op:"queries"},_)).map(e=>new z(e,a(this,w)))}},f=new WeakMap,w=new WeakMap,y=new WeakMap,R);async function $(t,e){return await t.refresh(),await t.persist(),X(t.perdag,e)}async function L(t,e){const i=await Y(e,t);Q(i,`Client not found: ${e}`);const{clientGroupID:s}=i,n=await Z(s,t);return Q(n,`Client group not found: ${s}`),(await tt(n.headHash,t,et)).map}async function x(t,e,i,s,n=()=>!0){return[...(await it(s)).entries()].filter(n).map(([r,{clientGroupID:c}])=>new W(t,i,e,r,c))}async function O(t,e,i,s,n=()=>!0){const o=await x(t,e,i,s,n),r=[];return await Promise.all(o.map(async c=>{(await c.queries()).length>0&&r.push(c)})),r}var z=class{constructor(t,e){u(this,"ast");u(this,"got");u(this,"ttl");u(this,"inactivatedAt");u(this,"rowCount");u(this,"deleted");u(this,"id");u(this,"zql");u(this,"clientID");this.clientID=t.clientID,this.id=t.queryID,this.inactivatedAt=t.inactivatedAt===null?null:new Date(t.inactivatedAt),this.ttl=K(t.ttl),this.ast=t.ast,this.got=t.got,this.rowCount=t.rowCount,this.deleted=t.deleted,this.zql=this.ast.table+m(this.ast)}};export{mt as newInspector};
